<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí°í†µë…-01ì¼ì°¨</title>
    <link rel="apple-touch-icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
    <meta name="apple-mobile-web-app-title" content="í†µí°í†µë…">
    <link rel="shortcut icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
    <link rel="mask-icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* ê²€ìƒ‰ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .search-highlight {
            background-color: #fde047;
            color: #1f2937;
            border-radius: 4px;
            padding: 2px 4px;
        }

        /* ìŠ¤í¬ë¡¤ ë§ˆì»¤ ì»¨í…Œì´ë„ˆ */
        .scroll-marker-container {
            position: fixed;
            top: 0;
            right: 0;
            width: 8px;
            height: 100vh;
            z-index: 99;
            pointer-events: none;
        }

        /* ìŠ¤í¬ë¡¤ ë§ˆì»¤ */
        .scroll-marker {
            position: absolute;
            right: 0;
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.7);
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.2s ease;
        }

        .scroll-marker:hover {
            transform: scale(1.5);
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* êµ¬ì ˆ ì„¤ëª… ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜ */
        .explanation-button-wrapper {
            transition: all 0.3s ease-in-out;
        }

        .explanation-sub-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.8);
            transition: all 0.3s ease-in-out;
        }

        .explanation-icon-button {
            opacity: 1;
            visibility: visible;
            transition: all 0.3s ease-in-out;
        }

        /* 'show' í´ë˜ìŠ¤ê°€ ìˆì„ ë•Œì˜ ìŠ¤íƒ€ì¼ */
        .explanation-button-wrapper.show .explanation-sub-buttons {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .explanation-button-wrapper.show .explanation-icon-button {
            opacity: 0;
            visibility: hidden;
            pointer-events: none; /* í•˜ìœ„ ë²„íŠ¼ í´ë¦­ì„ ë°©í•´í•˜ì§€ ì•Šë„ë¡ í•¨ */
        }

        /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s ease;
        }
        .modal-leave-active {
            transition: all 0.3s ease;
        }
        .modal-leave-to {
            opacity: 0;
            transform: scale(0.95);
        }
        
        /* ëª¨ë‹¬ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .modal-image-container {
            position: relative;
            width: 100%;
            padding-bottom: 75%; /* 4:3 ë¹„ìœ¨ ìœ ì§€ */
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-lg */
            margin-bottom: 1rem; /* mb-4 */
        }

        .modal-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* ì´ë¯¸ì§€ê°€ ì˜ë¦¬ì§€ ì•Šê³  ì „ì²´ ë³´ì´ë„ë¡ ìˆ˜ì • */
            object-position: center;
        }

        /* ëª¨ë‹¬ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .modal-text-container {
            max-height: 80vh;
            overflow-y: auto;
            padding-bottom: 1rem;
        }

        .modal-title {
            font-weight: bold;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            background-color: white;
            padding-bottom: 0.5rem;
            z-index: 10;
        }
        
        /* ìƒˆë¡œìš´ CSS: ì¤„ ê°„ê²©ì„ ê¸€ì ë†’ì´ì™€ ë¹„ìŠ·í•˜ê²Œ ì¢ê²Œ ë§Œë“­ë‹ˆë‹¤. */
        .leading-extra-tight {
            line-height: 1.1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- ìƒë‹¨ ê³ ì • í—¤ë” -->
    <div class="fixed top-0 left-0 w-full bg-white bg-opacity-95 backdrop-blur-sm shadow-md p-4 z-50">
        <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
            <!-- ê²€ìƒ‰ í¼ -->
            <div class="w-full md:w-1/3">
                <form id="search-form" class="flex items-center space-x-2 w-full">
                    <button type="button" id="reset-btn" class="p-2 bg-gray-200 rounded-full text-sm font-bold w-8 h-8 flex items-center justify-center">X</button>
                    <input type="text" id="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="flex-grow p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">ê²€ìƒ‰</button>
                </form>
                <div id="search-count-container" class="flex items-center mt-2 pl-12 text-sm text-gray-600">
                    <span id="search-count" class="font-semibold"></span>
                    <button type="button" id="next-location-btn" class="ml-2 px-3 py-1 bg-gray-200 text-gray-800 rounded-md text-xs font-medium hover:bg-gray-300 transition-colors hidden">ë‹¤ìŒ ìœ„ì¹˜</button>
                </div>
            </div>

            <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
            <div class="w-full md:w-2/3 flex flex-col items-center justify-center">
                <audio id="audio-file" preload="auto">
                    <source src="https://vod47.anyline.co.kr/vod_ezra/%EC%9D%BD%EA%B8%B0%2001.mp3" type="audio/mp3">
                </audio>
                <div class="player-controls flex items-center justify-center gap-2 mb-2">
                    <span id="current-time" class="text-sm font-mono text-gray-500">0:00</span>
                    <button id="play-btn" class="p-2 bg-green-200 rounded-full hover:bg-green-300 transition-colors shadow-md">â–¶</button>
                    <button id="pause-btn" class="p-2 bg-yellow-200 rounded-full hover:bg-yellow-300 transition-colors shadow-md">â¸</button>
                    <button id="stop-btn" class="p-2 bg-red-200 rounded-full hover:bg-red-300 transition-colors shadow-md">â– </button>
                    <span id="remaining-time" class="text-sm font-mono text-gray-500">0:00</span>
                </div>
                <div class="speed-volume-controls flex items-center justify-center gap-4">
                    <div class="speed-controls flex items-center gap-1">
                        <button id="speed-down-02" class="px-2 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">&lt;&lt;</button>
                        <button id="speed-down-01" class="px-2 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">&lt;</button>
                        <span id="speed-display" class="text-blue-600 font-bold text-sm w-12 text-center">1.0x</span>
                        <button id="speed-up-01" class="px-2 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">&gt;</button>
                        <button id="speed-up-02" class="px-2 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">&gt;&gt;</button>
                    </div>
                    <div class="volume-control flex items-center gap-1">
                        <span class="text-xs text-gray-500">ë³¼ë¥¨</span>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" class="w-24">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë³¸ë¬¸ ë‚´ìš© ì»¨í…Œì´ë„ˆ -->
    <div class="relative max-w-3xl mx-auto px-4 mt-[250px] pb-32">
        <!-- êµ¬ì ˆ ì„¤ëª… ë²„íŠ¼ ì»¨í…Œì´ë„ˆ -->
        <div class="explanation-button-container fixed top-[120px] md:top-[140px] left-1/2 -translate-x-1/2 z-40 w-full flex justify-center p-2 box-border">
            <div class="explanation-button-wrapper relative flex items-center justify-center">
                <!-- ì±… ëª¨ì–‘ ì•„ì´ì½˜ ë²„íŠ¼ -->
                <button class="explanation-icon-button absolute w-12 h-12 md:w-14 md:h-14 bg-pink-300 rounded-full shadow-md flex items-center justify-center text-4xl cursor-pointer" id="explanation-icon-button">
                    <span>ğŸ“–</span>
                </button>
                <!-- í•˜ìœ„ ë²„íŠ¼ë“¤: 'ì „ì²´ ê°„ë‹¨'ê³¼ 'ì „ì²´ ìƒì„¸' ë²„íŠ¼ ì¶”ê°€ -->
                <div class="explanation-sub-buttons absolute top-0 left-1/2 -translate-x-1/2">
                    <button class="explanation-sub-button bg-pink-300 text-gray-800 text-xs md:text-sm px-3 py-2 rounded-md shadow-md hover:scale-105 transition-transform" id="full-simple-explanation-button">ì „ì²´ë³¸ë¬¸ ê°„ë‹¨</button>
                    <button class="explanation-sub-button bg-pink-300 text-gray-800 text-xs md:text-sm px-3 py-2 rounded-md shadow-md hover:scale-105 transition-transform" id="full-detailed-explanation-button">ì „ì²´ë³¸ë¬¸ ìƒì„¸</button>
                    <button class="explanation-sub-button bg-pink-300 text-gray-800 text-xs md:text-sm px-3 py-2 rounded-md shadow-md hover:scale-105 transition-transform" id="detailed-explanation-button">ì„ íƒë¬¸ì¥ ê°„ë‹¨</button>
                    <button class="explanation-sub-button bg-pink-300 text-gray-800 text-xs md:text-sm px-3 py-2 rounded-md shadow-md hover:scale-105 transition-transform" id="simple-explanation-button">ì„ íƒë¬¸ì¥ìƒì„¸</button>
                    <button class="explanation-sub-button bg-pink-300 text-gray-800 text-xs md:text-sm px-3 py-2 rounded-md shadow-md hover:scale-105 transition-transform" id="image-explanation-button">ì„ íƒë¬¸ì¥ ê·¸ë¦¼</button>
                </div>
            </div>
        </div>

        <!-- í°íŠ¸ í¬ê¸° ì¡°ì ˆ -->
        <div class="flex items-center justify-center mb-6">
            <span class="text-lg font-bold text-blue-600 mr-4">ê¸€ê¼´ í¬ê¸°</span>
            <button id="down" class="w-10 h-10 text-2xl font-normal text-red-500 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100">-</button>
            <span id="font-size" class="text-2xl font-bold text-red-500 mx-4 w-10 text-center">20</span>
            <button id="up" class="w-10 h-10 text-2xl font-normal text-red-500 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100">+</button>
        </div>

        <!-- ì„±ê²½ ë³¸ë¬¸ -->
        <div id="bible-text" class="text-xl leading-extra-tight text-left text-gray-800 word-break-keep-all whitespace-pre-line">
            <strong>

í†µë… 1ì¼ì°¨
<br>ë²”ìœ„: ì°½ì„¸ê¸° 1ì¥- 11ì¥</br>
<br>&nbsp;</br>

</strong>
<strong><br><font color="#4682b4">ì°½ì„¸ê¸° 1 ì¥</font></br></strong>
<br><i><font color="#808080">*ì²œì§€ ì°½ì¡°*</font></i></br>
<br>1 íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼</br>
<br>2 ë•…ì´ í˜¼ëˆí•˜ê³  ê³µí—ˆí•˜ë©° í‘ì•”ì´ ê¹ŠìŒ ìœ„ì— ìˆê³  í•˜ë‚˜ë‹˜ì˜ ì˜ì€ ìˆ˜ë©´ ìœ„ì— ìš´í–‰í•˜ì‹œë‹ˆë¼</br>
<br>3 í•˜ë‚˜ë‹˜ì´ ì´ë¥´ì‹œë˜ ë¹›ì´ ìˆìœ¼ë¼ í•˜ì‹œë‹ˆ ë¹›ì´ ìˆì—ˆê³ </br>
<br>&nbsp;</br>
<br>     1ì¼ì°¨ ë</br>
<br>&nbsp;</br>
        </div>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div id="explanation-modal" class="fixed inset-0 z-[100] bg-gray-900 bg-opacity-50 hidden flex items-center justify-center">
        <!-- ëª¨ë‹¬ ì»¨í…ì¸ : ë†’ì´ ì œí•œ ë° ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì • -->
        <div class="modal-content relative w-11/12 max-w-lg bg-white p-6 rounded-lg shadow-2xl text-left transition-all duration-300 modal-enter">
            <button class="absolute top-2 right-2 text-gray-700 hover:text-gray-900 text-3xl font-bold" id="close-modal">&times;</button>
            
            <!-- ëª¨ë‹¬ ë‚´ìš©ì„ ë‹´ì„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ ì»¨í…Œì´ë„ˆ -->
            <div class="modal-text-container">
                <h3 id="modal-title" class="modal-title"></h3>
                <div id="modal-image-container" class="modal-image-container hidden">
                    <img id="modal-image" src="" alt="ì„¤ëª… ê´€ë ¨ ì´ë¯¸ì§€" class="modal-image">
                </div>
                <p id="modal-text" class="text-gray-700 leading-relaxed">êµ¬ì ˆì„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•˜ê³  'êµ¬ì ˆì„¤ëª…' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¡¤ ë§ˆì»¤ ì»¨í…Œì´ë„ˆ -->
    <div id="scroll-marker-container" class="scroll-marker-container"></div>
    
    <script>
        // ------------------------------
        // ì„¤ì •: API í‚¤ëŠ” ëŸ°íƒ€ì„ì— ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
        const geminiApiKey = "";
        // ------------------------------
        // DOM ìš”ì†Œ
        const bibleTextEl = document.getElementById('bible-text');
        const searchInput = document.getElementById('search-input');
        const searchForm = document.getElementById('search-form');
        const searchCountEl = document.getElementById('search-count');
        const nextLocationBtn = document.getElementById('next-location-btn');
        const resetBtn = document.getElementById('reset-btn');
        const scrollMarkerContainer = document.getElementById('scroll-marker-container');
        const explanationIconButton = document.getElementById('explanation-icon-button');
        const detailedExplanationButton = document.getElementById('detailed-explanation-button');
        const simpleExplanationButton = document.getElementById('simple-explanation-button');
        const imageExplanationButton = document.getElementById('image-explanation-button');
        
        // ìƒˆë¡œ ì¶”ê°€ëœ ë²„íŠ¼
        const fullSimpleExplanationButton = document.getElementById('full-simple-explanation-button');
        const fullDetailedExplanationButton = document.getElementById('full-detailed-explanation-button');

        const modal = document.getElementById('explanation-modal');
        const modalContent = document.querySelector('.modal-content');
        const closeModalButton = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalText = document.getElementById('modal-text');
        const audio = document.getElementById('audio-file');
        const playBtn = document.getElementById('play-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        const speedDisplay = document.getElementById('speed-display');
        const speedDown02Btn = document.getElementById('speed-down-02');
        const speedDown01Btn = document.getElementById('speed-down-01');
        const speedUp01Btn = document.getElementById('speed-up-01');
        const speedUp02Btn = document.getElementById('speed-up-02');
        const volumeSlider = document.getElementById('volume-slider');
        const currentTimeEl = document.getElementById('current-time');
        const remainingTimeEl = document.getElementById('remaining-time');
        const upBtn = document.getElementById('up');
        const downBtn = document.getElementById('down');
        const fontSizeEl = document.getElementById('font-size');
        const explanationButtonWrapper = document.querySelector('.explanation-button-wrapper');

        // ìƒíƒœê°’
        let selectedVerse = "";
        let originalText = "";
        let foundSentences = [];
        let currentSearchIndex = -1;
        let currentSpeed = 1.0;

        // ìœ í‹¸: RegExp íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', () => {
            originalText = bibleTextEl.innerHTML;
            updateFontSizeDisplay();
            updateSpeed();
        
            // í…ìŠ¤íŠ¸ ë“œë˜ê·¸/ì„ íƒ ì´ë²¤íŠ¸
            document.addEventListener('mouseup', () => {
                const selection = window.getSelection();
                selectedVerse = selection ? selection.toString().trim() : '';
            });

            // ê²€ìƒ‰ í¼
            if (searchForm) {
                searchForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    findString(searchInput.value);
                });
            }
            if (resetBtn) resetBtn.addEventListener('click', clearHighlight);
            if (nextLocationBtn) nextLocationBtn.addEventListener('click', nextLocation);
        
            // í°íŠ¸ í¬ê¸° ì¡°ì ˆ
            if (upBtn) upBtn.addEventListener('click', () => {
                let currentSize = parseFloat(window.getComputedStyle(bibleTextEl).fontSize);
                if (currentSize + 2 <= 40) {
                    bibleTextEl.style.fontSize = (currentSize + 2) + 'px';
                    updateFontSizeDisplay();
                }
            });
            if (downBtn) downBtn.addEventListener('click', () => {
                let currentSize = parseFloat(window.getComputedStyle(bibleTextEl).fontSize);
                if (currentSize - 2 >= 12) {
                    bibleTextEl.style.fontSize = (currentSize - 2) + 'px';
                    updateFontSizeDisplay();
                }
            });
        
            // ì˜¤ë””ì˜¤ ì»¨íŠ¸ë¡¤
            playBtn.addEventListener('click', () => { audio.play(); });
            pauseBtn.addEventListener('click', () => { audio.pause(); });
            stopBtn.addEventListener('click', () => { audio.pause(); audio.currentTime = 0; });
        
            speedDown02Btn.addEventListener('click', () => { currentSpeed = Math.max(0.5, currentSpeed - 0.2); updateSpeed(); });
            speedDown01Btn.addEventListener('click', () => { currentSpeed = Math.max(0.5, currentSpeed - 0.1); updateSpeed(); });
            speedUp01Btn.addEventListener('click', () => { currentSpeed = Math.min(2.0, currentSpeed + 0.1); updateSpeed(); });
            speedUp02Btn.addEventListener('click', () => { currentSpeed = Math.min(2.0, currentSpeed + 0.2); updateSpeed(); });
        
            volumeSlider.addEventListener('input', () => { audio.volume = volumeSlider.value; });
        
            audio.addEventListener('timeupdate', () => {
                const currentTime = audio.currentTime;
                const duration = audio.duration;
                currentTimeEl.textContent = formatTime(currentTime);
                if (isFinite(duration)) {
                    const remainingTime = duration - currentTime;
                    remainingTimeEl.textContent = '-' + formatTime(remainingTime);
                }
            });
        
            // ì•„ì´ì½˜ í´ë¦­ -> ì„œë¸Œë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¸°ê¸°
            explanationIconButton.addEventListener('click', (event) => {
                event.stopPropagation(); // ë²„íŠ¼ í´ë¦­ ì‹œ body í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                explanationButtonWrapper.classList.add('show');
            });
        
            // ìƒì„¸/ê°„ë‹¨/ê·¸ë¦¼ ì„¤ëª… ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            detailedExplanationButton.addEventListener('click', (event) => {
                event.stopPropagation();
                const trimmedVerse = selectedVerse.trim();
                if (!trimmedVerse) {
                    showModal("êµ¬ì ˆì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”", "ë³¸ë¬¸ì—ì„œ êµ¬ì ˆì´ë‚˜ ë‹¨ì–´ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•œ í›„ ë‹¤ì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                } else {
                    fetchExplanation(trimmedVerse, 'detailed');
                }
                explanationButtonWrapper.classList.remove('show');
            });
        
            simpleExplanationButton.addEventListener('click', (event) => {
                event.stopPropagation();
                const trimmedVerse = selectedVerse.trim();
                if (!trimmedVerse) {
                    showModal("êµ¬ì ˆì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”", "ë³¸ë¬¸ì—ì„œ êµ¬ì ˆì´ë‚˜ ë‹¨ì–´ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•œ í›„ ë‹¤ì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                } else {
                    fetchExplanation(trimmedVerse, 'simple');
                }
                explanationButtonWrapper.classList.remove('show');
            });
        
            imageExplanationButton.addEventListener('click', async (event) => {
                event.stopPropagation();
                const trimmedVerse = selectedVerse.trim();
                if (!trimmedVerse) {
                    showModal("êµ¬ì ˆì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”", "ë³¸ë¬¸ì—ì„œ êµ¬ì ˆì´ë‚˜ ë‹¨ì–´ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•œ í›„ ë‹¤ì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                } else {
                    await fetchImageAndExplanation(trimmedVerse);
                }
                explanationButtonWrapper.classList.remove('show');
            });

            // ìƒˆë¡œ ì¶”ê°€ëœ 'ì „ì²´ ê°„ë‹¨' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            fullSimpleExplanationButton.addEventListener('click', (event) => {
                event.stopPropagation();
                const fullText = bibleTextEl.innerText;
                if (!fullText.trim()) {
                    showModal("ë³¸ë¬¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤", "ë¶„ì„í•  ì„±ê²½ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                } else {
                    fetchOverallExplanation(fullText, 'full_simple');
                }
                explanationButtonWrapper.classList.remove('show');
            });
            
            // ìƒˆë¡œ ì¶”ê°€ëœ 'ì „ì²´ ìƒì„¸' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            fullDetailedExplanationButton.addEventListener('click', (event) => {
                event.stopPropagation();
                const fullText = bibleTextEl.innerText;
                if (!fullText.trim()) {
                    showModal("ë³¸ë¬¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤", "ë¶„ì„í•  ì„±ê²½ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                } else {
                    fetchOverallExplanation(fullText, 'full_detailed');
                }
                explanationButtonWrapper.classList.remove('show');
            });


            // body ì™¸ë¶€ í´ë¦­ ì‹œ í•˜ìœ„ ë²„íŠ¼ ë‹«ê¸°
            document.body.addEventListener('click', (event) => {
                if (!explanationButtonWrapper.contains(event.target)) {
                    explanationButtonWrapper.classList.remove('show');
                }
            });
        
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModalButton.addEventListener('click', hideModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    hideModal();
                }
            });
        });

        // í°íŠ¸ í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateFontSizeDisplay() {
            const currentSize = parseFloat(window.getComputedStyle(bibleTextEl).fontSize);
            fontSizeEl.textContent = Math.round(currentSize);
        }
        
        // ì¬ìƒ ì†ë„ ì—…ë°ì´íŠ¸
        function updateSpeed() {
            audio.playbackRate = currentSpeed;
            speedDisplay.textContent = currentSpeed.toFixed(1) + 'x';
        }
        
        // ì‹œê°„ í¬ë§·
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // ê²€ìƒ‰ ë° í•˜ì´ë¼ì´íŠ¸
        function findString(searchText) {
            clearHighlight();
            if (!searchText || searchText.trim() === '') {
                searchCountEl.textContent = '';
                nextLocationBtn.classList.add('hidden');
                return;
            }
            const escaped = escapeRegExp(searchText);
            const regex = new RegExp(escaped, 'gi');
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = originalText;
            
            const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const textNodesToReplace = [];
            while ((node = walker.nextNode())) {
                textNodesToReplace.push(node);
            }

            for (const textNode of textNodesToReplace) {
                const text = textNode.nodeValue;
                if (text.match(regex)) {
                    const parent = textNode.parentNode;
                    const newContent = text.replace(regex, (match) => `<span class="search-highlight">${match}</span>`);
                    const tempSpan = document.createElement('span');
                    tempSpan.innerHTML = newContent;
                    while (tempSpan.firstChild) {
                        parent.insertBefore(tempSpan.firstChild, textNode);
                    }
                    parent.removeChild(textNode);
                }
            }
            
            bibleTextEl.innerHTML = tempDiv.innerHTML;
            foundSentences = Array.from(bibleTextEl.getElementsByClassName('search-highlight'));
            
            searchCountEl.textContent = `ì´ ${foundSentences.length}ê°œ ê²€ìƒ‰ë¨`;
            if (foundSentences.length > 0) {
                currentSearchIndex = 0;
                foundSentences[currentSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                nextLocationBtn.classList.remove('hidden');
                updateScrollMarkers();
            } else {
                showModal("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ", `"${searchText}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                nextLocationBtn.classList.add('hidden');
            }
        }
        
        // ë‹¤ìŒ ê²€ìƒ‰ ìœ„ì¹˜
        function nextLocation() {
            if (foundSentences.length > 0) {
                currentSearchIndex = (currentSearchIndex + 1) % foundSentences.length;
                foundSentences[currentSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // í•˜ì´ë¼ì´íŠ¸ ì´ˆê¸°í™”
        function clearHighlight() {
            bibleTextEl.innerHTML = originalText;
            searchInput.value = '';
            searchCountEl.textContent = '';
            nextLocationBtn.classList.add('hidden');
            while (scrollMarkerContainer.firstChild) scrollMarkerContainer.removeChild(scrollMarkerContainer.firstChild);
            foundSentences = [];
            currentSearchIndex = -1;
        }
        
        // ìŠ¤í¬ë¡¤ ë§ˆì»¤ ì—…ë°ì´íŠ¸
        function updateScrollMarkers() {
            while (scrollMarkerContainer.firstChild) scrollMarkerContainer.removeChild(scrollMarkerContainer.firstChild);
            const documentHeight = bibleTextEl.scrollHeight;
            const viewportHeight = window.innerHeight;
            for (let i = 0; i < foundSentences.length; i++) {
                const el = foundSentences[i];
                const marker = document.createElement('div');
                marker.className = 'scroll-marker';
                const topPosition = el.getBoundingClientRect().top + window.scrollY;
                const markerPosition = (topPosition / documentHeight) * viewportHeight;
                marker.style.top = `${markerPosition}px`;
                marker.addEventListener('click', () => {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                scrollMarkerContainer.appendChild(marker);
            }
        }
        
        /**
         * showModal: ëª¨ë‹¬ì„ ì—´ê³  ë‚´ìš©ì„ í‘œì‹œ
         * @param {string} title ëª¨ë‹¬ ì œëª©
         * @param {string} text ëª¨ë‹¬ í…ìŠ¤íŠ¸ ë‚´ìš©
         * @param {string} [imageUrl=null] ëª¨ë‹¬ ì´ë¯¸ì§€ URL
         * @param {boolean} [isLoading=false] ë¡œë”© ìƒíƒœ ì—¬ë¶€
         */
        function showModal(title, text, imageUrl = null, isLoading = false) {
            modalTitle.textContent = title;
            modalText.innerHTML = (text || '').toString().replace(/\n/g, '<br>');
            
            // ë¡œë”© ìƒíƒœì— ë”°ë¼ ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ë¥¼ ì œì–´
            if (isLoading) {
                modalImageContainer.classList.add('hidden');
                modalText.innerHTML = `<span class="text-xl font-semibold flex items-center justify-center text-blue-500">${imageUrl ? '<span class="loader"></span> ê·¸ë¦¼ ìƒì„± ì¤‘...' : '<span class="loader"></span> ì„¤ëª… ìƒì„± ì¤‘...'}</span>`;
            } else {
                if (imageUrl) {
                    modalImage.src = imageUrl;
                    modalImageContainer.classList.remove('hidden');
                } else {
                    modalImage.src = '';
                    modalImageContainer.classList.add('hidden');
                }
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modalContent.classList.remove('modal-enter');
            modalContent.classList.add('modal-enter-active');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function hideModal() {
            modalContent.classList.add('modal-leave-to');
            modalContent.classList.remove('modal-enter-active');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modalContent.classList.remove('modal-leave-to');
                modalContent.classList.add('modal-enter');
            }, 300); // CSS transition timeê³¼ ë§ì¶¤
        }
        
        /**
         * fetchExplanation: ìƒì„¸/ê°„ë‹¨ ì„¤ëª… ìƒì„±
         * type: 'detailed' ë˜ëŠ” 'simple'
         */
        async function fetchExplanation(promptText, type) {
            showModal(promptText, '', null, true); // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ

            let prompt;
            const model = "gemini-2.5-flash-preview-05-20";
            const systemPrompt = "ë‹¹ì‹ ì€ ì„±ê²½ ì§€ì‹ì— í•´ë°•í•œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì„±ê²½ì— ë‚˜ì˜¤ëŠ” ë‹¨ì–´ë‚˜ êµ¬ì ˆì— ëŒ€í•´ ì§ˆë¬¸ì„ ë°›ìœ¼ë©´, í•´ë‹¹ ìš©ì–´ì˜ ë°°ê²½ê³¼ ì˜ë¯¸ë¥¼ ê¹Šì´ ìˆê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”. í•œêµ­ì–´ë¡œ ë‹µë³€í•´ ì£¼ì„¸ìš”.";

            if (type === 'simple') {
                prompt = `ë‹¤ìŒ ì„±ê²½ ìš©ì–´/êµ¬ì ˆì— ëŒ€í•´ 300ìì—ì„œ 500ì ì‚¬ì´ì˜ ì§§ê³  ê°„ê²°í•œ ì„¤ëª…ì„ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”. í•µì‹¬ ë‚´ìš©ì„ ì¤‘ì‹¬ìœ¼ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ìš”ì²­ ìš©ì–´/êµ¬ì ˆ: "${promptText}"`;
            } else { // detailed
                prompt = `ë‹¤ìŒ ì„±ê²½ ìš©ì–´/êµ¬ì ˆì— ëŒ€í•´ ì„±ê²½ì  ê´€ì ì—ì„œ ìì„¸íˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”. ë‹µë³€ì€ ìµœì†Œ 100ì ì´ìƒìœ¼ë¡œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”. í•„ìš”í•œ ê²½ìš° í‘œ ë˜ëŠ” ê°„ë‹¨í•œ ì§€ë„ë¥¼ í¬í•¨í•˜ê±°ë‚˜ ì°¸ì¡°í•´ ì£¼ì„¸ìš”. ìš”ì²­ ìš©ì–´/êµ¬ì ˆ: "${promptText}"`;
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status})`);
                }

                const result = await response.json();
                const explanation =
                    result?.candidates?.[0]?.content?.parts?.[0]?.text ||
                    "ìš”ì²­í•˜ì‹  ë‚´ìš©ì— ëŒ€í•œ ì„¤ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                
                showModal(promptText, explanation);
            } catch (err) {
                showModal("ì˜¤ë¥˜ ë°œìƒ", `ì„¤ëª…ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`);
            }
        }
        
        /**
         * fetchOverallExplanation: ë³¸ë¬¸ ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•œ ìš”ì•½ ìƒì„±
         * type: 'full_simple' ë˜ëŠ” 'full_detailed'
         */
        async function fetchOverallExplanation(fullText, type) {
            showModal("ì „ì²´ ë³¸ë¬¸ ë¶„ì„", '', null, true); // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ

            let prompt;
            const model = "gemini-2.5-flash-preview-05-20";
            const systemPrompt = "ë‹¹ì‹ ì€ ì„±ê²½ ì£¼ì„ê°€ì´ì ì„±ê²½ ì—°êµ¬ìì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì œê³µí•œ ì„±ê²½ ë³¸ë¬¸ì„ í•™ë¬¸ì Â·ì‹ í•™ì  ë°°ê²½ì—ì„œ ë¶„ì„í•˜ì—¬, í•µì‹¬ ì£¼ì œì™€ ë©”ì‹œì§€ì— ì§‘ì¤‘í•˜ì—¬ ë‹µë³€í•´ì£¼ì„¸ìš”. í•œêµ­ì–´ë¡œ ë‹µë³€í•´ ì£¼ì„¸ìš”.";
            
            // ê³µë°±ê³¼ ì¤„ë°”ê¿ˆì„ ì œê±°í•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ì •ì œí•©ë‹ˆë‹¤.
            const cleanedText = fullText.replace(/\s+/g, ' ').trim();

            if (type === 'full_simple') {
                prompt = `ì„±ê²½ ë³¸ë¬¸ì„ í•™ë¬¸ì Â·ì‹ í•™ì  ë°°ê²½ì—ì„œ ë¶„ì„í•˜ì—¬, í•µì‹¬ ì£¼ì œì™€ ë©”ì‹œì§€ë¥¼ 500ì ë¯¸ë§Œìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ë¶ˆí•„ìš”í•œ ì¥í™©í•œ ì„¤ëª…ì€ í”¼í•˜ê³ , ì„±ê²½ ë³¸ë¬¸ì˜ í•µì‹¬ ì˜ë¯¸ì™€ êµí›ˆì— ì§‘ì¤‘í•˜ì„¸ìš”. ì„±ê²½ ë³¸ë¬¸: "${cleanedText}"`;
            } else { // full_detailed
                prompt = `ì„±ê²½ ë³¸ë¬¸ì„ í•™ë¬¸ì Â·ì‹ í•™ì  ë°°ê²½ì—ì„œ ë¶„ì„í•˜ì—¬, í•µì‹¬ ì£¼ì œì™€ ë©”ì‹œì§€ë¥¼ 3000ì ë¯¸ë§Œìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ë¶ˆí•„ìš”í•œ ì¥í™©í•œ ì„¤ëª…ì€ í”¼í•˜ê³ , ì„±ê²½ ë³¸ë¬¸ì˜ í•µì‹¬ ì˜ë¯¸ì™€ êµí›ˆì— ì§‘ì¤‘í•˜ì„¸ìš”. ì„±ê²½ ë³¸ë¬¸: "${cleanedText}"`;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status})`);
                }

                const result = await response.json();
                const explanation =
                    result?.candidates?.[0]?.content?.parts?.[0]?.text ||
                    "ìš”ì²­í•˜ì‹  ë‚´ìš©ì— ëŒ€í•œ ì„¤ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                
                showModal("ì „ì²´ ë³¸ë¬¸ ë¶„ì„", explanation);
            } catch (err) {
                showModal("ì˜¤ë¥˜ ë°œìƒ", `ì„¤ëª…ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`);
            }
        }
        
        /**
         * fetchImageAndExplanation: ì´ë¯¸ì§€ ìƒì„± ë° ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
         * @param {string} promptText ì´ë¯¸ì§€ ë° ì„¤ëª…ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸
         */
        async function fetchImageAndExplanation(promptText) {
            showModal("ê·¸ë¦¼ ìƒì„± ë° ì„¤ëª…", '', null, true);

            const prompt = `Create a visually striking, artistic illustration of the following biblical concept or verse. Use a distinct, powerful art style that captures the spiritual or historical essence, and avoid modern or photorealistic styles. The artwork should be an evocative interpretation, not a literal one. Do not include any text or labels in the image itself. The illustration should represent "${promptText}"`;
            const explanationPrompt = `Generate a concise explanation (in Korean, less than 200 characters) of the biblical context or meaning of "${promptText}" to be displayed with the image.`;

            try {
                // ë³‘ë ¬ API í˜¸ì¶œì„ ìœ„í•œ Promise.all
                const [imageResponse, textResponse] = await Promise.all([
                    fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${geminiApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instances: [{ prompt: prompt }],
                            parameters: { sampleCount: 1 }
                        })
                    }),
                    fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: explanationPrompt }] }],
                        })
                    })
                ]);
                
                const imageData = await imageResponse.json();
                const textData = await textResponse.json();
                
                const base64Data = imageData?.predictions?.[0]?.bytesBase64Encoded;
                const textExplanation = textData?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (base64Data && textExplanation) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    showModal(promptText, textExplanation, imageUrl);
                } else {
                    showModal("ê²°ê³¼ ì—†ìŒ", "ê·¸ë¦¼ê³¼ ì„¤ëª…ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }

            } catch (err) {
                showModal("ì˜¤ë¥˜ ë°œìƒ", `ê·¸ë¦¼ê³¼ ì„¤ëª…ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`);
            }
        }

    </script>
</body>
</html>



