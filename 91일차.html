<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>통큰통독-01일차</title>
  <link rel="apple-touch-icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
  <meta name="apple-mobile-web-app-title" content="통큰통독">
  <link rel="shortcut icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
  <link rel="mask-icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">

  <style>
    /* ---------------------------
       전체 스타일 (원 디자인 유지)
       --------------------------- */
    :root{
      --blue:#007BFF;
      --pink:#ff99cc;
      --shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html,body { height:100%; margin:0; padding:0; font-family: Arial, sans-serif; -webkit-font-smoothing:antialiased; }
    body { padding-top:150px; background:#fdfdf8; color:#222; }

    a:link { color:#0000FF; } a:visited{ color:#660099; }

    /* 상단 고정 테이블 */
    .top-fixed-table {
      position: fixed; top:0; left:0; width:100%; background:transparent; border-bottom:none; z-index:100;
      table-layout: fixed; padding:10px 0; box-sizing:border-box;
    }
    .search-cell { text-align:left; padding-left:10px; vertical-align:top; width:30%; }
    .search-cell input[type="text"]{ width:50%; font-size:12pt; }
    .search-cell input[type="submit"], .search-cell input[type="reset"]{ font-size:10pt; padding:5px 8px; height:auto; }

    .audio-cell { text-align:right; padding-right:50px; vertical-align:top; width:30%; }
    #custom-audio-player { display:flex; flex-direction:column; align-items:center; }
    .player-controls{ display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:5px; }
    .time-display{ font-size:16px; font-weight:bold; color:black; margin:0 5px; min-width:44px; text-align:center; }

    .progress-container { display: flex; align-items: center; justify-content: center; gap: 6px; margin: 6px 0; }
    .skip-btn { width: 48px; height: 28px; font-size: 13px; cursor: pointer; border: 1px solid #ccc; border-radius: 5px; background: #fff; }
    .skip-btn:hover { background: #e0e0e0; }

    .control-btn{ width:28px; height:28px; font-size:14px; cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:5px; }
    .control-btn:hover{ background:#e0e0e0; }
    #play-btn{ background:#d1f3d4; } #pause-btn{ background:#fff6d6; } #stop-btn{ background:#fddddd; }

    .speed-controls{ display:flex; align-items:center; justify-content:center; gap:5px; margin-bottom:5px; }
    .speed-btn{ width:21px; height:21px; font-size:10px; cursor:pointer; border:1px solid #ccc; border-radius:3px; background:#fff; }
    .speed-btn:hover{ background:#e0e0e0; }
    .speed-display{ font-weight:bold; color:var(--blue); width:50px; text-align:center; }

    .volume-control{ display:flex; align-items:center; justify-content:center; gap:5px; }
    input[type="range"]{ -webkit-appearance:none; width:160px; height:5px; background:#d3d3d3; outline:none; opacity:0.9; transition:opacity .2s; border-radius:3px;}
    input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:15px; height:15px; background:var(--blue); border-radius:50%; cursor:pointer; }

    /* progress */
    #progress-bar { width: 60%; max-width: 100px; }

    /* volume */
    #volume-slider { width: 80%; max-width: 120px; }

    /* 설명 버튼 컨테이너 (플로팅) */
    .explanation-button-container{ position:fixed; top:100px; left:30%; transform:translateX(-50%); z-index:100; display:block; padding:0 10px; transition:top .2s ease,left .2s ease,transform .2s ease; }
    .explanation-button-wrapper{ position:relative; display:inline-block; cursor:pointer; }
    .explanation-icon-button{ width:50px; height:50px; border-radius:50%; background:var(--pink); box-shadow:var(--shadow); border:none; display:flex; align-items:center; justify-content:center; font-size:40px; z-index:2; }
    .explanation-sub-buttons{ display:flex; flex-direction:column; gap:10px; opacity:0; visibility:hidden; transition:opacity .3s ease,visibility .3s ease, transform .3s ease; position:absolute; left:45%; transform:translateX(-50%) translateY(25px); z-index:1; }
    .explanation-button-wrapper.active .explanation-sub-buttons{ opacity:1; visibility:visible; transform:translateX(-50%) translateY(0); }
    .explanation-sub-button{ padding:5px 10px; font-size:18px; background:var(--pink); border:none; border-radius:5px; cursor:pointer; box-shadow:var(--shadow); white-space:nowrap; }
    .explanation-sub-button:hover{ transform:scale(1.03); }

    /* 폰트 사이즈 및 본문 요약 버튼 (항상 표시) */
    .container{ width:100%; text-align:center; margin-top:8px; }
    .font-size-label{ font-size:20px !important; margin-right:12px; font-weight:bold; color:blue; display:inline-block; vertical-align:middle; }
    #font-size{ font-size:20px !important; margin:0 8px; font-weight:bold; color:red; display:inline-block; vertical-align:middle; width:48px; }
    #down,#up{ width:27px; height:27px; font-size:20px; color:red; background:#fff; border:1px solid #ccc; border-radius:5px; cursor:pointer; display:inline-block; vertical-align:middle; }

    /* 본문 요약 버튼 - 항상 노출 (요구사항) */
    .summary-buttons { display:inline-block; margin-left:16px; vertical-align:middle; }
    .summary-btn { padding:6px 10px; margin-left:6px; font-size:14px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .summary-btn:hover{ background:#f2f2f2; }

    /* 본문 */
    h2{ padding:0; text-align:left; margin-left:15px; margin-right:15px; }
    p{ display:inline-block; }


    /*본문 중앙 색상*/
    .highlight { background-color: #fdf6e3;    /* 연한 베이지 톤 (눈부심 최소화) */
    -webkit-text-stroke:0.2px #76d6c6;
     border-left: 4px solid #c0a060; /* 옆에 차분한 금색 포인트 */
     font-weight:bold;
     box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
     padding: 2px 6px;
    }



    /* 모달 */
    .modal{ display:none; position:fixed; z-index:200; inset:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.4); }
    .modal-content{ background:#fff; margin:12% auto; padding:20px; border-radius:10px; width:80%; max-width:900px; box-shadow:0 4px 8px rgba(0,0,0,0.2); text-align:left; line-height:1.6; word-break:keep-all; white-space:pre-wrap; }
    .close-button{ color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
    .close-button:hover{ color:#000; }
    #modal-image{ max-width:100%; height:auto; margin-bottom:12px; display:none; border-radius:8px; }

    /* 로딩 스피너 */
    .loader{ border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-right:8px; }
    @keyframes spin{ 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

    /* 스크롤 마커 */
    .search-highlight{ background:yellow; color:#000; }
    .scroll-marker-container{ position:fixed; top:0; right:0; width:8px; height:100vh; z-index:99; pointer-events:none; }
    .scroll-marker{ position:absolute; right:0; width:8px; height:8px; background:red; border-radius:50%; box-shadow:0 0 5px rgba(255,0,0,0.7); cursor:pointer; pointer-events:auto; }
    .scroll-marker:hover{ transform:scale(1.5); transition:transform .2s ease; }

    /* 선택 관련 (iOS) */
    #bible-text{ -webkit-user-select:text; user-select:text; -webkit-touch-callout:none; }

    /* 반응형 보완 */
    @media (max-width:800px){
      .search-cell{ width:55%; } .audio-cell{ width:45%; } .search-cell input[type="text"]{ width:60%; } #progress-bar{ width:160px; }
    }
    @media (max-width:600px){
      .search-cell input[type="text"]{ width:68%; font-size:11pt; } .time-display{ font-size:13px; } #progress-bar{ width:140px; }
      .explanation-sub-button{ font-size:16px; padding:6px 8px; }
      .explanation-icon-button{ width:46px; height:46px; font-size:34px; }
      .summary-btn{ padding:5px 8px; font-size:13px; }
    }

     /* --- 새 버튼 그룹 스타일 --- */
    .toggle-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .toggle-buttons button {
      padding: 4px 8px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #fff;
      cursor: pointer;
    }
    .toggle-buttons button:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <!-- 상단: 검색 + 오디오 -->
  <table class="top-fixed-table" id="main-table" cellpadding="0" cellspacing="0">
    <tr>
      <td class="search-cell">
        <form name="f1" action="">
          <input type="reset" name="b2" value="X">
          <input type="text" placeholder="검색어를 입력하세요" name="t1" value="">
          <input type="submit" name="b1" value="검색">
          <div id="search-count-container">
            <span id="search-count"></span>
            <button type="button" id="next-location-btn" style="display:none;">다음 위치</button>
          </div>
        </form>
      </td>
      
       <td class="audio-cell">
        <div id="custom-audio-player" role="region" aria-label="오디오 플레이어">
          <audio id="audio-file" preload="auto" playsinline>
            <source src="https://vod47.anyline.co.kr/vod_ezra/%EC%9D%BD%EA%B8%B0%2001.mp3" type="audio/mpeg">
            브라우저가 오디오 요소를 지원하지 않습니다.
          </audio>

          <!-- 기본 컨트롤 -->
          <div class="player-controls">
            <strong><span style="font-size:16px; background-color: #fcfcfc;" id="current-time" class="time-display">0:00</span></strong>
            <button id="play-btn" class="control-btn" aria-label="재생">▶</button>
            <button id="pause-btn" class="control-btn" aria-label="일시정지">⏸</button>
            <button id="stop-btn" class="control-btn" aria-label="정지">■</button>
            <strong><span style="font-size:16px; background-color: #fcfcfc;" id="remaining-time" class="time-display">0:00</span></strong>
          </div>

          <!-- ✅ 새 버튼 그룹 -->
          <div class="toggle-buttons">
            <button id="show-progress">재생 위치</button>
            <button id="show-speed">재생 속도</button>
            <button id="show-volume">볼륨 조절</button>
          </div>

          <!-- 기본은 숨김 -->
          <div class="progress-container" style="display:none;">
            <button id="rewind-10" class="skip-btn">⏪10s</button>
            <input type="range" id="progress-bar" min="0" max="100" value="0" step="0.01" aria-label="재생 위치">
            <button id="forward-10" class="skip-btn">10s⏩</button>
          </div>

          <div class="speed-controls" style="display:none;">
            <button id="speed-down-02" class="speed-btn">&laquo;</button>
            <button id="speed-down-01" class="speed-btn">&lt;</button>
            <span id="speed-display" class="speed-display">1.0x</span>
            <button id="speed-up-01" class="speed-btn">&gt;</button>
            <button id="speed-up-02" class="speed-btn">&raquo;</button>
            <button id="speed-reset">1.0</button>
          </div>

          <div class="volume-control" style="display:none;">
            <span style="font-size:14px;">볼륨</span>
            <button id="mute-btn">🔊</button>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
          </div>
        </div>
      </td>
    </tr>
  </table>

  <!-- 플로팅 책 버튼 (구절설명 토글) -->
  <div class="explanation-button-container" id="explanation-button-container">
    <div class="explanation-button-wrapper" id="explanation-button-wrapper">
      <button class="explanation-icon-button" id="explanation-icon-button" aria-label="구절설명 열기">
        <span>📖</span>
      </button>
      <div class="explanation-sub-buttons" id="explanation-sub-buttons" role="menu">
        <button class="explanation-sub-button" id="detailed-explanation-button">상세 구절설명</button>
        <button class="explanation-sub-button" id="simple-explanation-button">간단 구절설명</button>
      </div>
    </div>
  </div>

  <!-- 폰트 크기 + 항상 표시되는 본문 요약 버튼 -->
  <div class="container" style="margin-top:6px;">
    <p class="font-size-label">Font Size</p>
    <button id="down">-</button>
    <p id="font-size">20</p>
    <button id="up">+</button>

    <span class="summary-buttons" aria-hidden="false">
      <button class="summary-btn" id="summary-simple-main">본문요약 간단</button>
      <button class="summary-btn" id="summary-detailed-main">본문요약 상세</button>
    </span>
  </div>

  <!-- 본문 (원문 유지: <br></br> 포함) -->
  <div>
    <h2 id="bible-text" style="line-height:1.2em;margin-left:15px;margin-right:15px;font-style:normal;font-weight:normal;color:black;font-size:20px;word-break:break-all;">
    <strong>

통독 1일차
<br>범위: 창세기 1장- 11장</br>
<br>&nbsp;</br>

</strong>
<strong><br><font color="#4682b4">창세기 1 장</font></br></strong>
<br><i><font color="#808080">*천지 창조*</font></i></br>
<br>1 태초에 하나님이 천지를 창조하시니라</br>
<br>2 땅이 혼돈하고 공허하며 흑암이 깊음 위에 있고 하나님의 영은 수면 위에 운행하시니라</br>
<br>3 하나님이 이르시되 빛이 있으라 하시니 빛이 있었고</br>
<br>4 빛이 하나님이 보시기에 좋았더라 하나님이 빛과 어둠을 나누사</br>
<br>5 하나님이 빛을 낮이라 부르시고 어둠을 밤이라 부르시니라 저녁이 되고 아침이 되니 이는 첫째 날이니라</br>
<br>6 하나님이 이르시되 물 가운데에 궁창이 있어 물과 물로 나뉘라 하시고</br>
<br>7 하나님이 궁창을 만드사 궁창 아래의 물과 궁창 위의 물로 나뉘게 하시니 그대로 되니라</br>
<br>8 하나님이 궁창을 하늘이라 부르시니라 저녁이 되고 아침이 되니 이는 둘째 날이니라</br>
<br>9 하나님이 이르시되 천하의 물이 한 곳으로 모이고 뭍이 드러나라 하시니 그대로 되니라</br>
<br>10 하나님이 뭍을 땅이라 부르시고 모인 물을 바다라 부르시니 하나님이 보시기에 좋았더라</br>
<br>&nbsp;</br>
<br>    1일차 끝</br>
<br>&nbsp;</br>
    </h2>
  </div>

  <!-- 모달 (설명/요약 출력) -->
  <div id="explanation-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <span class="close-button" id="close-modal" aria-label="닫기">&times;</span>
      <h3 id="modal-title">구절 설명</h3>
      <img id="modal-image" src="" alt="설명 관련 이미지" />
      <div id="modal-text">구절을 드래그하여 선택하고 '구절설명' 버튼을 누르세요.</div>
    </div>
  </div>

  <div id="scroll-marker-container" class="scroll-marker-container" aria-hidden="true"></div>

  <script>
    // ------------------------------
    // API KEY (사용자 입력 상태)
    const apiKey = "AIzaSyDUlSQlSPgnrFBXpnUJMDoUO3s_KsaoFRU";
    // ------------------------------

    // DOM
    const bibleTextEl = document.getElementById('bible-text');
    const searchCountEl = document.getElementById('search-count');
    const nextLocationBtn = document.getElementById('next-location-btn');
    const scrollMarkerContainer = document.getElementById('scroll-marker-container');

    const explanationIconButton = document.getElementById('explanation-icon-button');
    const explanationButtonWrapper = document.getElementById('explanation-button-wrapper');
    const explanationSubButtons = document.getElementById('explanation-sub-buttons');
    const detailedExplanationButton = document.getElementById('detailed-explanation-button');
    const simpleExplanationButton = document.getElementById('simple-explanation-button');

    const summarySimpleMain = document.getElementById('summary-simple-main');
    const summaryDetailedMain = document.getElementById('summary-detailed-main');

    const modal = document.getElementById('explanation-modal');
    const closeModalButton = document.getElementById('close-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalImage = document.getElementById('modal-image');
    const modalText = document.getElementById('modal-text');

    const audio = document.getElementById('audio-file');
    const playBtn = document.getElementById('play-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const progressBar = document.getElementById('progress-bar');
    const rewindBtn = document.getElementById('rewind-10');
    const forwardBtn = document.getElementById('forward-10');
    const speedDisplay = document.getElementById('speed-display');
    const speedDown02Btn = document.getElementById('speed-down-02');
    const speedDown01Btn = document.getElementById('speed-down-01');
    const speedUp01Btn = document.getElementById('speed-up-01');
    const speedUp02Btn = document.getElementById('speed-up-02');
    const speedResetBtn = document.getElementById('speed-reset');
    const volumeSlider = document.getElementById('volume-slider');
    const muteBtn = document.getElementById('mute-btn');
    const currentTimeEl = document.getElementById('current-time');
    const remainingTimeEl = document.getElementById('remaining-time');

    const upBtn = document.getElementById('up');
    const downBtn = document.getElementById('down');
    const fontSizeEl = document.getElementById('font-size');

    // 상태
    let originalText = "";
    let selectedVerse = "";
    let selectionRange = null; // 선택 영역 복원용
    let foundSentences = [];
    let currentSearchIndex = -1;
    let currentSpeed = 1.0;
    let isMuted = false;
    let selectionDebounce = null;

    // 유틸
    function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function formatTime(sec) { if (!isFinite(sec) || sec < 0) return '0:00'; const m = Math.floor(sec/60); const s = Math.floor(sec%60); return `${m}:${String(s).padStart(2,'0')}`; }

    // 초기화
    window.addEventListener('DOMContentLoaded', () => {
      originalText = bibleTextEl.innerHTML; // 원본 보관
      updateFontSizeDisplay();
      updateSpeed();

      // ---------------------------
  // (추가 1) 본문 줄 단위 분리
  // ---------------------------
  const lines = originalText.split(/<br\s*\/?>/i);
  bibleTextEl.innerHTML = lines.map(line => {
    if (line.trim() === "") return "<br>";
    return `<span class="line">${line}</span><br>`;
  }).join("");

  const lineElements = document.querySelectorAll("#bible-text .line");

  // ---------------------------
  // (추가 2) 스크롤 시 중앙 두 줄 강조
  // ---------------------------
  function highlightCenterLines() {
    const viewportCenter = window.innerHeight / 2 + window.scrollY;
    let closestIndex = -1;
    let minDistance = Infinity;

    lineElements.forEach((line, i) => {
      const rect = line.getBoundingClientRect();
      const lineCenter = rect.top + window.scrollY + rect.height / 2;
      const distance = Math.abs(lineCenter - viewportCenter);

      if (distance < minDistance) {
        minDistance = distance;
        closestIndex = i;
      }
    });

    // 강조 초기화
    lineElements.forEach(line => line.classList.remove("highlight"));

    // 중앙 두 줄 강조
    if (closestIndex >= 0) {
      lineElements[closestIndex].classList.add("highlight");
      if (closestIndex + 1 < lineElements.length) {
        lineElements[closestIndex + 1].classList.add("highlight");
      }
    }
  }

  // 스크롤 이벤트 등록
  window.addEventListener("scroll", highlightCenterLines);
  // 초기 실행
  highlightCenterLines();
// ---------------------------
    // (추가 3) PC에서 2줄씩 부드럽게 스크롤
    // ---------------------------
    window.addEventListener("wheel", function(e) {
      if (e.ctrlKey) return;

      const firstLine = document.querySelector("#bible-text .line");
      if (!firstLine) return;

      const lineHeight = firstLine.getBoundingClientRect().height;

      e.preventDefault();
      window.scrollBy({
        top: e.deltaY > 0 ? lineHeight * 2 : -lineHeight * 2,
        behavior: "smooth"
      });
    }, { passive: false });
// ---------------------------

      // 폰트 버튼
      upBtn.addEventListener('click', () => {
        const current = parseFloat(getComputedStyle(bibleTextEl).fontSize);
        if (current + 4 <= 80) { bibleTextEl.style.fontSize = (current + 4) + 'px'; updateFontSizeDisplay(); }
      });
      downBtn.addEventListener('click', () => {
        const current = parseFloat(getComputedStyle(bibleTextEl).fontSize);
        if (current - 4 >= 12) { bibleTextEl.style.fontSize = (current - 4) + 'px'; updateFontSizeDisplay(); }
      });

      // 검색 폼
      const searchForm = document.forms.f1;
      searchForm.addEventListener('submit', (e) => { e.preventDefault(); findString(searchForm.t1.value); });
      searchForm.b2.addEventListener('click', () => { clearHighlight(); });

      // nextLocation
      nextLocationBtn.addEventListener('click', nextLocation);

      // 오디오
      playBtn.addEventListener('click', () => { audio.play().catch(()=>{}); });
      pauseBtn.addEventListener('click', () => audio.pause());
      stopBtn.addEventListener('click', () => { audio.pause(); audio.currentTime = 0; });

      speedDown02Btn.addEventListener('click', () => { currentSpeed = Math.max(0.5, currentSpeed - 0.2); updateSpeed(); });
      speedDown01Btn.addEventListener('click', () => { currentSpeed = Math.max(0.5, currentSpeed - 0.1); updateSpeed(); });
      speedUp01Btn.addEventListener('click', () => { currentSpeed = Math.min(2.0, currentSpeed + 0.1); updateSpeed(); });
      speedUp02Btn.addEventListener('click', () => { currentSpeed = Math.min(2.0, currentSpeed + 0.2); updateSpeed(); });
      speedResetBtn.addEventListener('click', () => { currentSpeed = 1.0; updateSpeed(); });

      volumeSlider.addEventListener('input', () => { audio.volume = Number(volumeSlider.value); });
      muteBtn.addEventListener('click', () => { isMuted = !isMuted; audio.muted = isMuted; muteBtn.textContent = isMuted ? '🔇' : '🔊'; });

      // progress bar updates
      audio.addEventListener('timeupdate', () => {
        if (!isFinite(audio.duration) || audio.duration <= 0) return;
        const pct = (audio.currentTime / audio.duration) * 100;
        progressBar.value = pct;
        currentTimeEl.textContent = formatTime(audio.currentTime);
        remainingTimeEl.textContent = '-' + formatTime(audio.duration - audio.currentTime);
      }, { passive: true });

      audio.addEventListener('loadedmetadata', () => {
        currentTimeEl.textContent = '0:00';
        remainingTimeEl.textContent = '-' + formatTime(audio.duration || 0);
      });

      progressBar.addEventListener('input', () => {
        if (!isFinite(audio.duration) || audio.duration <= 0) return;
        const pct = progressBar.value / 100;
        audio.currentTime = audio.duration * pct;
      }, { passive: true });

      rewindBtn.addEventListener('click', () => {
        audio.currentTime = Math.max(0, audio.currentTime - 10);
      });

      forwardBtn.addEventListener('click', () => {
        if (isFinite(audio.duration)) {
          audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
        }
      });

      // 설명 버튼(책) - 클릭시 서브버튼 토글
      // iOS에서 선택이 사라지는 문제를 피하기 위해 클릭/터치 이전 선택영역을 저장하고, 토글 후 복원
      explanationIconButton.addEventListener('pointerdown', (ev) => {
        // pointerdown에서 기본 동작을 방지하면 iOS가 선택을 잃지 않는 경우가 있지만, 안전하게 클론을 저장
        const sel = window.getSelection();
        try {
          if (sel && sel.rangeCount > 0) selectionRange = sel.getRangeAt(0).cloneRange();
        } catch(e) {
          selectionRange = null;
        }
      }, { passive: true });

      explanationIconButton.addEventListener('click', (ev) => {
        ev.stopPropagation();
        // 토글하기 전에 현재 선택을 저장(안전)
        const sel = window.getSelection();
        try { if (sel && sel.rangeCount > 0) selectionRange = sel.getRangeAt(0).cloneRange(); } catch(e){ selectionRange = null; }
        explanationButtonWrapper.classList.toggle('active');

        // 토글 후 약간 뒤에 선택 복원 (iOS에서 클릭으로 인해 사라졌다면 복원)
        setTimeout(() => {
          if (selectionRange) {
            const sel2 = window.getSelection();
            sel2.removeAllRanges();
            try { sel2.addRange(selectionRange); } catch(e){ /* ignore */ }
            // update selectedVerse accordingly
            updateSelectedVerseFromRange(selectionRange);
          }
        }, 60);
      });

      // 책 버튼 외부 클릭으로 닫기
      document.body.addEventListener('click', (ev) => {
        if (!explanationButtonWrapper.contains(ev.target)) explanationButtonWrapper.classList.remove('active');
      });

      // 상세/간단 구절설명 버튼 - 클릭시 선택문구 사용
      detailedExplanationButton.addEventListener('click', () => {
        const v = (selectedVerse || '').trim();
        if (!v) { showModal("구절을 먼저 선택하세요","본문에서 구절이나 단어를 드래그하여 선택한 후 다시 버튼을 눌러주세요."); }
        else { fetchExplanation(v, 'detailed'); }
        explanationButtonWrapper.classList.remove('active');
      });
      simpleExplanationButton.addEventListener('click', () => {
        const v = (selectedVerse || '').trim();
        if (!v) { showModal("구절을 먼저 선택하세요","본문에서 구절이나 단어를 드래그하여 선택한 후 다시 버튼을 눌러주세요."); }
        else { fetchExplanation(v, 'simple'); }
        explanationButtonWrapper.classList.remove('active');
      });

      // 본문 요약 버튼 (항상 보이는 위치)
      summarySimpleMain.addEventListener('click', () => {
        const full = getFullBibleText();
        if (!full.trim()) { showModal("본문이 없습니다","요약할 성경 본문이 없습니다."); }
        else { fetchSummary(full, 'simple'); }
      });
      summaryDetailedMain.addEventListener('click', () => {
        const full = getFullBibleText();
        if (!full.trim()) { showModal("본문이 없습니다","요약할 성경 본문이 없습니다."); }
        else { fetchSummary(full, 'detailed'); }
      });

      // 모달 닫기
      closeModalButton.addEventListener('click', () => { modal.style.display = 'none'; });
      window.addEventListener('click', (ev) => { if (ev.target === modal) modal.style.display = 'none'; });

      // 선택 이벤트: 데스크탑 + 모바일 대응 (디바운스)
      const scheduleSelectionUpdate = () => {
        clearTimeout(selectionDebounce);
        selectionDebounce = setTimeout(handleSelectionChange, 160);
      };
      document.addEventListener('mouseup', scheduleSelectionUpdate, { passive:true });
      document.addEventListener('touchend', scheduleSelectionUpdate, { passive:true });
      document.addEventListener('selectionchange', scheduleSelectionUpdate);

      // 초기 speed 표시
      updateSpeed();
    });

    // --------------------------
    // 선택 관리: iOS에서 선택이 사라지는 문제를 보완
    function handleSelectionChange(){
      const sel = window.getSelection();
      if (!sel) return clearSelectionState();
      const text = (sel.toString() || "").trim();
      // 선택이 본문 내에 있는지 체크
      let isInBible = false;
      try {
        if (sel.anchorNode && sel.focusNode) {
          isInBible = bibleTextEl.contains(sel.anchorNode) && bibleTextEl.contains(sel.focusNode);
        }
      } catch(e){ isInBible = false; }

      if (text && isInBible) {
        selectedVerse = text;
        try {
          selectionRange = sel.getRangeAt(0).cloneRange();
        } catch(e){ selectionRange = null; }
        // 버튼 위치 표시
        try {
          const range = sel.getRangeAt(0);
          const rect = range.getBoundingClientRect();
          positionExplanationButton(rect);
        } catch(e){
          // fallback: 고정 위치
          resetExplanationButton();
        }
      } else {
        clearSelectionState();
      }
    }
    function updateSelectedVerseFromRange(range) {
      if (!range) return;
      const txt = (range.toString() || "").trim();
      if (txt) selectedVerse = txt;
      // position button
      try {
        const rect = range.getBoundingClientRect();
        positionExplanationButton(rect);
      } catch(e){ resetExplanationButton(); }
    }
    function clearSelectionState(){
      selectedVerse = "";
      selectionRange = null;
      resetExplanationButton();
    }

    // 버튼 위치 설정: 화면 밖으로 나가지 않도록 하기
    function positionExplanationButton(rect){
      const container = document.getElementById('explanation-button-container');
      const scrollY = window.scrollY || window.pageYOffset;
      const vh = window.innerHeight;
      const containerHeight = container.offsetHeight || 80;
      // 기본 top 계산
      let topPos = rect.bottom + scrollY + 10;
      // 화면 아래로 넘지 않게
      const maxTop = (window.scrollY || window.pageYOffset) + window.innerHeight - containerHeight - 10;
      topPos = Math.min(topPos, maxTop);
      // 화면 위로 넘지 않게
      const minTop = (window.scrollY || window.pageYOffset) + 10;
      topPos = Math.max(topPos, minTop);
      container.style.position = 'absolute';
      container.style.top = topPos + 'px';

      // 좌우
      const screenCenterX = window.innerWidth / 2;
      if (rect.left < screenCenterX) {
        container.style.left = (rect.right) + 'px';
        container.style.transform = 'translateX(10px)';
      } else {
        container.style.left = rect.left + 'px';
        container.style.transform = 'translateX(-100%) translateX(-10px)';
      }
      container.style.display = 'block';
    }
    function resetExplanationButton(){
      const container = document.getElementById('explanation-button-container');
      container.style.position = 'fixed';
      container.style.left = '30%';
      container.style.top = '100px';
      container.style.transform = 'translateX(-50%)';
      // 노출 유지 (기본 상태)
      //container.style.display = 'block';
    }

    // --------------------------
    // 검색 / 하이라이트 / 스크롤 마커
    function findString(searchText){
      clearHighlight();
      if (searchText == null || searchText.trim() === '') { searchCountEl.textContent = ''; nextLocationBtn.style.display = 'none'; return; }
      const escaped = escapeRegExp(searchText.trim());
      const regex = new RegExp(escaped, 'gi');
      const newContent = originalText.replace(regex, (match) => `<span class="search-highlight">${match}</span>`);
      bibleTextEl.innerHTML = newContent;
      foundSentences = Array.from(bibleTextEl.getElementsByClassName('search-highlight'));
      searchCountEl.textContent = `총 ${foundSentences.length}개 검색됨`;
      if (foundSentences.length > 0) {
        currentSearchIndex = 0;
        foundSentences[currentSearchIndex].scrollIntoView({ behavior:'smooth', block:'center' });
        nextLocationBtn.style.display = 'inline-block';
        updateScrollMarkers();
      } else {
        showModal("검색 결과 없음", `"${searchText}"에 대한 검색 결과가 없습니다.`);
        nextLocationBtn.style.display = 'none';
      }
    }
    function nextLocation(){
      if (!foundSentences.length) return;
      currentSearchIndex = (currentSearchIndex + 1) % foundSentences.length;
      foundSentences[currentSearchIndex].scrollIntoView({ behavior:'smooth', block:'center' });
      // 마커 동기화
      updateScrollMarkers();
    }
    function clearHighlight(){
      bibleTextEl.innerHTML = originalText;
      searchCountEl.textContent = '';
      nextLocationBtn.style.display = 'none';
      while (scrollMarkerContainer.firstChild) scrollMarkerContainer.removeChild(scrollMarkerContainer.firstChild);
      foundSentences = [];
      currentSearchIndex = -1;
    }
    function updateScrollMarkers(){
      while (scrollMarkerContainer.firstChild) scrollMarkerContainer.removeChild(scrollMarkerContainer.firstChild);
      const docH = document.documentElement.scrollHeight;
      const vh = window.innerHeight;
      foundSentences.forEach((el, idx) => {
        const marker = document.createElement('div');
        marker.className = 'scroll-marker';
        const topPos = el.getBoundingClientRect().top + window.scrollY;
        const markerPos = Math.min(Math.max((topPos / docH) * vh, 2), vh - 10);
        marker.style.top = markerPos + 'px';
        marker.addEventListener('click', () => { el.scrollIntoView({ behavior:'smooth', block:'center' }); });
        scrollMarkerContainer.appendChild(marker);
      });
    }

    // --------------------------
    // 모달
    function showModal(title, text, imageUrl=null){
      modalTitle.textContent = title || '';
      modalText.innerHTML = (text || '').toString().replace(/\n/g, '<br>');
      if (imageUrl) { modalImage.src = imageUrl; modalImage.style.display = 'block'; } else { modalImage.src=''; modalImage.style.display='none'; }
      modal.style.display = 'block';
      // 선택영역 유지: 모달 열려도 선택 유지하도록 약간의 복원 시도
      setTimeout(() => {
        if (selectionRange) {
          const sel = window.getSelection();
          sel.removeAllRanges();
          try { sel.addRange(selectionRange); } catch(e) { /* ignore */ }
        }
      }, 60);
    }
    function showLoadingModal(isImage=false){
      modalTitle.innerHTML = `<span class="loader"></span> ${isImage ? '그림 생성 중...' : '설명 생성 중...'}`;
      modalText.textContent = '설명을 생성 중입니다. 잠시만 기다려 주세요...';
      modalImage.style.display = 'none';
      modal.style.display = 'block';
    }

    // --------------------------
    // 본문 전체 텍스트 획득 (요약용)
    function getFullBibleText(){
      const tmp = document.createElement('div');
      tmp.innerHTML = originalText;
      return tmp.textContent.replace(/\s+/g,' ').trim();
    }

    // --------------------------
    // 설명/요약 API 호출 (Generative API 호출 핸들러)
    async function callGenerativeAPI(modalTitleText, prompt){
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const payload = { contents: [ { parts: [ { text: prompt } ] } ] };

      let retryCount = 0; const maxRetries = 3;
      let response = null;
      while (retryCount < maxRetries) {
        try {
          response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (response.ok) break;
          if (response.status === 429) { retryCount++; const delay = Math.pow(2, retryCount)*1000 + Math.random()*1000; await new Promise(r=>setTimeout(r, delay)); }
          else throw new Error(`API Error: ${response.status} ${response.statusText}`);
        } catch (err) {
          console.error('API call failed:', err);
          showModal("오류 발생", "API 호출 중 오류가 발생했습니다. 다시 시도해 주세요.");
          return;
        }
      }
      if (!response || !response.ok) { showModal("오류", "설명을 불러오는 데 실패했습니다. 잠시 후 다시 시도해 주세요."); return; }

      try {
        const data = await response.json();
        const content = data?.candidates?.[0]?.content?.parts?.[0]?.text || "응답을 가져오지 못했습니다.";
        showModal(modalTitleText, content);
      } catch (err) {
        console.error('Error processing response:', err);
        showModal("오류", "응답을 처리하는 중 오류가 발생했습니다.");
      }
    }

    // fetchExplanation + fetchSummary
    async function fetchExplanation(promptText, type){
      let prompt;
      if (type === 'simple') {
        prompt = `**명령:**당신은 성경 주석가이자 성경 연구자입니다. 사용자가 선택한 성경 용어/구절에 대해 모두 합쳐서 300자에서 500자 사이의 짧고 간결한 설명을 작성해 주세요. 만약에 선택어가 지명이름 또는 사람이름이면 (예: 단, 가나안, 하란, 브니엘, 세겜 등) 지명이면 인물을 검색하고 인물이면 지명을 검색해서 두 가지 다 설명해 주세요. 핵심 내용을 중심으로 요약해 주세요.\n**요청 용어/구절:** "${promptText}"\n**지침(요약):**- 지명/족속/민족: 거주지와 위치 간단 설명(필요하면 지도 언급)\n- 이름(인물): 이름의 뜻/주요활동/간단한 배경\n- 제사 도구/성물 등: 간단한 설명\n- 동물/식물/광물: 성경적 의미 간단 설명\n- 비교 가능한 개념(선택적): 핵심 비교 항목 간단 나열`;
      } else {
        prompt = `**명령:**당신은 성경 주석가이자 성경 연구자입니다. 선택된 성경 본문을 **학문적·신학적·역사적·시대적 배경**에서 종합적으로 분석해 주세요.  
본문의 **주요 주제, 핵심 의미, 교훈**을 깊이 있게 설명하고, 본문과 관련된 **등장인물, 사건, 장소**의 역할과 신학적 의미를 포함해 주세요.  

또한 본문이 성경 전체 맥락에서 어떻게 연결되는지 비교와 해석을 통해 보여 주세요.  
예를 들어, 아래와 같은 비교·연결 사항이 포함된다면 자세히 설명해 주세요:  
- 은혜언약과 행위언약의 구분  
- 창세기의 네 사건(창조, 타락, 홍수, 바벨탑)에서 나타난 죄와 벌  
- 노아 이후 네 족장(아브라함, 이삭, 야곱, 요셉)의 믿음과 행위 비교  
- 애굽의 열 가지 재앙  
- 이스라엘 지파별 축복과 땅 분배  
- 제사법, 제물의 의미, 제사 도구·성물·기구의 사용 목적과 상징성  
- 십계명의 신학적 의미  
- 출애굽·광야 시대의 죄와 심판 사례  
- 사사시대 사사들의 특징 비교  
- 통일왕국·분열왕국 시대의 왕들의 잘못·축복·특징 비교  
- 선지서에 기록된 선지자의 사역과 예언  
- 성전(솔로몬 성전, 스룹바벨 성전, 헤롯 성전)의 비교, 건축과 파괴의 의미  
- 길이·무게·화폐 단위 비교  
- 신약시대 왕들의 특징 비교  
- 예수님의 기적과 그 의미  
- 바리새파·사두개파·에세네파의 차이  
- 열두 사도의 특징과 사역 비교  
- 사도행전의 세 차례 선교여행과 교회들  
- 요한계시록의 상징, 교회들, 종말론적 의미  

가능하다면, **표 형식**으로 사건이나 인물, 지리적 배경을 정리해 주어 이해를 돕게 해 주세요.  

또한 성경 본문과 같은 시대에 있었던 **다른 국가, 민족, 문화의 역사적 상황**을 알려 주어 배경 이해를 풍부하게 해 주세요.  

**지침:**  
A. 지명·족속·민족·나라 → 지리적 위치, 역사적 배경, 성경 관련 사건  
B. 인물 → 이름의 뜻, 주요 사건, 활동 지역, 신학적 의미  
C. 제사 도구·성물 → 사용 목적 및 신학적 의미  
D. 동물·식물 → 성경적 상징성  

**출력 조건:**  
- 한국어로 작성  
- 글자 수 2,000자~3,000자 사이  
- 선택된 성경 본문을 본격적으로 요약 및 해설  

선택된 성경 본문: "${promptText}"`;
      }
      showLoadingModal(false);
      await callGenerativeAPI('구절 설명', prompt);
    }

    async function fetchSummary(fullText, type){
      let prompt;
      if (type === 'simple') {
        prompt = `당신은 성경 주석가이자 성경 연구자입니다. 성경 본문 전체를 학문적·신학적·시대적 배경에서 분석하여, 핵심 주제와 메시지를 모두 합쳐서 300자에서 500자 사이로 간단하게 요약해 주세요. 불필요한 장황한 설명은 피하고 핵심 의미와 교훈에 집중하세요.\n선택된 성경 본문: "${fullText}"`;
      } else {
        prompt = `당신은 성경 주석가이자 성경 연구자입니다.  
선택된 성경 본문을 **학문적·신학적·역사적·시대적 배경**에서 종합적으로 분석해 주세요.  
본문의 **주요 주제, 핵심 의미, 교훈**을 깊이 있게 설명하고, 본문과 관련된 **등장인물, 사건, 장소**의 역할과 신학적 의미를 포함해 주세요.  

또한 본문이 성경 전체 맥락에서 어떻게 연결되는지 비교와 해석을 통해 보여 주세요.  
예를 들어, 아래와 같은 비교·연결 사항이 포함된다면 자세히 설명해 주세요:  
- 은혜언약과 행위언약의 구분  
- 창세기의 네 사건(창조, 타락, 홍수, 바벨탑)에서 나타난 죄와 벌  
- 노아 이후 네 족장(아브라함, 이삭, 야곱, 요셉)의 믿음과 행위 비교  
- 애굽의 열 가지 재앙  
- 이스라엘 지파별 축복과 땅 분배  
- 제사법, 제물의 의미, 제사 도구·성물·기구의 사용 목적과 상징성  
- 십계명의 신학적 의미  
- 출애굽·광야 시대의 죄와 심판 사례  
- 사사시대 사사들의 특징 비교  
- 통일왕국·분열왕국 시대의 왕들의 잘못·축복·특징 비교  
- 선지서에 기록된 선지자의 사역과 예언  
- 성전(솔로몬 성전, 스룹바벨 성전, 헤롯 성전)의 비교, 건축과 파괴의 의미  
- 길이·무게·화폐 단위 비교  
- 신약시대 왕들의 특징 비교  
- 예수님의 기적과 그 의미  
- 바리새파·사두개파·에세네파의 차이  
- 열두 사도의 특징과 사역 비교  
- 사도행전의 세 차례 선교여행과 교회들  
- 요한계시록의 상징, 교회들, 종말론적 의미  

가능하다면, **표 형식**으로 사건이나 인물, 지리적 배경을 정리해 주어 이해를 돕게 해 주세요.  

또한 성경 본문과 같은 시대에 있었던 **다른 국가, 민족, 문화의 역사적 상황**을 알려 주어 배경 이해를 풍부하게 해 주세요.  

**지침:**  
A. 지명·족속·민족·나라 → 지리적 위치, 역사적 배경, 성경 관련 사건  
B. 인물 → 이름의 뜻, 주요 사건, 활동 지역, 신학적 의미  
C. 제사 도구·성물 → 사용 목적 및 신학적 의미  
D. 동물·식물 → 성경적 상징성  

**출력 조건:**  
- 한국어로 작성  
- 글자 수 2,500자~3,500자 사이  
- 선택된 성경 본문을 본격적으로 요약 및 해설  

선택된 성경 본문: "${fullText}"`;
      }

      showLoadingModal(false);
      await callGenerativeAPI('본문 요약', prompt);
    }

    // --------------------------
    // updateSpeed
    function updateSpeed(){ audio.playbackRate = currentSpeed; speedDisplay.textContent = currentSpeed.toFixed(1) + 'x'; }

    // --------------------------
    // 선택관련 helper (외부에서 range 직접 설정 등)
    // selectionRange는 이미 클론된 Range를 보유하거나 null
    // handleSelectionChange()에서 selectedVerse 업데이트

    // --------------------------
    // selection 유지 보장: 유저가 터치/클릭 후 선택이 사라지는 경우, 이전에 저장된 selectionRange를 복원 시도
    // 이 파일에서 selectionRange는 선택 직후 저장되며, 버튼 클릭 등으로 선택이 사라지면 복원 시도함.

    // --------------------------
    // 추가 유틸 (폰트 표시)
    function updateFontSizeDisplay(){
      const cur = parseFloat(getComputedStyle(bibleTextEl).fontSize);
      fontSizeEl.textContent = Math.round(cur);
    }

    // --------------------------
    // 안전한 context: window 전역에서 사용할 수 있도록 일부 함수 노출 (선택사항)
    window.findString = findString;
    window.nextLocation = nextLocation;

    // --------------------------
    // --- ✅ 새 토글 버튼 로직 ---
  const progressContainer = document.querySelector('.progress-container');
  const speedControls = document.querySelector('.speed-controls');
  const volumeControl = document.querySelector('.volume-control');
  const showProgressBtn = document.getElementById('show-progress');
  const showSpeedBtn = document.getElementById('show-speed');
  const showVolumeBtn = document.getElementById('show-volume');

  let hideTimeout;

  function showOnly(target) {
    progressContainer.style.display = "none";
    speedControls.style.display = "none";
    volumeControl.style.display = "none";

    target.style.display = "flex";

    if (hideTimeout) clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      target.style.display = "none";
    }, 10000);
  }

  showProgressBtn.addEventListener('click', () => showOnly(progressContainer));
  showSpeedBtn.addEventListener('click', () => showOnly(speedControls));
  showVolumeBtn.addEventListener('click', () => showOnly(volumeControl));
  </script>
</body>
</html>
