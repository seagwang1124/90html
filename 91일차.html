<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>í†µí°í†µë…-21ì¼ì°¨</title>
  <link rel="apple-touch-icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
  <meta name="apple-mobile-web-app-title" content="í†µí°í†µë…">
  <link rel="shortcut icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
  <link rel="mask-icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">

  <style>
    /* ---------------------------
       ì „ì²´ ìŠ¤íƒ€ì¼ (ì› ë””ìì¸ ìœ ì§€)
       --------------------------- */
    :root{
      --blue:#007BFF;
      --pink:#ff99cc;
      --shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html,body { height:100%; margin:0; padding:0; font-family: Arial, sans-serif; -webkit-font-smoothing:antialiased; }
    body { padding-top:150px; background:#fff; color:#000; }

    a:link { color:#0000FF; } a:visited{ color:#660099; }

    /* ìƒë‹¨ ê³ ì • í…Œì´ë¸” */
    .top-fixed-table {
      position: fixed; top:0; left:0; width:100%; background:transparent; border-bottom:none; z-index:100;
      table-layout: fixed; padding:10px 0; box-sizing:border-box;
    }
    .search-cell { text-align:left; padding-left:10px; vertical-align:top; width:30%; }
    .search-cell input[type="text"]{ width:50%; font-size:12pt; }
    .search-cell input[type="submit"], .search-cell input[type="reset"]{ font-size:10pt; padding:5px 8px; height:auto; }

    .audio-cell { text-align:right; padding-right:50px; vertical-align:top; width:30%; }
    #custom-audio-player { display:flex; flex-direction:column; align-items:center; }
    .player-controls{ display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:5px; }
    .time-display{ font-size:16px; font-weight:bold; color:black; margin:0 5px; min-width:44px; text-align:center; }

    .progress-container { display: flex; align-items: center; justify-content: center; gap: 6px; margin: 6px 0; }
    .skip-btn { width: 48px; height: 28px; font-size: 13px; cursor: pointer; border: 1px solid #ccc; border-radius: 5px; background: #fff; }
    .skip-btn:hover { background: #e0e0e0; }

    .control-btn{ width:28px; height:28px; font-size:14px; cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:5px; }
    .control-btn:hover{ background:#e0e0e0; }
    #play-btn{ background:#d1f3d4; } #pause-btn{ background:#fff6d6; } #stop-btn{ background:#fddddd; }

    .speed-controls{ display:flex; align-items:center; justify-content:center; gap:5px; margin-bottom:5px; }
    .speed-btn{ width:21px; height:21px; font-size:10px; cursor:pointer; border:1px solid #ccc; border-radius:3px; background:#fff; }
    .speed-btn:hover{ background:#e0e0e0; }
    .speed-display{ font-weight:bold; color:var(--blue); width:50px; text-align:center; }

    .volume-control{ display:flex; align-items:center; justify-content:center; gap:5px; }
    input[type="range"]{ -webkit-appearance:none; width:160px; height:5px; background:#d3d3d3; outline:none; opacity:0.9; transition:opacity .2s; border-radius:3px;}
    input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:15px; height:15px; background:var(--blue); border-radius:50%; cursor:pointer; }

    /* progress */
    #progress-bar { width: 60%; max-width: 100px; }

    /* volume */
    #volume-slider { width: 80%; max-width: 120px; }

    /* ì„¤ëª… ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (í”Œë¡œíŒ…) */
    .explanation-button-container{ position:fixed; top:100px; left:30%; transform:translateX(-50%); z-index:100; display:block; padding:0 10px; transition:top .2s ease,left .2s ease,transform .2s ease; }
    .explanation-button-wrapper{ position:relative; display:inline-block; cursor:pointer; }
    .explanation-icon-button{ width:50px; height:50px; border-radius:50%; background:var(--pink); box-shadow:var(--shadow); border:none; display:flex; align-items:center; justify-content:center; font-size:40px; z-index:2; }
    .explanation-sub-buttons{ display:flex; flex-direction:column; gap:10px; opacity:0; visibility:hidden; transition:opacity .3s ease,visibility .3s ease, transform .3s ease; position:absolute; left:45%; transform:translateX(-50%) translateY(25px); z-index:1; }
    .explanation-button-wrapper.active .explanation-sub-buttons{ opacity:1; visibility:visible; transform:translateX(-50%) translateY(0); }
    .explanation-sub-button{ padding:5px 10px; font-size:18px; background:var(--pink); border:none; border-radius:5px; cursor:pointer; box-shadow:var(--shadow); white-space:nowrap; }
    .explanation-sub-button:hover{ transform:scale(1.03); }

    /* í°íŠ¸ ì‚¬ì´ì¦ˆ ë° ë³¸ë¬¸ ìš”ì•½ ë²„íŠ¼ (í•­ìƒ í‘œì‹œ) */
    .container{ width:100%; text-align:center; margin-top:8px; }
    .font-size-label{ font-size:20px !important; margin-right:12px; font-weight:bold; color:blue; display:inline-block; vertical-align:middle; }
    #font-size{ font-size:20px !important; margin:0 8px; font-weight:bold; color:red; display:inline-block; vertical-align:middle; width:48px; }
    #down,#up{ width:27px; height:27px; font-size:20px; color:red; background:#fff; border:1px solid #ccc; border-radius:5px; cursor:pointer; display:inline-block; vertical-align:middle; }

    /* ë³¸ë¬¸ ìš”ì•½ ë²„íŠ¼ - í•­ìƒ ë…¸ì¶œ (ìš”êµ¬ì‚¬í•­) */
    .summary-buttons { display:inline-block; margin-left:16px; vertical-align:middle; }
    .summary-btn { padding:6px 10px; margin-left:6px; font-size:14px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .summary-btn:hover{ background:#f2f2f2; }

    /* ë³¸ë¬¸ */
    h2{ padding:0; text-align:left; margin-left:15px; margin-right:15px; }
    p{ display:inline-block; }

    /* ëª¨ë‹¬ */
    .modal{ display:none; position:fixed; z-index:200; inset:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.4); }
    .modal-content{ background:#fff; margin:12% auto; padding:20px; border-radius:10px; width:80%; max-width:900px; box-shadow:0 4px 8px rgba(0,0,0,0.2); text-align:left; line-height:1.6; word-break:keep-all; white-space:pre-wrap; }
    .close-button{ color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
    .close-button:hover{ color:#000; }
    #modal-image{ max-width:100%; height:auto; margin-bottom:12px; display:none; border-radius:8px; }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .loader{ border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-right:8px; }
    @keyframes spin{ 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

    /* ìŠ¤í¬ë¡¤ ë§ˆì»¤ */
    .search-highlight{ background:yellow; color:#000; }
    .scroll-marker-container{ position:fixed; top:0; right:0; width:8px; height:100vh; z-index:99; pointer-events:none; }
    .scroll-marker{ position:absolute; right:0; width:8px; height:8px; background:red; border-radius:50%; box-shadow:0 0 5px rgba(255,0,0,0.7); cursor:pointer; pointer-events:auto; }
    .scroll-marker:hover{ transform:scale(1.5); transition:transform .2s ease; }

    /* ì„ íƒ ê´€ë ¨ (iOS) */
    #bible-text{ -webkit-user-select:text; user-select:text; -webkit-touch-callout:none; }

    /* ë°˜ì‘í˜• ë³´ì™„ */
    @media (max-width:800px){
      .search-cell{ width:55%; } .audio-cell{ width:45%; } .search-cell input[type="text"]{ width:60%; } #progress-bar{ width:160px; }
    }
    @media (max-width:600px){
      .search-cell input[type="text"]{ width:68%; font-size:11pt; } .time-display{ font-size:13px; } #progress-bar{ width:140px; }
      .explanation-sub-button{ font-size:16px; padding:6px 8px; }
      .explanation-icon-button{ width:46px; height:46px; font-size:34px; }
      .summary-btn{ padding:5px 8px; font-size:13px; }
    }

     /* --- ìƒˆ ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ --- */
    .toggle-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .toggle-buttons button {
      padding: 4px 8px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #fff;
      cursor: pointer;
    }
    .toggle-buttons button:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨: ê²€ìƒ‰ + ì˜¤ë””ì˜¤ -->
  <table class="top-fixed-table" id="main-table" cellpadding="0" cellspacing="0">
    <tr>
      <td class="search-cell">
        <form name="f1" action="">
          <input type="reset" name="b2" value="X">
          <input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" name="t1" value="">
          <input type="submit" name="b1" value="ê²€ìƒ‰">
          <div id="search-count-container">
            <span id="search-count"></span>
            <button type="button" id="next-location-btn" style="display:none;">ë‹¤ìŒ ìœ„ì¹˜</button>
          </div>
        </form>
      </td>
      
       <td class="audio-cell">
        <div id="custom-audio-player" role="region" aria-label="ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´">
          <audio id="audio-file" preload="auto" playsinline>
            <source src="https://vod47.anyline.co.kr/vod_ezra/%EC%9D%BD%EA%B8%B0%2021.mp3" type="audio/mpeg">
            ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ ìš”ì†Œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </audio>

          <!-- ê¸°ë³¸ ì»¨íŠ¸ë¡¤ -->
          <div class="player-controls">
            <strong><span style="font-size:16px; background-color: #fcfcfc;" id="current-time" class="time-display">0:00</span></strong>
            <button id="play-btn" class="control-btn" aria-label="ì¬ìƒ">â–¶</button>
            <button id="pause-btn" class="control-btn" aria-label="ì¼ì‹œì •ì§€">â¸</button>
            <button id="stop-btn" class="control-btn" aria-label="ì •ì§€">â– </button>
            <strong><span style="font-size:16px; background-color: #fcfcfc;" id="remaining-time" class="time-display">0:00</span></strong>
          </div>

          <!-- âœ… ìƒˆ ë²„íŠ¼ ê·¸ë£¹ -->
          <div class="toggle-buttons">
            <button id="show-progress">ì¬ìƒ ìœ„ì¹˜</button>
            <button id="show-speed">ì¬ìƒ ì†ë„</button>
            <button id="show-volume">ë³¼ë¥¨ ì¡°ì ˆ</button>
          </div>

          <!-- ê¸°ë³¸ì€ ìˆ¨ê¹€ -->
          <div class="progress-container" style="display:none;">
            <button id="rewind-10" class="skip-btn">âª10s</button>
            <input type="range" id="progress-bar" min="0" max="100" value="0" step="0.01" aria-label="ì¬ìƒ ìœ„ì¹˜">
            <button id="forward-10" class="skip-btn">10sâ©</button>
          </div>

          <div class="speed-controls" style="display:none;">
            <button id="speed-down-02" class="speed-btn">&laquo;</button>
            <button id="speed-down-01" class="speed-btn">&lt;</button>
            <span id="speed-display" class="speed-display">1.0x</span>
            <button id="speed-up-01" class="speed-btn">&gt;</button>
            <button id="speed-up-02" class="speed-btn">&raquo;</button>
            <button id="speed-reset">1.0</button>
          </div>

          <div class="volume-control" style="display:none;">
            <span style="font-size:14px;">ë³¼ë¥¨</span>
            <button id="mute-btn">ğŸ”Š</button>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
          </div>
        </div>
      </td>
    </tr>
  </table>

  <!-- í”Œë¡œíŒ… ì±… ë²„íŠ¼ (êµ¬ì ˆì„¤ëª… í† ê¸€) -->
  <div class="explanation-button-container" id="explanation-button-container">
    <div class="explanation-button-wrapper" id="explanation-button-wrapper">
      <button class="explanation-icon-button" id="explanation-icon-button" aria-label="êµ¬ì ˆì„¤ëª… ì—´ê¸°">
        <span>ğŸ“–</span>
      </button>
      <div class="explanation-sub-buttons" id="explanation-sub-buttons" role="menu">
        <button class="explanation-sub-button" id="detailed-explanation-button">ìƒì„¸ êµ¬ì ˆì„¤ëª…</button>
        <button class="explanation-sub-button" id="simple-explanation-button">ê°„ë‹¨ êµ¬ì ˆì„¤ëª…</button>
      </div>
    </div>
  </div>

  <!-- í°íŠ¸ í¬ê¸° + í•­ìƒ í‘œì‹œë˜ëŠ” ë³¸ë¬¸ ìš”ì•½ ë²„íŠ¼ -->
  <div class="container" style="margin-top:6px;">
    <p class="font-size-label">Font Size</p>
    <button id="down">-</button>
    <p id="font-size">20</p>
    <button id="up">+</button>

    <span class="summary-buttons" aria-hidden="false">
      <button class="summary-btn" id="summary-simple-main">ë³¸ë¬¸ìš”ì•½ ê°„ë‹¨</button>
      <button class="summary-btn" id="summary-detailed-main">ë³¸ë¬¸ìš”ì•½ ìƒì„¸</button>
    </span>
  </div>

  <!-- ë³¸ë¬¸ (ì›ë¬¸ ìœ ì§€: <br></br> í¬í•¨) -->
  <div>
    <h2 id="bible-text" style="line-height:1.2em;margin-left:15px;margin-right:15px;font-style:normal;font-weight:normal;color:black;font-size:20px;word-break:break-all;">
     <strong>

í†µë… 21ì¼ì°¨
<br>ë²”ìœ„: ì‚¼ìƒ26- 31ì¥/ ì‚¼í•˜1ì¥/ ì‹œ18/ ì‚¼í•˜2- 7ì¥</br></strong>
<br>&nbsp;</br>
<strong><br><font color="#4682b4">ì‚¬ë¬´ì—˜ìƒ 26ì¥- 31ì¥</font></br></strong>
  
  <strong><br><font color="#4682b4">ì‚¬ë¬´ì—˜ìƒ 26 ì¥</font></br></strong>
<br><i><font color="#808080">*ë‹¤ìœ—ì´ ë˜ ì‚¬ìš¸ì„ ì‚´ë ¤ ì£¼ë‹¤*</font></i></br>
<br>1 ì‹­ ì‚¬ëŒì´ ê¸°ë¸Œì•„ì— ì™€ì„œ ì‚¬ìš¸ì—ê²Œ ë§í•˜ì—¬ ì´ë¥´ë˜ ë‹¤ìœ—ì´ ê´‘ì•¼ ì• í•˜ê¸¸ë¼ ì‚°ì— ìˆ¨ì§€ ì•„ë‹ˆí•˜ì˜€ë‚˜ì´ê¹Œ í•˜ë§¤</br>
<br>2 ì‚¬ìš¸ì´ ì¼ì–´ë‚˜ ì‹­ ê´‘ì•¼ì—ì„œ ë‹¤ìœ—ì„ ì°¾ìœ¼ë ¤ê³  ì´ìŠ¤ë¼ì—˜ì—ì„œ íƒí•œ ì‚¬ëŒ ì‚¼ì²œ ëª…ê³¼ í•¨ê»˜ ì‹­ ê´‘ì•¼ë¡œ ë‚´ë ¤ê°€ì„œ</br>
<br>3 ì‚¬ìš¸ì´ ê´‘ì•¼ ì• í•˜ê¸¸ë¼ ì‚° ê¸¸ ê°€ì— ì§„ ì¹˜ë‹ˆë¼ ë‹¤ìœ—ì´ ê´‘ì•¼ì— ìˆë”ë‹ˆ ì‚¬ìš¸ì´ ìê¸°ë¥¼ ë”°ë¼ ê´‘ì•¼ë¡œ ë“¤ì–´ì˜´ì„ ì•Œê³ </br>
<br>4 ì´ì— ë‹¤ìœ—ì´ ì •íƒê¾¼ì„ ë³´ë‚´ì–´ ì‚¬ìš¸ì´ ê³¼ì—° ì´ë¥¸ ì¤„ ì•Œê³ </br>
<br>5 ë‹¤ìœ—ì´ ì¼ì–´ë‚˜ ì‚¬ìš¸ì´ ì§„ ì¹œ ê³³ì— ì´ë¥´ëŸ¬ ì‚¬ìš¸ê³¼ ë„¬ì˜ ì•„ë“¤ êµ°ì‚¬ë ¹ê´€ ì•„ë¸Œë„¬ì´ ë¨¸ë¬´ëŠ” ê³³ì„ ë³¸ì¦‰ ì‚¬ìš¸ì´ ì§„ì˜ ê°€ìš´ë°ì— ëˆ„ì› ê³  ë°±ì„±ì€ ê·¸ë¥¼ ë‘˜ëŸ¬ ì§„ ì³¤ë”ë¼</br>
<br>6 ì´ì— ë‹¤ìœ—ì´ í—· ì‚¬ëŒ ì•„íˆë©œë ‰ê³¼ ìŠ¤ë£¨ì•¼ì˜ ì•„ë“¤ ìš”ì••ì˜ ì•„ìš° ì•„ë¹„ìƒˆì—ê²Œ ë¬¼ì–´ ì´ë¥´ë˜ ëˆ„ê°€ ë‚˜ì™€ ë”ë¶ˆì–´ ì§„ì˜ì— ë‚´ë ¤ê°€ì„œ ì‚¬ìš¸ì—ê²Œ ì´ë¥´ê² ëŠëƒ í•˜ë‹ˆ ì•„ë¹„ìƒˆê°€ ì´ë¥´ë˜ ë‚´ê°€ í•¨ê»˜ ê°€ê² ë‚˜ì´ë‹¤</br>
<br>7 ë‹¤ìœ—ê³¼ ì•„ë¹„ìƒˆê°€ ë°¤ì— ê·¸ ë°±ì„±ì—ê²Œ ë‚˜ì•„ê°€ ë³¸ì¦‰ ì‚¬ìš¸ì´ ì§„ì˜ ê°€ìš´ë° ëˆ„ì›Œ ìê³  ì°½ì€ ë¨¸ë¦¬ ê³ ë•…ì— ê½‚í˜€ ìˆê³  ì•„ë¸Œë„¬ê³¼ ë°±ì„±ë“¤ì€ ê·¸ë¥¼ ë‘˜ëŸ¬ ëˆ„ì› ëŠ”ì§€ë¼</br>
<br>8 ì•„ë¹„ìƒˆê°€ ë‹¤ìœ—ì—ê²Œ ì´ë¥´ë˜ í•˜ë‚˜ë‹˜ì´ ì˜¤ëŠ˜ ë‹¹ì‹ ì˜ ì›ìˆ˜ë¥¼ ë‹¹ì‹ ì˜ ì†ì— ë„˜ê¸°ì…¨ë‚˜ì´ë‹¤ ê·¸ëŸ¬ë¯€ë¡œ ì²­í•˜ì˜¤ë‹ˆ ë‚´ê°€ ì°½ìœ¼ë¡œ ê·¸ë¥¼ ì°”ëŸ¬ì„œ ë‹¨ë²ˆì— ë•…ì— ê½‚ê²Œ í•˜ì†Œì„œ ë‚´ê°€ ê·¸ë¥¼ ë‘ ë²ˆ ì°Œë¥¼ ê²ƒì´ ì—†ìœ¼ë¦¬ì´ë‹¤ í•˜ë‹ˆ</br>
<br>9 ë‹¤ìœ—ì´ ì•„ë¹„ìƒˆì—ê²Œ ì´ë¥´ë˜ ì£½ì´ì§€ ë§ë¼ ëˆ„êµ¬ë“ ì§€ ì†ì„ ë“¤ì–´ ì—¬í˜¸ì™€ì˜ ê¸°ë¦„ ë¶€ìŒ ë°›ì€ ìë¥¼ ì¹˜ë©´ ì£„ê°€ ì—†ê² ëŠëƒ í•˜ê³ </br>
<br>10 ë‹¤ìœ—ì´ ë˜ ì´ë¥´ë˜ ì—¬í˜¸ì™€ê»˜ì„œ ì‚´ì•„ ê³„ì‹¬ì„ ë‘ê³  ë§¹ì„¸í•˜ë…¸ë‹ˆ ì—¬í˜¸ì™€ê»˜ì„œ ê·¸ë¥¼ ì¹˜ì‹œë¦¬ë‹ˆ í˜¹ì€ ì£½ì„ ë‚ ì´ ì´ë¥´ê±°ë‚˜ ë˜ëŠ” ì „ì¥ì— ë‚˜ê°€ì„œ ë§í•˜ë¦¬ë¼</br>
<br>11 ë‚´ê°€ ì†ì„ ë“¤ì–´ ì—¬í˜¸ì™€ì˜ ê¸°ë¦„ ë¶€ìŒ ë°›ì€ ìë¥¼ ì¹˜ëŠ” ê²ƒì„ ì—¬í˜¸ì™€ê»˜ì„œ ê¸ˆí•˜ì‹œë‚˜ë‹ˆ ë„ˆëŠ” ê·¸ì˜ ë¨¸ë¦¬ ê³ì— ìˆëŠ” ì°½ê³¼ ë¬¼ë³‘ë§Œ ê°€ì§€ê³  ê°€ì í•˜ê³ </br>
<br>12 ë‹¤ìœ—ì´ ì‚¬ìš¸ì˜ ë¨¸ë¦¬ ê³ì—ì„œ ì°½ê³¼ ë¬¼ë³‘ì„ ê°€ì§€ê³  ë– ë‚˜ê°€ë˜ ì•„ë¬´ë„ ë³´ê±°ë‚˜ ëˆˆì¹˜ ì±„ì§€ ëª»í•˜ê³  ê¹¨ì–´ ìˆëŠ” ì‚¬ëŒë„ ì—†ì—ˆìœ¼ë‹ˆ ì´ëŠ” ì—¬í˜¸ì™€ê»˜ì„œ ê·¸ë“¤ì„ ê¹Šì´ ì ë“¤ê²Œ í•˜ì…¨ìœ¼ë¯€ë¡œ ê·¸ë“¤ì´ ë‹¤ ì ë“¤ì–´ ìˆì—ˆê¸° ë•Œë¬¸ì´ì—ˆë”ë¼</br>
<br>13 ì´ì— ë‹¤ìœ—ì´ ê±´ë„ˆí¸ìœ¼ë¡œ ê°€ì„œ ë©€ë¦¬ ì‚° ê¼­ëŒ€ê¸°ì— ì„œë‹ˆ ê±°ë¦¬ê°€ ë©€ë”ë¼</br>
<br>14 ë‹¤ìœ—ì´ ë°±ì„±ê³¼ ë„¬ì˜ ì•„ë“¤ ì•„ë¸Œë„¬ì„ ëŒ€í•˜ì—¬ ì™¸ì³ ì´ë¥´ë˜ ì•„ë¸Œë„¬ì•„ ë„ˆëŠ” ëŒ€ë‹µí•˜ì§€ ì•„ë‹ˆí•˜ëŠëƒ í•˜ë‹ˆ ì•„ë¸Œë„¬ì´ ëŒ€ë‹µí•˜ì—¬ ì´ë¥´ë˜ ì™•ì„ ë¶€ë¥´ëŠ” ë„ˆëŠ” ëˆ„êµ¬ëƒ í•˜ë”ë¼</br>
<br>15 ë‹¤ìœ—ì´ ì•„ë¸Œë„¬ì—ê²Œ ì´ë¥´ë˜ ë„¤ê°€ ìš©ì‚¬ê°€ ì•„ë‹ˆëƒ ì´ìŠ¤ë¼ì—˜ ê°€ìš´ë°ì— ë„ˆ ê°™ì€ ìê°€ ëˆ„êµ¬ëƒ ê·¸ëŸ¬í•œë° ë„¤ê°€ ì–´ì°Œí•˜ì—¬ ë„¤ ì£¼ ì™•ì„ ë³´í˜¸í•˜ì§€ ì•„ë‹ˆí•˜ëŠëƒ ë°±ì„± ê°€ìš´ë° í•œ ì‚¬ëŒì´ ë„¤ ì£¼ ì™•ì„ ì£½ì´ë ¤ê³  ë“¤ì–´ê°”ì—ˆëŠë‹ˆë¼</br>
<br>16 ë„¤ê°€ í–‰í•œ ì´ ì¼ì´ ì˜³ì§€ ëª»í•˜ë„ë‹¤ ì—¬í˜¸ì™€ê»˜ì„œ ì‚´ì•„ ê³„ì‹¬ì„ ë‘ê³  ë§¹ì„¸í•˜ë…¸ë‹ˆ ì—¬í˜¸ì™€ì˜ ê¸°ë¦„ ë¶€ìŒ ë°›ì€ ë„ˆí¬ ì£¼ë¥¼ ë³´í˜¸í•˜ì§€ ì•„ë‹ˆí•˜ì˜€ìœ¼ë‹ˆ ë„ˆí¬ëŠ” ë§ˆë•…íˆ ì£½ì„ ìì´ë‹ˆë¼ ì´ì œ ì™•ì˜ ì°½ê³¼ ì™•ì˜ ë¨¸ë¦¬ ê³ì— ìˆë˜ ë¬¼ë³‘ì´ ì–´ë”” ìˆë‚˜ ë³´ë¼ í•˜ë‹ˆ</br>
<br>17 ì‚¬ìš¸ì´ ë‹¤ìœ—ì˜ ìŒì„±ì„ ì•Œì•„ ë“£ê³  ì´ë¥´ë˜ ë‚´ ì•„ë“¤ ë‹¤ìœ—ì•„ ì´ê²ƒì´ ë„¤ ìŒì„±ì´ëƒ í•˜ëŠ”ì§€ë¼ ë‹¤ìœ—ì´ ì´ë¥´ë˜ ë‚´ ì£¼ ì™•ì´ì—¬ ë‚´ ìŒì„±ì´ë‹ˆì´ë‹¤ í•˜ê³ </br>
<br>18 ë˜ ì´ë¥´ë˜ ë‚´ ì£¼ëŠ” ì–´ì°Œí•˜ì—¬ ì£¼ì˜ ì¢…ì„ ì«“ìœ¼ì‹œë‚˜ì´ê¹Œ ë‚´ê°€ ë¬´ì—‡ì„ í•˜ì˜€ìœ¼ë©° ë‚´ ì†ì— ë¬´ìŠ¨ ì•…ì´ ìˆë‚˜ì´ê¹Œ</br>
<br>19 ì›í•˜ê±´ëŒ€ ë‚´ ì£¼ ì™•ì€ ì´ì œ ì¢…ì˜ ë§ì„ ë“¤ìœ¼ì†Œì„œ ë§Œì¼ ì™•ì„ ì¶©ë™ì‹œì¼œ ë‚˜ë¥¼ í•´í•˜ë ¤ í•˜ëŠ” ì´ê°€ ì—¬í˜¸ì™€ì‹œë©´ ì—¬í˜¸ì™€ê»˜ì„œëŠ” ì œë¬¼ì„ ë°›ìœ¼ì‹œê¸°ë¥¼ ì›í•˜ë‚˜ì´ë‹¤ë§ˆëŠ” ë§Œì¼ ì‚¬ëŒë“¤ì´ë©´ ê·¸ë“¤ì´ ì—¬í˜¸ì™€ ì•ì— ì €ì£¼ë¥¼ ë°›ìœ¼ë¦¬ë‹ˆ ì´ëŠ” ê·¸ë“¤ì´ ì´ë¥´ê¸°ë¥¼ ë„ˆëŠ” ê°€ì„œ ë‹¤ë¥¸ ì‹ ë“¤ì„ ì„¬ê¸°ë¼ í•˜ê³  ì˜¤ëŠ˜ ë‚˜ë¥¼ ì«“ì•„ë‚´ì–´ ì—¬í˜¸ì™€ì˜ ê¸°ì—…ì— ì°¸ì—¬í•˜ì§€ ëª»í•˜ê²Œ í•¨ì´ë‹ˆì´ë‹¤</br>
<br>20 ê·¸ëŸ°ì¦‰ ì²­í•˜ê±´ëŒ€ ì—¬í˜¸ì™€ ì•ì—ì„œ ë¨¼ ì´ ê³³ì—ì„œ ì´ì œ ë‚˜ì˜ í”¼ê°€ ë•…ì— íë¥´ì§€ ë§ê²Œ í•˜ì˜µì†Œì„œ ì´ëŠ” ì‚°ì—ì„œ ë©”ì¶”ë¼ê¸°ë¥¼ ì‚¬ëƒ¥í•˜ëŠ” ìì™€ ê°™ì´ ì´ìŠ¤ë¼ì—˜ ì™•ì´ í•œ ë²¼ë£©ì„ ìˆ˜ìƒ‰í•˜ëŸ¬ ë‚˜ì˜¤ì…¨ìŒì´ë‹ˆì´ë‹¤</br>
<br>21 ì‚¬ìš¸ì´ ì´ë¥´ë˜ ë‚´ê°€ ë²”ì£„í•˜ì˜€ë„ë‹¤ ë‚´ ì•„ë“¤ ë‹¤ìœ—ì•„ ëŒì•„ì˜¤ë¼ ë„¤ê°€ ì˜¤ëŠ˜ ë‚´ ìƒëª…ì„ ê·€í•˜ê²Œ ì—¬ê²¼ì€ì¦‰ ë‚´ê°€ ë‹¤ì‹œëŠ” ë„ˆë¥¼ í•´í•˜ë ¤ í•˜ì§€ ì•„ë‹ˆí•˜ë¦¬ë¼ ë‚´ê°€ ì–´ë¦¬ì„ì€ ì¼ì„ í•˜ì˜€ìœ¼ë‹ˆ ëŒ€ë‹¨íˆ ì˜ëª»ë˜ì—ˆë„ë‹¤ í•˜ëŠ”ì§€ë¼</br>
<br>22 ë‹¤ìœ—ì´ ëŒ€ë‹µí•˜ì—¬ ì´ë¥´ë˜ ì™•ì€ ì°½ì„ ë³´ì†Œì„œ í•œ ì†Œë…„ì„ ë³´ë‚´ì–´ ê°€ì ¸ê°€ê²Œ í•˜ì†Œì„œ</br>
<br>23 ì—¬í˜¸ì™€ê»˜ì„œ ì‚¬ëŒì—ê²Œ ê·¸ì˜ ê³µì˜ì™€ ì‹ ì‹¤ì„ ë”°ë¼ ê°šìœ¼ì‹œë¦¬ë‹ˆ ì´ëŠ” ì—¬í˜¸ì™€ê»˜ì„œ ì˜¤ëŠ˜ ì™•ì„ ë‚´ ì†ì— ë„˜ê¸°ì…¨ìœ¼ë˜ ë‚˜ëŠ” ì†ì„ ë“¤ì–´ ì—¬í˜¸ì™€ì˜ ê¸°ë¦„ ë¶€ìŒì„ ë°›ì€ ì ì¹˜ê¸°ë¥¼ ì›í•˜ì§€ ì•„ë‹ˆí•˜ì˜€ìŒì´ë‹ˆì´ë‹¤</br>
<br>24 ì˜¤ëŠ˜ ì™•ì˜ ìƒëª…ì„ ë‚´ê°€ ì¤‘íˆ ì—¬ê¸´ ê²ƒ ê°™ì´ ë‚´ ìƒëª…ì„ ì—¬í˜¸ì™€ê»˜ì„œ ì¤‘íˆ ì—¬ê¸°ì…”ì„œ ëª¨ë“  í™˜ë‚œì—ì„œ ë‚˜ë¥¼ êµ¬í•˜ì—¬ ë‚´ì‹œê¸°ë¥¼ ë°”ë¼ë‚˜ì´ë‹¤ í•˜ë‹ˆë¼</br>
<br>25 ì‚¬ìš¸ì´ ë‹¤ìœ—ì—ê²Œ ì´ë¥´ë˜ ë‚´ ì•„ë“¤ ë‹¤ìœ—ì•„ ë„¤ê²Œ ë³µì´ ìˆì„ì§€ë¡œë‹¤ ë„¤ê°€ í° ì¼ì„ í–‰í•˜ê² ê³  ë°˜ë“œì‹œ ìŠ¹ë¦¬ë¥¼ ì–»ìœ¼ë¦¬ë¼ í•˜ë‹ˆë¼ ë‹¤ìœ—ì€ ìê¸° ê¸¸ë¡œ ê°€ê³  ì‚¬ìš¸ì€ ìê¸° ê³³ìœ¼ë¡œ ëŒì•„ê°€ë‹ˆë¼</br>
<br>&nbsp;</br>
<br>    21ì¼ì°¨ ë</br>
<br>&nbsp;</br>
    </h2>
  </div>

  <!-- ëª¨ë‹¬ (ì„¤ëª…/ìš”ì•½ ì¶œë ¥) -->
  <div id="explanation-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <span class="close-button" id="close-modal" aria-label="ë‹«ê¸°">&times;</span>
      <h3 id="modal-title">êµ¬ì ˆ ì„¤ëª…</h3>
      <img id="modal-image" src="" alt="ì„¤ëª… ê´€ë ¨ ì´ë¯¸ì§€" />
      <div id="modal-text">êµ¬ì ˆì„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•˜ê³  'êµ¬ì ˆì„¤ëª…' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</div>
    </div>
  </div>

  <div id="scroll-marker-container" class="scroll-marker-container" aria-hidden="true"></div>

  <script>
    // ------------------------------
    // API KEY (ì‚¬ìš©ì ì…ë ¥ ìƒíƒœ)
    const apiKey = "AIzaSyDUlSQlSPgnrFBXpnUJMDoUO3s_KsaoFRU";
    // ------------------------------

    // DOM
    const bibleTextEl = document.getElementById('bible-text');
    const searchCountEl = document.getElementById('search-count');
    const nextLocationBtn = document.getElementById('next-location-btn');
    const scrollMarkerContainer = document.getElementById('scroll-marker-container');

    const explanationIconButton = document.getElementById('explanation-icon-button');
    const explanationButtonWrapper = document.getElementById('explanation-button-wrapper');
    const explanationSubButtons = document.getElementById('explanation-sub-buttons');
    const detailedExplanationButton = document.getElementById('detailed-explanation-button');
    const simpleExplanationButton = document.getElementById('simple-explanation-button');

    const summarySimpleMain = document.getElementById('summary-simple-main');
    const summaryDetailedMain = document.getElementById('summary-detailed-main');

    const modal = document.getElementById('explanation-modal');
    const closeModalButton = document.getElementById('close-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalImage = document.getElementById('modal-image');
    const modalText = document.getElementById('modal-text');

    const audio = document.getElementById('audio-file');
    const playBtn = document.getElementById('play-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const progressBar = document.getElementById('progress-bar');
    const rewindBtn = document.getElementById('rewind-10');
    const forwardBtn = document.getElementById('forward-10');
    const speedDisplay = document.getElementById('speed-display');
    const speedDown02Btn = document.getElementById('speed-down-02');
    const speedDown01Btn = document.getElementById('speed-down-01');
    const speedUp01Btn = document.getElementById('speed-up-01');
    const speedUp02Btn = document.getElementById('speed-up-02');
    const speedResetBtn = document.getElementById('speed-reset');
    const volumeSlider = document.getElementById('volume-slider');
    const muteBtn = document.getElementById('mute-btn');
    const currentTimeEl = document.getElementById('current-time');
    const remainingTimeEl = document.getElementById('remaining-time');

    const upBtn = document.getElementById('up');
    const downBtn = document.getElementById('down');
    const fontSizeEl = document.getElementById('font-size');

    // ìƒíƒœ
    let originalText = "";
    let selectedVerse = "";
    let selectionRange = null; // ì„ íƒ ì˜ì—­ ë³µì›ìš©
    let foundSentences = [];
    let currentSearchIndex = -1;
    let currentSpeed = 1.0;
    let isMuted = false;
    let selectionDebounce = null;

    // ìœ í‹¸
    function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function formatTime(sec) { if (!isFinite(sec) || sec < 0) return '0:00'; const m = Math.floor(sec/60); const s = Math.floor(sec%60); return `${m}:${String(s).padStart(2,'0')}`; }

    // ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', () => {
      originalText = bibleTextEl.innerHTML; // ì›ë³¸ ë³´ê´€
      updateFontSizeDisplay();
      updateSpeed();

      // í°íŠ¸ ë²„íŠ¼
      upBtn.addEventListener('click', () => {
        const current = parseFloat(getComputedStyle(bibleTextEl).fontSize);
        if (current + 4 <= 80) { bibleTextEl.style.fontSize = (current + 4) + 'px'; updateFontSizeDisplay(); }
      });
      downBtn.addEventListener('click', () => {
        const current = parseFloat(getComputedStyle(bibleTextEl).fontSize);
        if (current - 4 >= 12) { bibleTextEl.style.fontSize = (current - 4) + 'px'; updateFontSizeDisplay(); }
      });

      // ê²€ìƒ‰ í¼
      const searchForm = document.forms.f1;
      searchForm.addEventListener('submit', (e) => { e.preventDefault(); findString(searchForm.t1.value); });
      searchForm.b2.addEventListener('click', () => { clearHighlight(); });

      // nextLocation
      nextLocationBtn.addEventListener('click', nextLocation);

      // ì˜¤ë””ì˜¤
      playBtn.addEventListener('click', () => { audio.play().catch(()=>{}); });
      pauseBtn.addEventListener('click', () => audio.pause());
      stopBtn.addEventListener('click', () => { audio.pause(); audio.currentTime = 0; });

      speedDown02Btn.addEventListener('click', () => { currentSpeed = Math.max(0.5, currentSpeed - 0.2); updateSpeed(); });
      speedDown01Btn.addEventListener('click', () => { currentSpeed = Math.max(0.5, currentSpeed - 0.1); updateSpeed(); });
      speedUp01Btn.addEventListener('click', () => { currentSpeed = Math.min(2.0, currentSpeed + 0.1); updateSpeed(); });
      speedUp02Btn.addEventListener('click', () => { currentSpeed = Math.min(2.0, currentSpeed + 0.2); updateSpeed(); });
      speedResetBtn.addEventListener('click', () => { currentSpeed = 1.0; updateSpeed(); });

      volumeSlider.addEventListener('input', () => { audio.volume = Number(volumeSlider.value); });
      muteBtn.addEventListener('click', () => { isMuted = !isMuted; audio.muted = isMuted; muteBtn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š'; });

      // progress bar updates
      audio.addEventListener('timeupdate', () => {
        if (!isFinite(audio.duration) || audio.duration <= 0) return;
        const pct = (audio.currentTime / audio.duration) * 100;
        progressBar.value = pct;
        currentTimeEl.textContent = formatTime(audio.currentTime);
        remainingTimeEl.textContent = '-' + formatTime(audio.duration - audio.currentTime);
      }, { passive: true });

      audio.addEventListener('loadedmetadata', () => {
        currentTimeEl.textContent = '0:00';
        remainingTimeEl.textContent = '-' + formatTime(audio.duration || 0);
      });

      progressBar.addEventListener('input', () => {
        if (!isFinite(audio.duration) || audio.duration <= 0) return;
        const pct = progressBar.value / 100;
        audio.currentTime = audio.duration * pct;
      }, { passive: true });

      rewindBtn.addEventListener('click', () => {
        audio.currentTime = Math.max(0, audio.currentTime - 10);
      });

      forwardBtn.addEventListener('click', () => {
        if (isFinite(audio.duration)) {
          audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
        }
      });

      // ì„¤ëª… ë²„íŠ¼(ì±…) - í´ë¦­ì‹œ ì„œë¸Œë²„íŠ¼ í† ê¸€
      // iOSì—ì„œ ì„ íƒì´ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ í´ë¦­/í„°ì¹˜ ì´ì „ ì„ íƒì˜ì—­ì„ ì €ì¥í•˜ê³ , í† ê¸€ í›„ ë³µì›
      explanationIconButton.addEventListener('pointerdown', (ev) => {
        // pointerdownì—ì„œ ê¸°ë³¸ ë™ì‘ì„ ë°©ì§€í•˜ë©´ iOSê°€ ì„ íƒì„ ìƒì§€ ì•ŠëŠ” ê²½ìš°ê°€ ìˆì§€ë§Œ, ì•ˆì „í•˜ê²Œ í´ë¡ ì„ ì €ì¥
        const sel = window.getSelection();
        try {
          if (sel && sel.rangeCount > 0) selectionRange = sel.getRangeAt(0).cloneRange();
        } catch(e) {
          selectionRange = null;
        }
      }, { passive: true });

      explanationIconButton.addEventListener('click', (ev) => {
        ev.stopPropagation();
        // í† ê¸€í•˜ê¸° ì „ì— í˜„ì¬ ì„ íƒì„ ì €ì¥(ì•ˆì „)
        const sel = window.getSelection();
        try { if (sel && sel.rangeCount > 0) selectionRange = sel.getRangeAt(0).cloneRange(); } catch(e){ selectionRange = null; }
        explanationButtonWrapper.classList.toggle('active');

        // í† ê¸€ í›„ ì•½ê°„ ë’¤ì— ì„ íƒ ë³µì› (iOSì—ì„œ í´ë¦­ìœ¼ë¡œ ì¸í•´ ì‚¬ë¼ì¡Œë‹¤ë©´ ë³µì›)
        setTimeout(() => {
          if (selectionRange) {
            const sel2 = window.getSelection();
            sel2.removeAllRanges();
            try { sel2.addRange(selectionRange); } catch(e){ /* ignore */ }
            // update selectedVerse accordingly
            updateSelectedVerseFromRange(selectionRange);
          }
        }, 60);
      });

      // ì±… ë²„íŠ¼ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
      document.body.addEventListener('click', (ev) => {
        if (!explanationButtonWrapper.contains(ev.target)) explanationButtonWrapper.classList.remove('active');
      });

      // ìƒì„¸/ê°„ë‹¨ êµ¬ì ˆì„¤ëª… ë²„íŠ¼ - í´ë¦­ì‹œ ì„ íƒë¬¸êµ¬ ì‚¬ìš©
      detailedExplanationButton.addEventListener('click', () => {
        const v = (selectedVerse || '').trim();
        if (!v) { showModal("êµ¬ì ˆì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”","ë³¸ë¬¸ì—ì„œ êµ¬ì ˆì´ë‚˜ ë‹¨ì–´ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•œ í›„ ë‹¤ì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”."); }
        else { fetchExplanation(v, 'detailed'); }
        explanationButtonWrapper.classList.remove('active');
      });
      simpleExplanationButton.addEventListener('click', () => {
        const v = (selectedVerse || '').trim();
        if (!v) { showModal("êµ¬ì ˆì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”","ë³¸ë¬¸ì—ì„œ êµ¬ì ˆì´ë‚˜ ë‹¨ì–´ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•œ í›„ ë‹¤ì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”."); }
        else { fetchExplanation(v, 'simple'); }
        explanationButtonWrapper.classList.remove('active');
      });

      // ë³¸ë¬¸ ìš”ì•½ ë²„íŠ¼ (í•­ìƒ ë³´ì´ëŠ” ìœ„ì¹˜)
      summarySimpleMain.addEventListener('click', () => {
        const full = getFullBibleText();
        if (!full.trim()) { showModal("ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤","ìš”ì•½í•  ì„±ê²½ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."); }
        else { fetchSummary(full, 'simple'); }
      });
      summaryDetailedMain.addEventListener('click', () => {
        const full = getFullBibleText();
        if (!full.trim()) { showModal("ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤","ìš”ì•½í•  ì„±ê²½ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."); }
        else { fetchSummary(full, 'detailed'); }
      });

      // ëª¨ë‹¬ ë‹«ê¸°
      closeModalButton.addEventListener('click', () => { modal.style.display = 'none'; });
      window.addEventListener('click', (ev) => { if (ev.target === modal) modal.style.display = 'none'; });

      // ì„ íƒ ì´ë²¤íŠ¸: ë°ìŠ¤í¬íƒ‘ + ëª¨ë°”ì¼ ëŒ€ì‘ (ë””ë°”ìš´ìŠ¤)
      const scheduleSelectionUpdate = () => {
        clearTimeout(selectionDebounce);
        selectionDebounce = setTimeout(handleSelectionChange, 160);
      };
      document.addEventListener('mouseup', scheduleSelectionUpdate, { passive:true });
      document.addEventListener('touchend', scheduleSelectionUpdate, { passive:true });
      document.addEventListener('selectionchange', scheduleSelectionUpdate);

      // ì´ˆê¸° speed í‘œì‹œ
      updateSpeed();
    });

    // --------------------------
    // ì„ íƒ ê´€ë¦¬: iOSì—ì„œ ì„ íƒì´ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œë¥¼ ë³´ì™„
    function handleSelectionChange(){
      const sel = window.getSelection();
      if (!sel) return clearSelectionState();
      const text = (sel.toString() || "").trim();
      // ì„ íƒì´ ë³¸ë¬¸ ë‚´ì— ìˆëŠ”ì§€ ì²´í¬
      let isInBible = false;
      try {
        if (sel.anchorNode && sel.focusNode) {
          isInBible = bibleTextEl.contains(sel.anchorNode) && bibleTextEl.contains(sel.focusNode);
        }
      } catch(e){ isInBible = false; }

      if (text && isInBible) {
        selectedVerse = text;
        try {
          selectionRange = sel.getRangeAt(0).cloneRange();
        } catch(e){ selectionRange = null; }
        // ë²„íŠ¼ ìœ„ì¹˜ í‘œì‹œ
        try {
          const range = sel.getRangeAt(0);
          const rect = range.getBoundingClientRect();
          positionExplanationButton(rect);
        } catch(e){
          // fallback: ê³ ì • ìœ„ì¹˜
          resetExplanationButton();
        }
      } else {
        clearSelectionState();
      }
    }
    function updateSelectedVerseFromRange(range) {
      if (!range) return;
      const txt = (range.toString() || "").trim();
      if (txt) selectedVerse = txt;
      // position button
      try {
        const rect = range.getBoundingClientRect();
        positionExplanationButton(rect);
      } catch(e){ resetExplanationButton(); }
    }
    function clearSelectionState(){
      selectedVerse = "";
      selectionRange = null;
      resetExplanationButton();
    }

    // ë²„íŠ¼ ìœ„ì¹˜ ì„¤ì •: í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ í•˜ê¸°
    function positionExplanationButton(rect){
      const container = document.getElementById('explanation-button-container');
      const scrollY = window.scrollY || window.pageYOffset;
      const vh = window.innerHeight;
      const containerHeight = container.offsetHeight || 80;
      // ê¸°ë³¸ top ê³„ì‚°
      let topPos = rect.bottom + scrollY + 10;
      // í™”ë©´ ì•„ë˜ë¡œ ë„˜ì§€ ì•Šê²Œ
      const maxTop = (window.scrollY || window.pageYOffset) + window.innerHeight - containerHeight - 10;
      topPos = Math.min(topPos, maxTop);
      // í™”ë©´ ìœ„ë¡œ ë„˜ì§€ ì•Šê²Œ
      const minTop = (window.scrollY || window.pageYOffset) + 10;
      topPos = Math.max(topPos, minTop);
      container.style.position = 'absolute';
      container.style.top = topPos + 'px';

      // ì¢Œìš°
      const screenCenterX = window.innerWidth / 2;
      if (rect.left < screenCenterX) {
        container.style.left = (rect.right) + 'px';
        container.style.transform = 'translateX(10px)';
      } else {
        container.style.left = rect.left + 'px';
        container.style.transform = 'translateX(-100%) translateX(-10px)';
      }
      container.style.display = 'block';
    }
    function resetExplanationButton(){
      const container = document.getElementById('explanation-button-container');
      container.style.position = 'fixed';
      container.style.left = '30%';
      container.style.top = '100px';
      container.style.transform = 'translateX(-50%)';
      // ë…¸ì¶œ ìœ ì§€ (ê¸°ë³¸ ìƒíƒœ)
      //container.style.display = 'block';
    }

    // --------------------------
    // ê²€ìƒ‰ / í•˜ì´ë¼ì´íŠ¸ / ìŠ¤í¬ë¡¤ ë§ˆì»¤
    function findString(searchText){
      clearHighlight();
      if (searchText == null || searchText.trim() === '') { searchCountEl.textContent = ''; nextLocationBtn.style.display = 'none'; return; }
      const escaped = escapeRegExp(searchText.trim());
      const regex = new RegExp(escaped, 'gi');
      const newContent = originalText.replace(regex, (match) => `<span class="search-highlight">${match}</span>`);
      bibleTextEl.innerHTML = newContent;
      foundSentences = Array.from(bibleTextEl.getElementsByClassName('search-highlight'));
      searchCountEl.textContent = `ì´ ${foundSentences.length}ê°œ ê²€ìƒ‰ë¨`;
      if (foundSentences.length > 0) {
        currentSearchIndex = 0;
        foundSentences[currentSearchIndex].scrollIntoView({ behavior:'smooth', block:'center' });
        nextLocationBtn.style.display = 'inline-block';
        updateScrollMarkers();
      } else {
        showModal("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ", `"${searchText}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        nextLocationBtn.style.display = 'none';
      }
    }
    function nextLocation(){
      if (!foundSentences.length) return;
      currentSearchIndex = (currentSearchIndex + 1) % foundSentences.length;
      foundSentences[currentSearchIndex].scrollIntoView({ behavior:'smooth', block:'center' });
      // ë§ˆì»¤ ë™ê¸°í™”
      updateScrollMarkers();
    }
    function clearHighlight(){
      bibleTextEl.innerHTML = originalText;
      searchCountEl.textContent = '';
      nextLocationBtn.style.display = 'none';
      while (scrollMarkerContainer.firstChild) scrollMarkerContainer.removeChild(scrollMarkerContainer.firstChild);
      foundSentences = [];
      currentSearchIndex = -1;
    }
    function updateScrollMarkers(){
      while (scrollMarkerContainer.firstChild) scrollMarkerContainer.removeChild(scrollMarkerContainer.firstChild);
      const docH = document.documentElement.scrollHeight;
      const vh = window.innerHeight;
      foundSentences.forEach((el, idx) => {
        const marker = document.createElement('div');
        marker.className = 'scroll-marker';
        const topPos = el.getBoundingClientRect().top + window.scrollY;
        const markerPos = Math.min(Math.max((topPos / docH) * vh, 2), vh - 10);
        marker.style.top = markerPos + 'px';
        marker.addEventListener('click', () => { el.scrollIntoView({ behavior:'smooth', block:'center' }); });
        scrollMarkerContainer.appendChild(marker);
      });
    }

    // --------------------------
    // ëª¨ë‹¬
    function showModal(title, text, imageUrl=null){
      modalTitle.textContent = title || '';
      modalText.innerHTML = (text || '').toString().replace(/\n/g, '<br>');
      if (imageUrl) { modalImage.src = imageUrl; modalImage.style.display = 'block'; } else { modalImage.src=''; modalImage.style.display='none'; }
      modal.style.display = 'block';
      // ì„ íƒì˜ì—­ ìœ ì§€: ëª¨ë‹¬ ì—´ë ¤ë„ ì„ íƒ ìœ ì§€í•˜ë„ë¡ ì•½ê°„ì˜ ë³µì› ì‹œë„
      setTimeout(() => {
        if (selectionRange) {
          const sel = window.getSelection();
          sel.removeAllRanges();
          try { sel.addRange(selectionRange); } catch(e) { /* ignore */ }
        }
      }, 60);
    }
    function showLoadingModal(isImage=false){
      modalTitle.innerHTML = `<span class="loader"></span> ${isImage ? 'ê·¸ë¦¼ ìƒì„± ì¤‘...' : 'ì„¤ëª… ìƒì„± ì¤‘...'}`;
      modalText.textContent = 'ì„¤ëª…ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...';
      modalImage.style.display = 'none';
      modal.style.display = 'block';
    }

    // --------------------------
    // ë³¸ë¬¸ ì „ì²´ í…ìŠ¤íŠ¸ íšë“ (ìš”ì•½ìš©)
    function getFullBibleText(){
      const tmp = document.createElement('div');
      tmp.innerHTML = originalText;
      return tmp.textContent.replace(/\s+/g,' ').trim();
    }

    // --------------------------
    // ì„¤ëª…/ìš”ì•½ API í˜¸ì¶œ (Generative API í˜¸ì¶œ í•¸ë“¤ëŸ¬)
    async function callGenerativeAPI(modalTitleText, prompt){
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const payload = { contents: [ { parts: [ { text: prompt } ] } ] };

      let retryCount = 0; const maxRetries = 3;
      let response = null;
      while (retryCount < maxRetries) {
        try {
          response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (response.ok) break;
          if (response.status === 429) { retryCount++; const delay = Math.pow(2, retryCount)*1000 + Math.random()*1000; await new Promise(r=>setTimeout(r, delay)); }
          else throw new Error(`API Error: ${response.status} ${response.statusText}`);
        } catch (err) {
          console.error('API call failed:', err);
          showModal("ì˜¤ë¥˜ ë°œìƒ", "API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
          return;
        }
      }
      if (!response || !response.ok) { showModal("ì˜¤ë¥˜", "ì„¤ëª…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."); return; }

      try {
        const data = await response.json();
        const content = data?.candidates?.[0]?.content?.parts?.[0]?.text || "ì‘ë‹µì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        showModal(modalTitleText, content);
      } catch (err) {
        console.error('Error processing response:', err);
        showModal("ì˜¤ë¥˜", "ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // fetchExplanation + fetchSummary
    async function fetchExplanation(promptText, type){
      let prompt;
      if (type === 'simple') {
        prompt = `**ëª…ë ¹:**ë‹¤ìŒ ì„±ê²½ ìš©ì–´/êµ¬ì ˆì— ëŒ€í•´ ëª¨ë‘ í•©ì³ì„œ 300ìì—ì„œ 500ì ì‚¬ì´ì˜ ì§§ê³  ê°„ê²°í•œ ì„¤ëª…ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”. ë§Œì•½ì— ì„ íƒì–´ê°€ ì§€ëª…ì´ë¦„ ë˜ëŠ” ì‚¬ëŒì´ë¦„ì´ë©´ (ì˜ˆ: ë‹¨, ê°€ë‚˜ì•ˆ, í•˜ë€, ë¸Œë‹ˆì—˜, ì„¸ê²œ ë“±) ì§€ëª…ì´ë©´ ì¸ë¬¼ì„ ê²€ìƒ‰í•˜ê³  ì¸ë¬¼ì´ë©´ ì§€ëª…ì„ ê²€ìƒ‰í•´ì„œ ë‘ ê°€ì§€ ë‹¤ ì„¤ëª…í•´ ì£¼ì„¸ìš”. í•µì‹¬ ë‚´ìš©ì„ ì¤‘ì‹¬ìœ¼ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”.\n**ìš”ì²­ ìš©ì–´/êµ¬ì ˆ:** "${promptText}"\n**ì§€ì¹¨(ìš”ì•½):**- ì§€ëª…/ì¡±ì†/ë¯¼ì¡±: ê±°ì£¼ì§€ì™€ ìœ„ì¹˜ ê°„ë‹¨ ì„¤ëª…(í•„ìš”í•˜ë©´ ì§€ë„ ì–¸ê¸‰)\n- ì´ë¦„(ì¸ë¬¼): ì´ë¦„ì˜ ëœ»/ì£¼ìš”í™œë™/ê°„ë‹¨í•œ ë°°ê²½\n- ì œì‚¬ ë„êµ¬/ì„±ë¬¼ ë“±: ê°„ë‹¨í•œ ì„¤ëª…\n- ë™ë¬¼/ì‹ë¬¼/ê´‘ë¬¼: ì„±ê²½ì  ì˜ë¯¸ ê°„ë‹¨ ì„¤ëª…\n- ë¹„êµ ê°€ëŠ¥í•œ ê°œë…(ì„ íƒì ): í•µì‹¬ ë¹„êµ í•­ëª© ê°„ë‹¨ ë‚˜ì—´`;
      } else {
        prompt = `**ëª…ë ¹:**ë‹¤ìŒ ì„±ê²½ ìš©ì–´/êµ¬ì ˆì— ëŒ€í•´ ì„±ê²½ì  ê´€ì ì—ì„œ ìì„¸íˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”. ë‹µë³€ì€ ëª¨ë‘ í•©ì³ì„œ 2,000ìì—ì„œ 3,000ì ì‚¬ì´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”. í•„ìš”í•˜ë©´ í‘œ ë˜ëŠ” ê°„ë‹¨í•œ ì§€ë„ë¥¼ í¬í•¨í•˜ê±°ë‚˜ ì°¸ì¡°í•´ ì£¼ì„¸ìš”.\n**ìš”ì²­ ìš©ì–´/êµ¬ì ˆ:** "${promptText}"\n**ì§€ì¹¨:**A. ì§€ëª…, ì¡±ì†, ë¯¼ì¡±, ë‚˜ë¼: ì§€ë¦¬ì  ìœ„ì¹˜, ì—­ì‚¬ì  ë°°ê²½, ì„±ê²½ ê´€ë ¨ ì‚¬ê±´\nB. ì¸ë¬¼: ì´ë¦„ì˜ ëœ», ì£¼ìš” ì‚¬ê±´, í™œë™ ì§€ì—­\nC. ì œì‚¬ ë„êµ¬/ì„±ë¬¼: ì‚¬ìš© ëª©ì  ë° ì‹ í•™ì  ì˜ë¯¸\nD. ë™ë¬¼/ì‹ë¬¼: ì„±ê²½ì  ìƒì§•ì„±\nì¶œë ¥ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.`;
      }
      showLoadingModal(false);
      await callGenerativeAPI('êµ¬ì ˆ ì„¤ëª…', prompt);
    }

    async function fetchSummary(fullText, type){
      let prompt;
      if (type === 'simple') {
        prompt = `ë‹¹ì‹ ì€ ì„±ê²½ ì£¼ì„ê°€ì´ì ì„±ê²½ ì—°êµ¬ìì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì„ íƒí•œ ì„±ê²½ ë³¸ë¬¸ì„ í•™ë¬¸ì Â·ì‹ í•™ì  ë°°ê²½ì—ì„œ ë¶„ì„í•˜ì—¬, í•µì‹¬ ì£¼ì œì™€ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ í•©ì³ì„œ 300ìì—ì„œ 500ì ì‚¬ì´ë¡œ ê°„ë‹¨í•˜ê²Œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ë¶ˆí•„ìš”í•œ ì¥í™©í•œ ì„¤ëª…ì€ í”¼í•˜ê³  í•µì‹¬ ì˜ë¯¸ì™€ êµí›ˆì— ì§‘ì¤‘í•˜ì„¸ìš”.\nì„ íƒëœ ì„±ê²½ ë³¸ë¬¸: "${fullText}"`;
      } else {
        prompt = `ë‹¹ì‹ ì€ ì„±ê²½ ì£¼ì„ê°€ì´ì ì„±ê²½ ì—°êµ¬ìì…ë‹ˆë‹¤. ë‹¤ìŒ ì„±ê²½ ë³¸ë¬¸ì„ í•™ë¬¸ì Â·ì‹ í•™ì  ë°°ê²½ì—ì„œ ë¶„ì„í•˜ì—¬, ë³¸ë¬¸ì˜ ì£¼ìš” ì£¼ì œì™€ ë“±ì¥ì¸ë¬¼ì˜ ì—­í• , ì‹œëŒ€ì  ë°°ê²½, ì‹ í•™ì  ì˜ë¯¸ ë“±ì„ í¬í•¨í•˜ì—¬ ìì„¸íˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”. ë‹µë³€ì€ 2,500ìì—ì„œ 3,500ì ì‚¬ì´ë¡œ ì‘ì„±í•˜ì„¸ìš”.\nì„ íƒëœ ì„±ê²½ ë³¸ë¬¸: "${fullText}"`;
      }
      showLoadingModal(false);
      await callGenerativeAPI('ë³¸ë¬¸ ìš”ì•½', prompt);
    }

    // --------------------------
    // updateSpeed
    function updateSpeed(){ audio.playbackRate = currentSpeed; speedDisplay.textContent = currentSpeed.toFixed(1) + 'x'; }

    // --------------------------
    // ì„ íƒê´€ë ¨ helper (ì™¸ë¶€ì—ì„œ range ì§ì ‘ ì„¤ì • ë“±)
    // selectionRangeëŠ” ì´ë¯¸ í´ë¡ ëœ Rangeë¥¼ ë³´ìœ í•˜ê±°ë‚˜ null
    // handleSelectionChange()ì—ì„œ selectedVerse ì—…ë°ì´íŠ¸

    // --------------------------
    // selection ìœ ì§€ ë³´ì¥: ìœ ì €ê°€ í„°ì¹˜/í´ë¦­ í›„ ì„ íƒì´ ì‚¬ë¼ì§€ëŠ” ê²½ìš°, ì´ì „ì— ì €ì¥ëœ selectionRangeë¥¼ ë³µì› ì‹œë„
    // ì´ íŒŒì¼ì—ì„œ selectionRangeëŠ” ì„ íƒ ì§í›„ ì €ì¥ë˜ë©°, ë²„íŠ¼ í´ë¦­ ë“±ìœ¼ë¡œ ì„ íƒì´ ì‚¬ë¼ì§€ë©´ ë³µì› ì‹œë„í•¨.

    // --------------------------
    // ì¶”ê°€ ìœ í‹¸ (í°íŠ¸ í‘œì‹œ)
    function updateFontSizeDisplay(){
      const cur = parseFloat(getComputedStyle(bibleTextEl).fontSize);
      fontSizeEl.textContent = Math.round(cur);
    }

    // --------------------------
    // ì•ˆì „í•œ context: window ì „ì—­ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¼ë¶€ í•¨ìˆ˜ ë…¸ì¶œ (ì„ íƒì‚¬í•­)
    window.findString = findString;
    window.nextLocation = nextLocation;

    // --------------------------
    // --- âœ… ìƒˆ í† ê¸€ ë²„íŠ¼ ë¡œì§ ---
  const progressContainer = document.querySelector('.progress-container');
  const speedControls = document.querySelector('.speed-controls');
  const volumeControl = document.querySelector('.volume-control');
  const showProgressBtn = document.getElementById('show-progress');
  const showSpeedBtn = document.getElementById('show-speed');
  const showVolumeBtn = document.getElementById('show-volume');

  let hideTimeout;

  function showOnly(target) {
    progressContainer.style.display = "none";
    speedControls.style.display = "none";
    volumeControl.style.display = "none";

    target.style.display = "flex";

    if (hideTimeout) clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      target.style.display = "none";
    }, 10000);
  }

  showProgressBtn.addEventListener('click', () => showOnly(progressContainer));
  showSpeedBtn.addEventListener('click', () => showOnly(speedControls));
  showVolumeBtn.addEventListener('click', () => showOnly(volumeControl));
  </script>
</body>
</html>
