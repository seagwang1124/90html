<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통큰통독-01일차</title>
    <link rel="apple-touch-icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
    <!-- 수정: 올바른 메타 이름 -->
    <meta name="apple-mobile-web-app-title" content="통큰통독">
    <link rel="shortcut icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
    <link rel="mask-icon" type="image/png" href="https://i.postimg.cc/Qtnq0gFJ/Ezra-icon.png">
    <style>
        /* 페이지 기본 스타일 (body 속성은 CSS로 처리) */
        body {
            margin: 0;
            padding-top: 150px;
            font-family: Arial, sans-serif;
            background-color: #FFFFFF;
            color: #000000;
        }

        a:link { color: #0000FF; }
        a:visited { color: #660099; }

        /* 상단 고정 테이블 스타일 */
        .top-fixed-table {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: transparent;
            border-bottom: none;
            z-index: 100;
            table-layout: fixed;
            padding: 10px 0;
            box-sizing: border-box;
        }
        
        /* 1. 검색 창 스타일 변경 (모바일 최적화) */
        .search-cell { 
            text-align: left; 
            padding-left: 10px; 
            vertical-align: top; 
            width: 30%; 
        }

        .search-cell input[type="text"] {
            /* 검색어 입력창 길이를 50%로 줄임 */
            width: 50%; 
            /* 폰트 크기를 80%로 줄임 (15pt * 0.8 = 12pt) */
            font-size: 12pt;
        }

        .search-cell input[type="submit"],
        .search-cell input[type="reset"] {
            /* 검색 버튼 및 'X' 버튼 크기를 80%로 줄임 */
            font-size: 10pt; /* 13pt * 0.8 = 10.4pt -> 10pt로 조정 */
            padding: 5px 8px;
            height: auto;
        }

        .audio-cell { 
            text-align: right; 
            padding-right: 10px; 
            vertical-align: top; 
            width: 30%; 
        }

        #custom-audio-player { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        .player-controls { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            margin-bottom: 5px; 
        }

        .time-display { 
            font-size: 14px; 
            color: #555; 
            margin: 0 5px; 
        }

        /* 2. 오디오 컨트롤 버튼 크기 변경 (70%로 줄임) */
        .control-btn { 
            /* 40px * 0.7 = 28px */
            width: 28px; 
            height: 28px; 
            font-size: 14px; /* 18px * 0.7 = 12.6px -> 14px로 조정 */
            cursor: pointer; 
            border: 1px solid #ccc; 
            background-color: #fff; 
            border-radius: 5px; 
        }

        .control-btn:hover { 
            background-color: #e0e0e0; 
        }

        #play-btn { background-color: #d1f3d4; }
        #pause-btn { background-color: #fff6d6; }
        #stop-btn { background-color: #fddddd; }

        .speed-controls { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
            margin-bottom: 5px; 
        }

        .speed-btn { 
            /* 30px * 0.7 = 21px */
            width: 21px; 
            height: 21px; 
            font-size: 10px; /* 14px * 0.7 = 9.8px -> 10px로 조정 */
            cursor: pointer; 
            border: 1px solid #ccc; 
            border-radius: 3px; 
            background-color: #fff; 
        }

        .speed-btn:hover { 
            background-color: #e0e0e0; 
        }

        .speed-display { 
            font-weight: bold; 
            color: #007BFF; 
            width: 50px; 
            text-align: center; 
        }

        .volume-control { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
        }

        input[type="range"] { 
            -webkit-appearance: none; 
            width: 160px; 
            height: 5px; 
            background: #d3d3d3; 
            outline: none; 
            opacity: 0.7; 
            transition: opacity .2s; 
        }

        /* 🎵 오디오 타임바 전용 */
        #progress-bar {
            width: 190px; /* 150% 확대 */
        }

        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            appearance: none; 
            width: 15px; 
            height: 15px; 
            background: #007BFF; 
            cursor: pointer; 
            border-radius: 50%; 
        }

        /* 3. 구절 설명 버튼 컨테이너 스타일 */
        /* 초기 위치는 고정으로 유지하고, 선택 시 위치는 JS에서 동적으로 변경 */
        .explanation-button-container {
            position: fixed;
            top: 130px; /* 폰트 크기 조절 버튼 위로 배치 */
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: block;
            justify-content: center;
            align-items: center;
            padding: 0 10px;
            /* 부드러운 이동을 위한 transition 추가 */
            transition: top 0.2s ease, left 0.2s ease, transform 0.2s ease;
        }

        .explanation-button-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .explanation-icon-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ff99cc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            z-index: 2;
            position: relative;
        }

        /* 하위 버튼이 세로로 나타나도록 변경 */
        .explanation-sub-buttons {
            display: flex;
            flex-direction: column; /* 세로 배열로 변경 */
            justify-content: center;
            align-items: center; /* 버튼을 중앙에 정렬 */
            gap: 10px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            position: absolute;
            left: 50%;
            transform: translateX(-50%) translateY(25px);
            z-index: 1;
        }

        /* 'active' 클래스가 추가되면 서브 버튼이 나타남 */
        .explanation-button-wrapper.active .explanation-sub-buttons {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .explanation-sub-button {
            padding: 5px 10px;
            font-size: 24px;
            height: auto;
            background-color: #ff99cc;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            white-space: nowrap; 
        }

        .explanation-sub-button:hover { transform: scale(1.05); }
        
        /* 4. Font Size 컨트롤 크기 변경 (50%로 줄임) */
        .container { 
            width: 100%; 
            text-align: center; 
        }

        .font-size-label {
            /* 40px * 0.5 = 20px */
            font-size: 20px !important;
            margin-right: 20px; 
            font-style: normal; 
            font-weight: bold;
            color: blue;
        }
        
        #font-size { 
            /* 40px * 0.5 = 20px */
            font-size: 20px !important;
            margin: 0 5px; 
            font-style: normal; 
            font-weight: bold; 
            color: red;
        }
        
        #down, #up {
            /* 40px * 0.5 = 20px */
            width: 27px; /* 54px * 0.5 */
            height: 27px; /* 54px * 0.5 */
            font-size: 20px;
            font-weight: normal; 
            color: red; 
            background-color: #fff; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            cursor: pointer;
        }

        h2 { 
            padding: 0; 
            text-align: left; 
            margin-left: 15px; 
            margin-right: 15px; 
        }

        p { display: inline-block; }

        /* 모달 */
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); text-align: left; }
        #modal-image { max-width: 100%; height: auto; margin-bottom: 20px; border-radius: 8px; display: none; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }

        /* 로딩 스피너 */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; vertical-align: middle; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .search-highlight { background-color: yellow; color: black; }
        .scroll-marker-container { position: fixed; top: 0; right: 0; width: 8px; height: 100vh; z-index: 99; pointer-events: none; }
        .scroll-marker { position: absolute; right: 0; width: 8px; height: 8px; background-color: red; border-radius: 50%; box-shadow: 0 0 5px rgba(255, 0, 0, 0.7); cursor: pointer; pointer-events: auto; }
        .scroll-marker:hover { transform: scale(1.5); transition: transform 0.2s ease; }

        #search-count-container { display: flex; align-items: center; gap: 10px; }
        #search-count { font-size: 15pt; color: #007BFF; font-weight: bold; margin-left: 10px; white-space: nowrap; }
        #next-location-btn { padding: 5px 10px; font-size: 12pt; cursor: pointer; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; display: none; }
    
        /* iOS 길게 눌렀을 때 "복사/메뉴" 방지 */
         #bible-text {
         -webkit-user-select: text; /* iOS Safari에서 텍스트 선택 허용 */
         user-select: text;          /* 다른 브라우저에서도 동일 */
         -webkit-touch-callout: none; /* 📱 iOS에서 길게 눌렀을 때 복사/공유 메뉴 비활성화 */
        }
        /* 속도 리셋 버튼 */
        #speed-reset {
            width: 28px;
            height: 28px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #ff4d4d; /* 빨간색 */
            color: white;
            font-weight: bold;
        }
        #speed-reset:hover {
            background-color: #e60000;
        }

        /* 뮤트 버튼 */
        #mute-btn {
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 50%;
            background-color: #feebe1; /* 주황색 */
        }
        #mute-btn:hover {
            background-color: #fdd835;
        }
    </style>
</head>
<body>
    <table class="top-fixed-table" id="main-table" cellpadding="0" cellspacing="0">
        <tr>
            <td class="search-cell">
                <form name="f1" action="" onsubmit="findString(this.t1.value); return false">
                    <input type="reset" name="b2" value="X">
                    <input type="text" placeholder="검색어를 입력하세요" name="t1" value="">
                    <input type="submit" name="b1" value="검색">
                    <div id="search-count-container">
                        <span id="search-count"></span>
                        <button type="button" id="next-location-btn" onclick="nextLocation()">다음 위치</button>
                    </div>
                </form>
            </td>
            <td class="audio-cell">
                <div id="custom-audio-player">
    <audio id="audio-file" preload="auto">
        <source src="https://vod47.anyline.co.kr/vod_ezra/%EC%9D%BD%EA%B8%B0%2001.mp3" type="audio/mp3">
    </audio>
    <div class="player-controls">
        <span id="current-time" class="time-display">0:00</span>
        <button id="play-btn" class="control-btn">▶</button>
        <button id="pause-btn" class="control-btn">⏸</button>
        <button id="stop-btn" class="control-btn">■</button>
        <span id="remaining-time" class="time-display">0:00</span>
    </div>
    <input type="range" id="progress-bar" min="0" max="100" value="0" step="0.01">
    <div class="speed-controls">
        <button id="speed-down-02" class="speed-btn">&lt;&lt;</button>
        <button id="speed-down-01" class="speed-btn">&lt;</button>
        <span id="speed-display" class="speed-display">1.0x</span>
        <button id="speed-up-01" class="speed-btn">&gt;</button>
        <button id="speed-up-02" class="speed-btn">&gt;&gt;</button>
        <button id="speed-reset">1.0</button> <!-- ✅ 추가 -->
    </div>
    <div class="volume-control">
        <span style="font-size:12px;">볼륨</span>
        <button id="mute-btn">🔊</button> <!-- ✅ 추가 -->
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
    </div>
                </div>
            </td>
        </tr>
    </table>
    
    <!-- 3. 구절 설명 버튼 컨테이너: 초기부터 보이게 됩니다 -->
    <div class="explanation-button-container" id="explanation-button-container">
        <div class="explanation-button-wrapper">
            <button class="explanation-icon-button" id="explanation-icon-button">
                <span>📖</span>
            </button>
            <div class="explanation-sub-buttons">
                <!-- 기존 버튼 유지 -->
                <button class="explanation-sub-button" id="detailed-explanation-button">상세 구절설명</button>
                <button class="explanation-sub-button" id="simple-explanation-button">간단 구절설명</button>
                <!-- 새로운 버튼 추가 -->
                <button class="explanation-sub-button" id="summary-simple-button">본문요약 간단</button>
                <button class="explanation-sub-button" id="summary-detailed-button">본문요약 상세</button>
            </div>
        </div>
    </div>

    <div class="container">
        <br>
        <p class="font-size-label">Font Size</p>
        <button id="down">-</button>
        <p id="font-size">20</p>
        <button id="up">+</button>
    </div>

    <!-- 5. 줄 간격 유지를 위해 <br></br> 태그 유지 -->
    <div>
    <h2 id="bible-text" style="line-height: 1.2em;margin-left:15px;margin-right:15px;font-style: normal; font-weight: normal; color: black;font-size: 20px;word-break: break-all;">
      <strong>

통독 1일차
<br>범위: 창세기 1장- 11장</br>
<br>&nbsp;</br>

</strong>
<strong><br><font color="#4682b4">창세기 1 장</font></br></strong>
<br><i><font color="#808080">*천지 창조*</font></i></br>
<br>1 태초에 하나님이 천지를 창조하시니라</br>
<br>2 땅이 혼돈하고 공허하며 흑암이 깊음 위에 있고 하나님의 영은 수면 위에 운행하시니라</br>
<br>아들 가나안 이스라엘 살로메 아나니아 헤롯 왕 다윗 아들 단 예루살렘 갈릴리 모압 암몬 이스가 단 가나안 하란 브니엘</br>
<br>&nbsp;</br>
<br>     1일차 끝</br>
<br>&nbsp;</br>
        </h2>
        </div>
    <div id="explanation-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal">&times;</span>
            <h3 id="modal-title">구절 설명</h3>
            <img id="modal-image" src="" alt="설명 관련 이미지">
            <p id="modal-text">구절을 드래그하여 선택하고 '구절설명' 버튼을 누르세요.</p>
        </div>
    </div>
    <div id="scroll-marker-container" class="scroll-marker-container"></div>
    <script>
        // ------------------------------
        // 설정: API 키를 여기에 넣으세요 (빈 문자열이면 호출은 실패합니다)
        const apiKey = "AIzaSyDUlSQlSPgnrFBXpnUJMDoUO3s_KsaoFRU"; // <-- 여기에 Google API Key를 넣으세요
        // ------------------------------

        // DOM 요소
        const bibleTextEl = document.getElementById('bible-text');
        const searchCountEl = document.getElementById('search-count');
        const nextLocationBtn = document.getElementById('next-location-btn');
        const scrollMarkerContainer = document.getElementById('scroll-marker-container');
        const explanationIconButton = document.getElementById('explanation-icon-button');
        const detailedExplanationButton = document.getElementById('detailed-explanation-button');
        const simpleExplanationButton = document.getElementById('simple-explanation-button');
        const summarySimpleButton = document.getElementById('summary-simple-button');
        const summaryDetailedButton = document.getElementById('summary-detailed-button');
        const explanationButtonContainer = document.getElementById('explanation-button-container');
        const modal = document.getElementById('explanation-modal');
        const closeModalButton = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalImage = document.getElementById('modal-image');
        const modalText = document.getElementById('modal-text');
        const audio = document.getElementById('audio-file');
        const playBtn = document.getElementById('play-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        const speedDisplay = document.getElementById('speed-display');
        const speedDown02Btn = document.getElementById('speed-down-02');
        const speedDown01Btn = document.getElementById('speed-down-01');
        const speedUp01Btn = document.getElementById('speed-up-01');
        const speedUp02Btn = document.getElementById('speed-up-02');
        const volumeSlider = document.getElementById('volume-slider');
        const currentTimeEl = document.getElementById('current-time');
        const remainingTimeEl = document.getElementById('remaining-time');
        const upBtn = document.getElementById('up');
        const downBtn = document.getElementById('down');
        const fontSizeEl = document.getElementById('font-size');
        const explanationButtonWrapper = document.querySelector('.explanation-button-wrapper');
        const speedResetBtn = document.getElementById('speed-reset');
        const muteBtn = document.getElementById('mute-btn');

        // 속도 리셋 버튼 기능
        speedResetBtn.addEventListener('click', () => {
            currentSpeed = 1.0;
            updateSpeed();
        });

        // 뮤트 버튼 기능
        let isMuted = false;
        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            audio.muted = isMuted;
            muteBtn.textContent = isMuted ? "🔇" : "🔊"; // 아이콘 변경
        });

        // 상태값
        let selectedVerse = "";
        let originalText = "";
        let foundSentences = [];
        let currentSearchIndex = -1;
        let currentSpeed = 1.0;

        // 유틸: RegExp 특수문자 이스케이프
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // 페이지 초기화
        window.addEventListener('DOMContentLoaded', () => {
            originalText = bibleTextEl.innerHTML; // 원본 저장 (요청대로 <br></br> 등은 그대로 유지)
            updateFontSizeDisplay();
            updateSpeed();

            // ✅ 선택 이벤트 (iOS 대응)
        function updateSelectedVerse() {
            const selection = window.getSelection();
            const trimmedSelection = selection.toString().trim();

            const isSelectionInBibleText =
                bibleTextEl.contains(selection.anchorNode) &&
                bibleTextEl.contains(selection.focusNode);

            if (trimmedSelection && isSelectionInBibleText) {
                selectedVerse = trimmedSelection;  // ✅ iOS에서 안 잡히던 부분 고침

                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const scrollY = window.scrollY || window.pageYOffset;

                explanationButtonContainer.style.position = 'absolute';
                explanationButtonContainer.style.left = `${rect.left}px`;
                explanationButtonContainer.style.top = `${rect.bottom + scrollY + 10}px`;
                explanationButtonContainer.style.transform = 'none';
                explanationButtonContainer.style.display = 'block';
            } else {
                selectedVerse = ""; // 선택 해제 시 초기화
                explanationButtonContainer.style.position = 'fixed';
                explanationButtonContainer.style.left = '50%';
                explanationButtonContainer.style.top = '130px';
                explanationButtonContainer.style.transform = 'translateX(-50%)';
            }
        }

            // 📱 모바일 + PC 모두 대응 (지연 처리)
            document.addEventListener('mouseup', () => setTimeout(updateSelectedVerse, 100));
            document.addEventListener('touchend', () => setTimeout(updateSelectedVerse, 150));

            // 📌 selectionchange 보조 이벤트 (iOS 안정성 강화 - 디바운스 적용)
            let selectionTimeout;
            document.addEventListener('selectionchange', () => {
                clearTimeout(selectionTimeout);
                selectionTimeout = setTimeout(updateSelectedVerse, 200);
            });

            // 검색 폼
            const searchForm = document.querySelector('form[name="f1"]');
            if (searchForm) {
                searchForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const searchText = event.target.t1.value;
                    findString(searchText);
                });
            }
            const resetBtn = document.querySelector('input[name="b2"]');
            if (resetBtn) resetBtn.addEventListener('click', clearHighlight);
            nextLocationBtn.addEventListener('click', nextLocation);

            // 폰트 크기
            if (upBtn) upBtn.addEventListener('click', () => {
                let currentSize = parseFloat(window.getComputedStyle(bibleTextEl).fontSize);
                if (currentSize + 4 <= 80) {
                    bibleTextEl.style.fontSize = (currentSize + 4) + 'px';
                    updateFontSizeDisplay();
                }
            });
            if (downBtn) downBtn.addEventListener('click', () => {
                let currentSize = parseFloat(window.getComputedStyle(bibleTextEl).fontSize);
                if (currentSize - 4 >= 12) {
                    bibleTextEl.style.fontSize = (currentSize - 4) + 'px';
                    updateFontSizeDisplay();
                }
            });

            // 오디오 컨트롤
            playBtn.addEventListener('click', () => { audio.play(); });
            pauseBtn.addEventListener('click', () => { audio.pause(); });
            stopBtn.addEventListener('click', () => { audio.pause(); audio.currentTime = 0; });

            speedDown02Btn.addEventListener('click', () => { currentSpeed = Math.max(0.5, currentSpeed - 0.2); updateSpeed(); });
            speedDown01Btn.addEventListener('click', () => { currentSpeed = Math.max(0.5, currentSpeed - 0.1); updateSpeed(); });
            speedUp01Btn.addEventListener('click', () => { currentSpeed = Math.min(2.0, currentSpeed + 0.1); updateSpeed(); });
            speedUp02Btn.addEventListener('click', () => { currentSpeed = Math.min(2.0, currentSpeed + 0.2); updateSpeed(); });

            volumeSlider.addEventListener('input', () => { audio.volume = volumeSlider.value; });

            audio.addEventListener('timeupdate', () => {
                const currentTime = audio.currentTime;
                const duration = audio.duration;
                currentTimeEl.textContent = formatTime(currentTime);
                if (isFinite(duration)) {
                    const remainingTime = duration - currentTime;
                    remainingTimeEl.textContent = '-' + formatTime(remainingTime);
                }
            });

            // 아이콘 클릭 -> 서브버튼 표시
            explanationIconButton.addEventListener('click', (event) => {
                event.stopPropagation();
                explanationButtonWrapper.classList.toggle('active');
            });

            // 상세 설명
            detailedExplanationButton.addEventListener('click', () => {
                const trimmedVerse = selectedVerse.trim();
                if (!trimmedVerse) {
                    showModal("구절을 먼저 선택하세요", "본문에서 구절이나 단어를 드래그하여 선택한 후 다시 버튼을 눌러주세요.");
                } else {
                    showLoadingModal(false);
                    fetchExplanation(trimmedVerse, 'detailed');
                }
                explanationButtonWrapper.classList.remove('active');
            });

            // 간단 설명
            simpleExplanationButton.addEventListener('click', () => {
                const trimmedVerse = selectedVerse.trim();
                if (!trimmedVerse) {
                    showModal("구절을 먼저 선택하세요", "본문에서 구절이나 단어를 드래그하여 선택한 후 다시 버튼을 눌러주세요.");
                } else {
                    showLoadingModal(false);
                    fetchExplanation(trimmedVerse, 'simple');
                }
                explanationButtonWrapper.classList.remove('active');
            });

            // 본문요약 간단 (새로운 기능)
            summarySimpleButton.addEventListener('click', () => {
                const fullText = getFullBibleText();
                if (!fullText.trim()) {
                    showModal("본문이 없습니다", "요약할 성경 본문이 없습니다.");
                } else {
                    showLoadingModal(false);
                    fetchSummary(fullText, 'simple');
                }
                explanationButtonWrapper.classList.remove('active');
            });

            // 본문요약 상세 (새로운 기능)
            summaryDetailedButton.addEventListener('click', () => {
                const fullText = getFullBibleText();
                if (!fullText.trim()) {
                    showModal("본문이 없습니다", "요약할 성경 본문이 없습니다.");
                } else {
                    showLoadingModal(false);
                    fetchSummary(fullText, 'detailed');
                }
                explanationButtonWrapper.classList.remove('active');
            });

            // body 외부 클릭 시 서브 버튼 닫기
            document.body.addEventListener('click', (event) => {
                if (!explanationButtonWrapper.contains(event.target)) {
                    explanationButtonWrapper.classList.remove('active');
                }
            });

            // 모달 닫기
            closeModalButton.addEventListener('click', () => { modal.style.display = 'none'; });
            window.addEventListener('click', (event) => { if (event.target === modal) modal.style.display = 'none'; });
        });

        // 성경 본문 전체를 가져오는 함수
        function getFullBibleText() {
            // 원본 텍스트에서 태그와 불필요한 공백 제거
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = originalText;
            return tempDiv.textContent.replace(/\s+/g, ' ').trim();
        }

        // 폰트 크기 표시 업데이트
        function updateFontSizeDisplay() {
            const currentSize = parseFloat(window.getComputedStyle(bibleTextEl).fontSize);
            fontSizeEl.textContent = Math.round(currentSize);
        }

        // 재생 속도 업데이트
        function updateSpeed() {
            audio.playbackRate = currentSpeed;
            speedDisplay.textContent = currentSpeed.toFixed(1) + 'x';
        }

        // ✅ play 이벤트 발생할 때 현재 속도 유지
        audio.addEventListener('play', () => {
            audio.playbackRate = currentSpeed;
        });

        // 시간 포맷
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // 검색 및 하이라이트
        function findString(searchText) {
            clearHighlight();
            if (searchText === null || searchText.trim() === '') {
                searchCountEl.textContent = '';
                nextLocationBtn.style.display = 'none';
                return;
            }
            const escaped = escapeRegExp(searchText);
            const regex = new RegExp(escaped, 'gi');
            // replace safely by match callback to preserve original matched casing
            const newContent = originalText.replace(regex, (match) => `<span class="search-highlight">${match}</span>`);
            bibleTextEl.innerHTML = newContent;
            foundSentences = Array.from(bibleTextEl.getElementsByClassName('search-highlight'));
            searchCountEl.textContent = `총 ${foundSentences.length}개 검색됨`;
            if (foundSentences.length > 0) {
                currentSearchIndex = 0;
                foundSentences[currentSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                nextLocationBtn.style.display = 'inline-block';
                updateScrollMarkers();
            } else {
                showModal("검색 결과 없음", `"${searchText}"에 대한 검색 결과가 없습니다.`);
                nextLocationBtn.style.display = 'none';
            }
        }

        // 다음 검색 위치
        function nextLocation() {
            if (foundSentences.length > 0) {
                currentSearchIndex = (currentSearchIndex + 1) % foundSentences.length;
                foundSentences[currentSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 하이라이트 초기화
        function clearHighlight() {
            bibleTextEl.innerHTML = originalText;
            searchCountEl.textContent = '';
            nextLocationBtn.style.display = 'none';
            while (scrollMarkerContainer.firstChild) scrollMarkerContainer.removeChild(scrollMarkerContainer.firstChild);
            foundSentences = [];
            currentSearchIndex = -1;
        }

        // 스크롤 마커 업데이트
        function updateScrollMarkers() {
            while (scrollMarkerContainer.firstChild) scrollMarkerContainer.removeChild(scrollMarkerContainer.firstChild);
            const documentHeight = document.documentElement.scrollHeight;
            const viewportHeight = window.innerHeight;
            for (let i = 0; i < foundSentences.length; i++) {
                const el = foundSentences[i];
                const marker = document.createElement('div');
                marker.className = 'scroll-marker';
                const topPosition = el.getBoundingClientRect().top + window.scrollY;
                const markerPosition = (topPosition / documentHeight) * viewportHeight;
                marker.style.top = `${markerPosition}px`;
                marker.addEventListener('click', () => {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                scrollMarkerContainer.appendChild(marker);
            }
        }

        // 모달 공통
        function showModal(title, text, imageUrl = null) {
            modalTitle.textContent = title;
            modalText.innerHTML = (text || '').toString().replace(/\n/g, '<br>');
            if (imageUrl) {
                modalImage.src = imageUrl;
                modalImage.style.display = 'block';
            } else {
                modalImage.src = '';
                modalImage.style.display = 'none';
            }
            modal.style.display = 'block';
        }

        // 로딩 모달
        function showLoadingModal(isImage = false) {
            modalTitle.innerHTML = `<span class="loader"></span> ${isImage ? '그림 생성 중...' : '설명 생성 중...'}`;
            modalText.textContent = `설명을 생성 중입니다. 잠시만 기다려 주세요...`;
            modalImage.style.display = 'none';
            modal.style.display = 'block';
        }              

        /**
         * fetchExplanation: 상세/간단 설명 생성
         * type: 'detailed' 또는 'simple'
         */
        async function fetchExplanation(promptText, type) {
            // build prompt according to user's specification
            let prompt;
            if (type === 'simple') {
                prompt = `**명령:**다음 성경 용어/구절에 대해 모두 합쳐서 300자에서 500자 사이의 짧고 간결한 설명을 작성해 주세요. 만약에 선택어가 지명이름 또는 사람이름이면 (예를들면 단, 가나안, 하란, 브니엘, 세겜, 등 수많은 동일 이름들) 지명이면 인물을 검색하고 인물이면 지명을 검색해서 두가지 다 설명해 주세요. 핵심 내용을 중심으로 요약해 주세요.**요청 용어/구절:** "${promptText}"**지침(요약):**- 지명/족속/민족: 거주지와 위치 간단 설명(필요하면 지도 언급)- 이름(인물): 이름의 뜻/주요활동/간단한 배경- 제사 도구/성물 등: 간단한 설명- 동물/식물/광물: 성경적 의미 간단 설명- 비교 가능한 개념(선택적): 핵심 비교 항목 간단 나열
                `;
            } else { // detailed
                prompt = `**명령:**다음 성경 용어/구절에 대해 성경적 관점에서 자세히 설명해 주세요. 답변은 모두 합쳐서 2,000자에서 3,000자 사이로 작성해 주세요. 만약에 선택어가 지명이름 또는 사람이름이면 (예를들면 단, 가나안, 하란, 브니엘, 세겜, 등 수많은 동일 이름들) 지명이면 인물을 검색하고 인물이면 지명을 검색해서 두가지 다 설명해 주세요. 필요한 경우 표 또는 간단한 지도를 포함하거나 참조해 주세요.**요청 용어/구절:** "${promptText}"**지침:**A. 지명, 족속, 민족, 나라: - 지명: 지리적 위치, 역사적 배경, 성경 관련 사건, (간단한 지도 설명 권장) - 족속/민족/나라: 거주 지역, 주요 이주/이동, 성경 내 역할B. 인물: - 이름의 뜻, 생몰 시기(가능하면), 주 활동 지역 및 이동 경로, 주요 사건, (성화/그림이 있으면 언급)C. 제사 도구/성물: - 사용 목적, 방식, 역사적·신학적 의미, (성화/그림이 있으면 언급)D. 동물/생물/식물/광물: - 성경적 상징성, 관련 구절, 비교 가능한 항목(표 권장)E. 비교 가능한 개념: - 필요 시 표로 비교(예: 창조의 날별 순서, 제사의 종류, 12지파 상징 등)출력은 한국어로 명확하고 읽기 쉬운 문장으로 작성하세요.
                `;
            }

            await callGenerativeAPI(promptText, prompt);
        }

        /**
         * fetchSummary: 본문요약 간단/상세
         * type: 'simple' 또는 'detailed'
         */
        async function fetchSummary(fullText, type) {
            let prompt;
            if (type === 'simple') {
                prompt = `당신은 성경 주석가이자 성경 연구자입니다. 사용자가 선택한 성경 구절을 학문적·신학적 배경에서 분석하여, 핵심 주제와 메시지를 모두 합쳐서 300자에서 500자 사이로 간단하게 요약해 주세요. 불필요한 장황한 설명은 피하고, 성경 본문의 핵심 의미와 교훈에 집중해 주세요. 한국어로 답변해 주세요. 선택된 성경 본문: "${fullText}"`;
            } else {
                prompt = `당신은 성경 주석가이자 성경 연구자입니다. 다음 성경 본문을 학문적·신학적 배경에서 분석하여, 본문의 주요 주제와 등장인물의 역할, 시대적 배경, 신학적 의미 등을 포함하여 자세히 설명해 주세요. 답변은 모두 합쳐서 2,500자에서 3,500자 사이로 작성해 주세요. 한국어로 답변해 주세요. 선택된 성경 본문: "${fullText}"`;
            }

            await callGenerativeAPI('본문 요약', prompt);
        }

        async function callGenerativeAPI(modalTitleText, prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [
                    { parts: [{ text: prompt }] }
                ]
            };
            
            let retryCount = 0;
            const maxRetries = 3;
            let response = null;
            while (retryCount < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        break;
                    } else if (response.status === 429) {
                        retryCount++;
                        const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                } catch (error) {
                    showModal("오류 발생", "API 호출 중 오류가 발생했습니다. 다시 시도해 주세요.");
                    console.error("API call failed:", error);
                    return;
                }
            }
            if (!response || !response.ok) {
                showModal("오류", "설명을 불러오는 데 실패했습니다. 잠시 후 다시 시도해 주세요.");
                return;
            }

            try {
                const data = await response.json();
                const content = data.candidates[0].content.parts[0].text;
                showModal(modalTitleText, content);
            } catch (error) {
                showModal("오류", "응답을 처리하는 중 오류가 발생했습니다.");
                console.error("Error processing response:", error);
            }
        } 
    </script>
</body>
</html>


