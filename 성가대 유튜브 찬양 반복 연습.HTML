<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì„±ê°€ëŒ€ ìœ íŠœë¸Œ ë°˜ë³µ í”Œë ˆì´ì–´</title>
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --panel-2:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#60a5fa; --accent-2:#93c5fd; --danger:#ef4444; --warn:#f59e0b; --ok:#22c55e;
      --chip-bg:rgba(2,6,23,.55); --chip-brd:#334155; --chip-hover:rgba(2,6,23,.8);
    }
    *{box-sizing:border-box}
    body{margin:0;padding:16px;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,"Apple Color Emoji","Noto Color Emoji",sans-serif}
    h1{font-size:22px;margin:0 0 12px;letter-spacing:.2px}
    .card{max-width:1080px;margin:0 auto;background:var(--panel);border:1px solid #1f2937;border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .section{padding:14px}
    .row{display:flex;gap:8px;align-items:center}
    .row.wrap{flex-wrap:wrap}

    input[type=text],input[type=url]{
      flex:1;min-width:220px;background:var(--panel-2);color:var(--text);
      border:1px solid #374151;border-radius:10px;padding:12px 14px;outline:none;transition:border .15s
    }
    input[type=text]:focus,input[type=url]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(96,165,250,.2)}
    button{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#0b1220;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;white-space:nowrap}
    button.secondary{background:#374151;color:var(--text);font-weight:600}
    button.ghost{background:transparent;border:1px solid #374151;color:var(--text)}
    button.link{background:transparent;color:var(--accent-2);text-decoration:underline}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* ë¦¬ìŠ¤íŠ¸ í–‰ */
    .parts{display:grid;gap:8px}
    /* ì„ íƒ ë²„íŠ¼ ì œê±° í›„: [ë¼ë²¨ | ë§í¬ | ë„£ê¸° | ì‚­ì œ] */
    .part-row{
      display:grid;
      grid-template-columns:84px 1fr auto auto;
      gap:8px;align-items:center
    }
    .part-label{
      width:84px;text-align:center;background:#0b1220;border:1px solid #374151;border-radius:10px;
      padding:10px 6px;cursor:pointer;user-select:none;outline:none
    }
    .part-label:hover{filter:brightness(1.1)}
    .part-label:focus{box-shadow:0 0 0 3px rgba(96,165,250,.35)}

    /* í”Œë ˆì´ì–´ */
    .player-wrap{position:relative;background:#000}
    .ratio-16x9{width:100%;aspect-ratio:16/9}
    #player{width:100%;height:100%}

    /* íƒ­(í„°ì¹˜) ìºì²˜ */
    .tap-catcher{position:absolute;inset:0;z-index:4;background:transparent;touch-action:manipulation}

    /* ì¤‘ì•™ í° ì¬ìƒ ë²„íŠ¼ */
    .center-play{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;z-index:5;opacity:1;transition:opacity 180ms ease}
    .center-play.is-hidden{opacity:0;pointer-events:none}
    .center-play .btn{pointer-events:auto;width:88px;height:88px;border-radius:9999px;background:rgba(255,255,255,.92);border:none;display:grid;place-items:center;box-shadow:0 10px 25px rgba(0,0,0,.45);cursor:pointer;transition:transform .1s}
    .center-play .btn:hover{transform:scale(1.03)}
    .triangle{width:0;height:0;border-left:26px solid #0b1220;border-top:16px solid transparent;border-bottom:16px solid transparent;margin-left:6px}

    /* === ë™ì˜ìƒ ì•ˆ ì˜¤ë²„ë ˆì´: ì¢Œ/ìš°(ì„¸ë¡œ), ìƒë‹¨/í•˜ë‹¨(ê°€ë¡œ) === */
    .overlay-ctrl{
      position:absolute; inset:0; z-index:6; color:#fff;
      opacity:1; transition:opacity 180ms ease;
      pointer-events:none; /* ìì‹ë§Œ í´ë¦­ */
    }
    .overlay-ctrl.is-hidden{opacity:0; pointer-events:none}
    .overlay-ctrl .bar{
      position:absolute; inset:0;
      background:linear-gradient(to top,rgba(0,0,0,.75),rgba(0,0,0,.35) 60%,transparent);
    }

    /* ì¢Œìš° ì»¬ëŸ¼: í™”ë©´ ì¤‘ì•™ì— ì„¸ë¡œ ì •ë ¬ (ìƒ/í•˜ ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ) */
    .overlay-ctrl .left,
    .overlay-ctrl .right{
      position:absolute; top:50%;
      transform:translateY(-50%);
      display:flex; flex-direction:column; gap:8px;
      min-width:0; max-width:48vw;
      pointer-events:auto;
    }
    .overlay-ctrl .left{ left:10px;  align-items:flex-start }
    .overlay-ctrl .right{ right:10px; align-items:flex-end  }
    .overlay-ctrl button{
      width:auto; max-width:100%;
      white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
    }
    .time-label{ max-width:100%; overflow:hidden; text-overflow:ellipsis }

    /* ìƒë‹¨/í•˜ë‹¨ ê°€ë¡œ í€µ ë²„íŠ¼ ë°” */
    .overlay-ctrl .topbar,
    .overlay-ctrl .bottombar{
      position:absolute; left:0; right:0;
      display:flex; justify-content:center; align-items:center;
      gap:8px; padding:8px 10px;
      pointer-events:auto;
    }
    .overlay-ctrl .topbar{ top:10px }
    .overlay-ctrl .bottombar{ bottom:10px }

    /* ì‘ì€ íƒ€ì›í˜• í€µ ë²„íŠ¼ (ì¹©) */
    .pill{
      background:var(--chip-bg); border:1px solid var(--chip-brd);
      color:#e5e7eb; border-radius:999px;
      padding:6px 10px; line-height:1; font-weight:700; font-size:13px;
      backdrop-filter:saturate(120%) blur(6px);
      cursor:pointer; user-select:none;
    }
    .pill:hover{ background:var(--chip-hover) }
    .pill.min{padding:6px 10px; font-size:12px}
    .pill:disabled{opacity:.6; cursor:not-allowed}

    /* í™”ì§ˆ ë©”ë‰´ (ìš°ì¸¡ ì¹¼ëŸ¼ ë²„íŠ¼ ìœ„ì— ëœ¨ê²Œ) */
    .menu{
      position:absolute; bottom:calc(100% + 8px); right:0;
      background:rgba(17,24,39,.96); border:1px solid #374151;border-radius:10px;padding:6px;display:none;min-width:160px;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      pointer-events:auto;
    }
    .menu.open{display:block}
    .menu button{width:100%;text-align:left;background:transparent;color:#e5e7eb;border:none;padding:8px 10px;border-radius:8px}
    .menu button:hover{background:#1f2937}

    /* ê³µìœ  */
    .share{display:flex;gap:8px;align-items:center}
    .help{color:var(--muted);font-size:13px}
    .err{color:var(--danger);font-size:13px;margin-top:6px}
    .warn{color:var(--warn);font-size:13px;margin-top:6px}

    /* ë„í‚¹ ì‹œí¬ë°” */
    .seek-dock{background:var(--panel-2);border-top:1px solid #374151;border-bottom:1px solid #374151;padding:6px 10px;display:flex;align-items:center;gap:8px}
    .seek-dock .seek{flex:1;height:6px;border-radius:999px;background:#374151;appearance:none}
    .seek-dock .seek::-webkit-slider-thumb{appearance:none;width:12px;height:12px;border-radius:50%;background:#fff;border:2px solid #1f2937}
    .dock-time{font-variant-numeric:tabular-nums;font-size:12px;min-width:84px;text-align:right;color:#e5e7eb}

    /* ë°˜ì‘í˜• ê¸°ë³¸(â‰¤720px) */
    @media(max-width:720px){
      .center-play .btn{width:76px;height:76px}
      .triangle{border-left-width:22px;border-top-width:14px;border-bottom-width:14px}
      .volslider input{width:110px}
      .overlay-ctrl .topbar, .overlay-ctrl .bottombar{gap:6px; padding:6px 8px}
      .pill{padding:6px 9px; font-size:12px}
    }

    /* ëª¨ë°”ì¼ ì„¸ë¡œ(â‰¤540px): íŒŒíŠ¸ í–‰ ê²¹ì¹¨ ë°©ì§€ + ì»´íŒ©íŠ¸ */
    @media(max-width:540px){
      .parts{gap:6px}
      .part-row{
        grid-template-columns:56px minmax(0,1fr) 36px 36px;
        gap:6px; align-items:center
      }
      .part-row > *{min-width:0}
      .part-row .part-label{width:56px; padding:4px 2px; font-size:14px; line-height:1.1}
      .part-row .paste,.part-row .remove{
        writing-mode:vertical-rl; text-orientation:mixed; letter-spacing:-1px;
        height:36px; width:36px; min-width:36px; padding:2px; font-size:13px; line-height:1;
        display:flex; align-items:center; justify-content:center;
      }
      input[type=url]{padding:8px 10px;font-size:14px}
      .overlay-ctrl button{padding:6px 8px;font-size:12px}
      .seek-dock{padding:6px 8px}
      .dock-time{min-width:64px;font-size:11px}
      .center-play .btn{width:72px;height:72px}
      /* ìƒ/í•˜ë‹¨ ì¹©ì´ ë„ˆë¬´ ê¸¸ë©´ ìë™ ì¤„ë°”ê¿ˆí•˜ë©° ì¤‘ì•™ ì •ë ¬ ìœ ì§€ */
      .overlay-ctrl .topbar, .overlay-ctrl .bottombar{flex-wrap:wrap}
    }

    /* ì´ˆí˜‘í­(â‰¤420px) */
    @media(max-width:420px){
      body{padding:12px}
      button{padding:6px 8px;border-radius:8px;font-size:11px}
      input[type=text],input[type=url]{padding:8px 10px;font-size:12px}
      .part-label{padding:6px 2px;font-size:12px}
      .overlay-ctrl button{padding:5px 7px;font-size:11px}
      .center-play .btn{width:64px;height:64px}
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="section">
      <div class="help" style="margin-bottom:8px; font-size:14px">
        ì´ í”Œë ˆì´ì–´ëŠ” <b>ì„±ê°€ ëŒ€ì›</b>ì´ ì°¬ì–‘ê³¡ì„ <b>ë°˜ë³µ ì¬ìƒ</b>í•˜ë©° ì—°ìŠµí•˜ë„ë¡ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.
        ë§í¬ë¥¼ ì±„ìš°ê³  ê³µìœ  ì£¼ì†Œë¥¼ ë³µì‚¬í•´ ëŒ€ì›ë“¤ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.
      </div>
      <h1>ì„±ê°€ëŒ€ ìœ íŠœë¸Œ ë°˜ë³µ í”Œë ˆì´ì–´</h1>
    </div>

    <!-- ì œëª© -->
    <div class="section">
      <div class="row wrap" aria-label="ì°¬ì–‘ ì œëª© ì…ë ¥">
        <span class="part-label" style="width:auto;">ì°¬ì–‘ ì œëª©</span>
        <input id="titleInput" type="text" placeholder="ì˜ˆ: í• ë ë£¨ì•¼ ì°¬ì–‘" />
        <button id="titlePaste" class="ghost" type="button">ë„£ê¸°</button>
        <button id="titleClear" class="ghost" type="button">ì‚­ì œ</button>
      </div>
    </div>

    <!-- íŒŒíŠ¸ ë¦¬ìŠ¤íŠ¸ -->
    <div class="section">
      <div class="help" style="margin-bottom:10px">
        ê° <b>íŒŒíŠ¸ ë¼ë²¨</b>(í•©ì°½/ì†Œí”„/ì•Œí† /í…Œë„ˆ/ë² ìŠ¤/ì†”ë¡œ)ì„ ëˆ„ë¥´ë©´ í•´ë‹¹ ì¤„ì˜ ë§í¬ë¡œ <b>ì¦‰ì‹œ ì¬ìƒ</b>ë©ë‹ˆë‹¤.
        (ë§í¬ëŠ” ìœ íŠœë¸Œ ì£¼ì†Œ ë˜ëŠ” ì˜ìƒ ID)
      </div>
      <div class="parts" id="parts">
        <div class="part-row" data-key="ch">
          <span class="part-label" role="button" tabindex="0" aria-label="í•©ì°½ ì¬ìƒ">í•© ì°½</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste" type="button">ë„£ê¸°</button>
          <button class="ghost remove" type="button">ì‚­ì œ</button>
        </div>
        <div class="part-row" data-key="sop">
          <span class="part-label" role="button" tabindex="0" aria-label="ì†Œí”„ë¼ë…¸ ì¬ìƒ">ì†Œ í”„</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste" type="button">ë„£ê¸°</button>
          <button class="ghost remove" type="button">ì‚­ì œ</button>
        </div>
        <div class="part-row" data-key="alt">
          <span class="part-label" role="button" tabindex="0" aria-label="ì•Œí†  ì¬ìƒ">ì•Œ í† </span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste" type="button">ë„£ê¸°</button>
          <button class="ghost remove" type="button">ì‚­ì œ</button>
        </div>
        <div class="part-row" data-key="ten">
          <span class="part-label" role="button" tabindex="0" aria-label="í…Œë„ˆ ì¬ìƒ">í…Œ ë„ˆ</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste" type="button">ë„£ê¸°</button>
          <button class="ghost remove" type="button">ì‚­ì œ</button>
        </div>
        <div class="part-row" data-key="bas">
          <span class="part-label" role="button" tabindex="0" aria-label="ë² ì´ìŠ¤ ì¬ìƒ">ë²  ìŠ¤</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste" type="button">ë„£ê¸°</button>
          <button class="ghost remove" type="button">ì‚­ì œ</button>
        </div>
        <div class="part-row" data-key="sol">
          <span class="part-label" role="button" tabindex="0" aria-label="ì†”ë¡œ ì¬ìƒ">ì†” ë¡œ</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste" type="button">ë„£ê¸°</button>
          <button class="ghost remove" type="button">ì‚­ì œ</button>
        </div>
      </div>
      <div id="err" class="err" aria-live="polite"></div>
      <div id="cookieHelp" class="warn" hidden>
        ì„ë² ë“œê°€ ë³´ì´ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì €ì˜ <b>ì„œë“œíŒŒí‹° ì¿ í‚¤ ì°¨ë‹¨</b> ë˜ëŠ” <b>ê´‘ê³  ì°¨ë‹¨</b> ë•Œë¬¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        ì•„ë˜ "ìœ íŠœë¸Œì—ì„œ ì—´ê¸°"ë¡œ í•œ ë²ˆ ë™ì˜í•œ ë’¤ ëŒì•„ì˜¤ì„¸ìš”.
      </div>
      <div class="row wrap" style="margin-top:6px;gap:6px"><button id="openYT" class="link" type="button" hidden>ìœ íŠœë¸Œì—ì„œ ì—´ê¸° (ìƒˆ ì°½)</button></div>
    </div>

    <!-- í”Œë ˆì´ì–´ -->
    <div class="player-wrap ratio-16x9" id="playerWrap">
      <div id="player"></div>
      <div class="tap-catcher" id="tapCatcher" aria-hidden="true"></div>

      <div class="center-play is-hidden" id="overlay" aria-hidden="true">
        <button class="btn" id="overlayPlay" type="button" aria-label="ì¬ìƒ"><div class="triangle" aria-hidden="true"></div></button>
      </div>

      <!-- í™”ë©´ ì•ˆ ì˜¤ë²„ë ˆì´ ì»¨íŠ¸ë¡¤ -->
      <div class="overlay-ctrl is-hidden" id="overlayCtrl" aria-hidden="true">
        <div class="bar"></div>

        <!-- ìƒë‹¨: íŒŒíŠ¸ í€µë²„íŠ¼ 6ê°œ (ê°€ìš´ë° ì •ë ¬) -->
        <div class="topbar" id="topQuick">
          <button class="pill min qpart" data-key="ch" title="í•©ì°½">Ch</button>
          <button class="pill min qpart" data-key="sop" title="ì†Œí”„ë¼ë…¸">So</button>
          <button class="pill min qpart" data-key="alt" title="ì•Œí† ">Al</button>
          <button class="pill min qpart" data-key="ten" title="í…Œë„ˆ">Te</button>
          <button class="pill min qpart" data-key="bas" title="ë² ì´ìŠ¤">Ba</button>
          <button class="pill min qpart" data-key="sol" title="ì†”ë¡œ">Sl</button>
        </div>

        <!-- ì¢Œì¸¡(ì„¸ë¡œ, ê°€ìš´ë° ì •ë ¬) -->
        <div class="left">
          <button class="secondary" id="toStart" type="button" title="ì˜ìƒ ì‹œì‘ ìœ„ì¹˜ë¡œ ê°€ê¸°">â®ï¸ ì‹œì‘</button>
          <button class="secondary" id="playToggle" type="button" title="ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶ ì¬ìƒ</button>
          <button class="secondary" id="back5" type="button" title="5ì´ˆ ì „">âª 5ì´ˆì „</button>
          <button class="secondary" id="fwd5" type="button" title="5ì´ˆ í›„">5ì´ˆí›„ â©</button>
          <div class="vol" id="volWrap" title="ë³¼ë¥¨">
            <button class="secondary" id="muteToggle" type="button">ğŸ”Š</button>
            <div class="volslider"><input id="vol" type="range" min="0" max="100" value="100" /></div>
          </div>
          <div class="time-label" id="timeLabel">0:00 / 0:00</div>
        </div>

        <!-- ìš°ì¸¡(ì„¸ë¡œ, ê°€ìš´ë° ì •ë ¬) -->
        <div class="right">
          <button class="secondary" id="ccToggle" type="button" title="ìë§‰">CC</button>
          <div style="position:relative">
            <button class="secondary" id="qualityBtn" type="button" title="í™”ì§ˆ ì„¤ì •" data-compact="1">âš™ï¸ í™”ì§ˆ</button>
            <div class="menu" id="qualityMenu"></div>
          </div>
          <button class="secondary" id="fsToggle" type="button" title="ì „ì²´í™”ë©´/ì¢…ë£Œ" data-compact="1">â›¶ ì „ì²´í™”ë©´</button>
        </div>

        <!-- í•˜ë‹¨: AB í€µë²„íŠ¼ 3ê°œ (ê°€ìš´ë° ì •ë ¬) -->
        <div class="bottombar" id="bottomQuick">
          <button class="pill" id="qSetA" title="í˜„ì¬ ìœ„ì¹˜ë¥¼ Aë¡œ ì„¤ì •">Aì§€ì </button>
          <button class="pill" id="qSetB" title="í˜„ì¬ ìœ„ì¹˜ë¥¼ Bë¡œ ì„¤ì •">Bì§€ì </button>
          <button class="pill" id="qToggleAB" title="Aâ€“B ë°˜ë³µ ì¼œê¸°/ë„ê¸°">Aâ€“B ë°˜ë³µ: OFF</button>
        </div>
      </div>
    </div>

    <div class="seek-dock" id="seekDock" aria-label="ì¬ìƒ ìœ„ì¹˜">
      <input id="seek" class="seek" type="range" min="0" max="1000" value="0" aria-label="ì¬ìƒ ìœ„ì¹˜" />
      <div class="dock-time" id="dockTime">0:00 / 0:00</div>
    </div>

    <div class="controls" aria-label="ì¬ìƒ ì»¨íŠ¸ë¡¤">
      <div class="ab-row" aria-label="Aâ€“B êµ¬ê°„ ë°˜ë³µ">
        <button class="secondary" id="setA" type="button" title="í˜„ì¬ ìœ„ì¹˜ë¥¼ Aë¡œ ì„¤ì • (ë‹¨ì¶•í‚¤ A)">Aì§€ì  ì„¤ì •</button>
        <button class="secondary" id="setB" type="button" title="í˜„ì¬ ìœ„ì¹˜ë¥¼ Bë¡œ ì„¤ì • (ë‹¨ì¶•í‚¤ B)">Bì§€ì  ì„¤ì •</button>
        <button class="secondary" id="toggleAB" type="button" title="Aâ€“B ë°˜ë³µ ì¼œê¸°/ë„ê¸° (ë‹¨ì¶•í‚¤ L)">Aâ€“B ë°˜ë³µ: OFF</button>
        <button class="ghost" id="clearAB" type="button" title="Aâ€“B ì§€ìš°ê¸° (ë‹¨ì¶•í‚¤ C)">Aâ€“B ì§€ìš°ê¸°</button>
        <div class="tags">
          <span id="tagA" class="tag a off" style="display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-brd);font-size:12px"><span class="dot" style="width:8px;height:8px;border-radius:999px;background:#2563eb"></span><b>A</b> <span class="val">â€”</span></span>
          <span id="tagB" class="tag b off" style="display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-brd);font-size:12px"><span class="dot" style="width:8px;height:8px;border-radius:999px;background:#22c55e"></span><b>B</b> <span class="val">â€”</span></span>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="help" style="margin-bottom:8px">
        ì•„ë˜ ì£¼ì†Œë¥¼ ë³µì‚¬í•´ ëŒ€ì›ë“¤ì—ê²Œ ë³´ë‚´ë©´, í˜ì´ì§€ê°€ í•´ë‹¹ ê³¡ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤. ì…ë ¥ëœ ë§í¬ ëª©ë¡ê³¼ ì œëª©ì€ <b>ê·¸ëŒ€ë¡œ ìœ ì§€</b>ë©ë‹ˆë‹¤.
      </div>
      <div class="share">
        <input id="share" type="text" readonly value="" aria-label="ê³µìœ  ì£¼ì†Œ" />
        <button id="copy" class="ghost" type="button">ì£¼ì†Œ ë³µì‚¬</button>
      </div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
  'use strict';
  var player=null,currentVideoId=null,seekTimer=null,userDragging=false,pendingVideoId=null;
  var aPoint=null,bPoint=null,abEnabled=false; var captionsOn=false;
  var partKeys=['ch','sop','alt','ten','bas','sol']; var partEls={};
  var mobileHideTimer=null; var els={};

  function gid(id){return document.getElementById(id)}
  function on(el,evt,fn,opts){ if(el&&el.addEventListener) el.addEventListener(evt,fn,opts||false) }
  function formatTime(sec){sec=Math.max(0,Math.floor(sec||0));var m=(sec/60)|0,s=sec%60;return m+':'+(s<10?('0'+s):s)}

  function collectPartRows(){
    var rows=document.querySelectorAll('.part-row');
    for(var i=0;i<rows.length;i++){
      var row=rows[i], key=row.getAttribute('data-key');
      partEls[key]={ row:row, label:row.querySelector('.part-label'), input:row.querySelector('.link'),
        paste:row.querySelector('.paste'), remove:row.querySelector('.remove') };
    }
  }

  function extractYouTubeId(input){
    if(!input) return null;
    var str=String(input).trim();
    if(/^[a-zA-Z0-9_-]{11}$/.test(str)) return str;
    try{
      var u=new URL(str);
      var host=u.hostname.replace(/^www\./,'');
      if(host==='youtu.be'){
        var seg=u.pathname.split('/').filter(Boolean);
        if(seg[0]&&/^[A-Za-z0-9_-]{11}$/.test(seg[0])) return seg[0];
      }
      if(/youtube\.com$/.test(host)){
        var v=u.searchParams.get('v'); if(v&&/^[A-Za-z0-9_-]{11}$/.test(v)) return v;
        var m1=u.pathname.match(/\/embed\/([A-Za-z0-9_-]{11})/); if(m1) return m1[1];
        var m2=u.pathname.match(/\/shorts\/([A-Za-z0-9_-]{11})/); if(m2) return m2[1];
      }
    }catch(e){
      var m=str.match(/[?&]v=([A-Za-z0-9_-]{11})/); if(m) return m[1];
      var m2=str.match(/youtu\.be\/([A-Za-z0-9_-]{11})/); if(m2) return m2[1];
    }
    return null;
  }

  function setCenterOverlay(show){
    var el=els.overlay; if(!el) return;
    if(show){ el.hidden=false; requestAnimationFrame(function(){ el.classList.remove('is-hidden'); }); }
    else { el.classList.add('is-hidden'); }
    el.setAttribute('aria-hidden',String(!show));
  }
  function setControlsOverlay(show){
    var el=els.overlayCtrl; if(!el) return;
    if(show){ el.hidden=false; requestAnimationFrame(function(){ el.classList.remove('is-hidden'); }); }
    else { el.classList.add('is-hidden'); }
    el.setAttribute('aria-hidden',String(!show));
  }
  function showControlsTemporarily(){
    setControlsOverlay(true);
    clearTimeout(mobileHideTimer);
    try{
      var YTS=(window.YT&&YT.PlayerState)||{};
      var st=player&&player.getPlayerState?player.getPlayerState():null;
      if(st===YTS.PLAYING||st===YTS.BUFFERING){
        mobileHideTimer=setTimeout(function(){ setControlsOverlay(false); }, 2500);
      }
    }catch(e){}
  }

  function updatePlayToggleUI(){
    try{
      var YTS=(window.YT&&YT.PlayerState)||{};
      var st=player&&player.getPlayerState?player.getPlayerState():null;
      var playing=(st===YTS.PLAYING||st===YTS.BUFFERING);
      if(els.playToggle) els.playToggle.textContent=playing?'â¸ ì¼ì‹œì •ì§€':'â–¶ ì¬ìƒ';
    }catch(e){ if(els.playToggle) els.playToggle.textContent='â–¶ ì¬ìƒ'; }
  }
  function updateMuteUI(){ try{ if(els.muteToggle) els.muteToggle.textContent=(player&&player.isMuted&&player.isMuted())?'ğŸ”‡':'ğŸ”Š'; }catch(e){} }
  function updateFsUI(){ if(els.fsToggle) els.fsToggle.textContent = document.fullscreenElement? 'â›¶ ì¢…ë£Œ':'â›¶ ì „ì²´í™”ë©´'; }
  function showError(msg){ var e=els.err; if(e) e.textContent=msg||''; if(msg){ setTimeout(function(){ if(els&&els.err) els.err.textContent=''; }, 5000); } }

  function collectPartIds(){
    var map={};
    for(var i=0;i<partKeys.length;i++){
      var k=partKeys[i], p=partEls[k];
      var val=p&&p.input&&p.input.value?p.input.value.trim():'';
      var id=extractYouTubeId(val);
      if(id) map[k]=id;
    }
    return map;
  }
  function updateShareLink(currentId){
    var url; try{ url=new URL(location.href);}catch(e){return;}
    url.search='';
    var map=collectPartIds();
    if(currentId) url.searchParams.set('v',currentId);
    var title=els.titleInput&&els.titleInput.value?els.titleInput.value.trim():'';
    if(title) url.searchParams.set('t',title);
    for(var k in map){ url.searchParams.set(k,map[k]); }
    if(abEnabled&&aPoint!=null&&bPoint!=null&&bPoint>aPoint){
      url.searchParams.set('a',Math.floor(aPoint));
      url.searchParams.set('b',Math.floor(bPoint));
    }
    if(els.share) els.share.value=url.toString();
    try{ history.replaceState({},'',url.toString()); }catch(e){}
    if(currentId&&els.openYT){
      els.openYT.onclick=function(){ window.open('https://www.youtube.com/watch?v='+currentId,'_blank','noopener'); };
    }
  }

  function setVolume(v){ try{ v=Math.max(0,Math.min(100,Number(v))); if(player&&player.setVolume) player.setVolume(v);}catch(e){} }
  function updateSeekABBG(){
    var dur=(player&&player.getDuration)?player.getDuration():0;
    if(els.seek&&dur>0&&aPoint!=null&&bPoint!=null&&bPoint>aPoint){
      var aPct=Math.max(0,Math.min(100,(aPoint/dur)*100));
      var bPct=Math.max(0,Math.min(100,(bPoint/dur)*100));
      els.seek.style.backgroundImage='linear-gradient(to right,#374151 0%,#374151 '+aPct+'%,#2563eb '+aPct+'%,#2563eb '+bPct+'%,#374151 '+bPct+'%,#374151 100%)';
    } else if(els.seek){
      els.seek.style.backgroundImage='';
    }
  }
  function setAHere(){ try{ aPoint=Math.max(0,player&&player.getCurrentTime?player.getCurrentTime():0);}catch(e){ aPoint=0; } if(bPoint!=null&&bPoint<=aPoint){ bPoint=null; } updateABUI(); if(abEnabled){ try{ if(player&&player.seekTo) player.seekTo(aPoint,true);}catch(e){} } }
  function setBHere(){
    var dur=(player&&player.getDuration)?player.getDuration():0;
    try{ bPoint=Math.min(dur||Infinity,player&&player.getCurrentTime?player.getCurrentTime():0);}catch(e){ bPoint=null; }
    if(aPoint==null){ showError('ë¨¼ì € A ì§€ì ì„ ì„¤ì •í•´ ì£¼ì„¸ìš”.'); return; }
    if(bPoint!=null&&bPoint<=aPoint){ showError('BëŠ” Aë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.'); bPoint=null; }
    updateABUI();
  }
  function toggleABLoop(){
    if(!abEnabled){
      if(aPoint==null||bPoint==null||bPoint<=aPoint){ showError('Aì™€ Bë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •í•´ ì£¼ì„¸ìš”.'); return; }
      abEnabled=true;
      try{ if(player&&player.seekTo) player.seekTo(aPoint,true); if(player&&player.playVideo) player.playVideo(); }catch(e){}
    } else { abEnabled=false; }
    updateABUI();
  }
  function clearAB(){ aPoint=null; bPoint=null; abEnabled=false; updateABUI(); }
  function updateABUI(){
    var aTxt=(aPoint==null)?'â€”':formatTime(aPoint);
    var bTxt=(bPoint==null)?'â€”':formatTime(bPoint);
    var ta=els.tagA,tb=els.tagB;
    if(ta){ var v=ta.querySelector('.val'); if(v) v.textContent=aTxt; ta.classList.toggle('off',aPoint==null); }
    if(tb){ var v2=tb.querySelector('.val'); if(v2) v2.textContent=bTxt; tb.classList.toggle('off',bPoint==null); }
    if(els.toggleAB) els.toggleAB.textContent='Aâ€“B ë°˜ë³µ: '+(abEnabled?'ON':'OFF');
    if(els.qToggleAB) els.qToggleAB.textContent='Aâ€“B ë°˜ë³µ: '+(abEnabled?'ON':'OFF');
    updateSeekABBG();
    updateShareLink(currentVideoId||'');
  }

  function setupSeekTimer(){
    clearInterval(seekTimer);
    seekTimer=setInterval(function(){
      if(!player||userDragging) return;
      var dur=player&&player.getDuration?player.getDuration():0;
      var cur=player&&player.getCurrentTime?player.getCurrentTime():0;

      try{
        var YTS=(window.YT&&YT.PlayerState)||{};
        var st=player&&player.getPlayerState?player.getPlayerState():null;
        if(st===YTS.PLAYING||st===YTS.BUFFERING){ setCenterOverlay(false); }
        else if(st===YTS.PAUSED||st===YTS.CUED){ setCenterOverlay(true); setControlsOverlay(true); }
      }catch(e){}

      if(abEnabled&&aPoint!=null&&bPoint!=null&&bPoint>aPoint&&dur>0){
        if(cur<aPoint-0.08||cur>=bPoint-0.08){
          try{ player&&player.seekTo&&player.seekTo(aPoint,true); player&&player.playVideo&&player.playVideo(); }catch(e){}
        }
      }

      var tl=gid('timeLabel'); if(tl) tl.textContent=formatTime(cur)+' / '+formatTime(dur);
      var dt=gid('dockTime'); if(dt) dt.textContent=formatTime(cur)+' / '+formatTime(dur);
      if(els.seek&&dur>0){ els.seek.value=Math.min(1000,Math.floor((cur/dur)*1000)); }
      updateSeekABBG();
    },200);
  }

  function createOrLoadPlayer(videoId,startAt){
    if(typeof startAt==='undefined') startAt=0;
    var isHttp=(location.protocol==='http:'||location.protocol==='https:');
    var originParam=isHttp?location.origin:undefined;

    if(!window.YT||!YT.Player){
      pendingVideoId=videoId; showError('ìœ íŠœë¸Œ API ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ì¬ìƒë©ë‹ˆë‹¤.'); return;
    }
    if(player){
      try{ if(player.loadVideoById) player.loadVideoById({videoId:videoId,startSeconds:startAt}); }catch(e){}
      return;
    }
    player=new YT.Player('player',{
      host:'https://www.youtube-nocookie.com',
      videoId:videoId,
      playerVars:{ origin:originParam, autoplay:0, controls:0, modestbranding:1, rel:0, fs:1, playsinline:1, loop:0, enablejsapi:1, cc_load_policy:captionsOn?1:0 },
      events:{ onReady:onPlayerReady, onStateChange:onPlayerStateChange, onError:onPlayerError }
    });
    setTimeout(function(){
      try{
        var iframe=player&&player.getIframe?player.getIframe():null;
        var empty=iframe&&iframe.src&&iframe.src.indexOf('about:blank')>-1;
        if(empty) showCookieHelp();
      }catch(e){}
    },2000);
  }

  function rebuildPlayerKeepTime(){
    if(!player||!currentVideoId) return;
    var t=0; try{ t=player.getCurrentTime?player.getCurrentTime():0; }catch(e){}
    try{ if(player.destroy) player.destroy(); }catch(e){}
    player=null; createOrLoadPlayer(currentVideoId,t);
  }

  function onPlayerReady(){
    setupSeekTimer();
    setVolume(els.vol&&typeof els.vol.value!=='undefined'?els.vol.value:100);
    try{
      var iframe=player&&player.getIframe?player.getIframe():null;
      if(iframe&&iframe.setAttribute){
        iframe.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
        iframe.setAttribute('referrerpolicy','strict-origin-when-cross-origin');
      }
    }catch(e){}
    setCenterOverlay(true); setControlsOverlay(true);
    updatePlayToggleUI(); updateMuteUI(); updateFsUI();
  }

  function onPlayerStateChange(e){
    var YTS=(window.YT&&YT.PlayerState)||{};
    if(e&&e.data===YTS.ENDED){
      try{
        player.seekTo&&player.seekTo(aPoint!=null?aPoint:0,true);
        player.playVideo&&player.playVideo();
      }catch(err){}
    }
    if(e&&(e.data===YTS.PLAYING||e.data===YTS.BUFFERING)){ setCenterOverlay(false); showControlsTemporarily(); hideCookieHelp(); }
    else if(e&&(e.data===YTS.PAUSED||e.data===YTS.CUED||e.data===YTS.UNSTARTED)){ setCenterOverlay(true); setControlsOverlay(true); hideCookieHelp(); }
    updatePlayToggleUI();
  }

  function onPlayerError(e){
    var code=e&&e.data;
    if(code===101||code===150) showError('ì´ ì˜ìƒì€ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì¬ìƒì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤. "ìœ íŠœë¸Œì—ì„œ ì—´ê¸°"ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
    else showError('ë™ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
    showCookieHelp();
  }
  function showCookieHelp(){ if(els.cookieHelp) els.cookieHelp.hidden=false; if(els.openYT) els.openYT.hidden=false; }
  function hideCookieHelp(){ if(els.cookieHelp) els.cookieHelp.hidden=true; if(els.openYT) els.openYT.hidden=true; }

  function loadVideo(videoId){
    currentVideoId=videoId;
    if(!window.YT||!YT.Player){
      pendingVideoId=videoId; updateShareLink(videoId);
      setCenterOverlay(true); setControlsOverlay(true);
      showError('ìœ íŠœë¸Œ API ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì¤€ë¹„ë˜ë©´ ìë™ìœ¼ë¡œ ì¬ìƒí•©ë‹ˆë‹¤.');
      return;
    }
    var startAt=(abEnabled&&aPoint!=null)?aPoint:0;
    createOrLoadPlayer(videoId,startAt);
    updateShareLink(videoId);
    setCenterOverlay(true); setControlsOverlay(true);
    showError('');
  }

  function tryPlayFromRow(p){
    if(!p||!p.input) return;
    var id=extractYouTubeId(p.input.value||'');
    if(!id){ showError('ìœ íš¨í•œ ìœ íŠœë¸Œ ë§í¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    loadVideo(id);
  }

  function initUI(){
    els={
      titleInput:gid('titleInput'), titlePaste:gid('titlePaste'), titleClear:gid('titleClear'),
      err:gid('err'), overlay:gid('overlay'), overlayCtrl:gid('overlayCtrl'), overlayPlay:gid('overlayPlay'),
      tapCatcher:gid('tapCatcher'), seek:gid('seek'), back5:gid('back5'), fwd5:gid('fwd5'),
      playToggle:gid('playToggle'), timeLabel:gid('timeLabel'), toStart:gid('toStart'),
      muteToggle:gid('muteToggle'), vol:gid('vol'), volWrap:gid('volWrap'), fsToggle:gid('fsToggle'),
      qualityBtn:gid('qualityBtn'), qualityMenu:gid('qualityMenu'), ccToggle:gid('ccToggle'),
      share:gid('share'), copy:gid('copy'), openYT:gid('openYT'),
      cookieHelp:gid('cookieHelp'), playerWrap:gid('playerWrap'),
      setA:gid('setA'), setB:gid('setB'), toggleAB:gid('toggleAB'), clearAB:gid('clearAB'),
      tagA:gid('tagA'), tagB:gid('tagB'),
      qSetA:gid('qSetA'), qSetB:gid('qSetB'), qToggleAB:gid('qToggleAB')
    };

    collectPartRows();

    /* íŒŒíŠ¸ ë¼ë²¨: í´ë¦­/í‚¤ë³´ë“œ ì¬ìƒ, ë¶™ì—¬ë„£ê¸°/ì‚­ì œ/ë³€ê²½ */
    for(var k in partEls){ (function(p){
      if(p.label){
        on(p.label,'click',function(){ tryPlayFromRow(p); });
        on(p.label,'keydown',function(ev){
          var code=ev.key||ev.code||'';
          if(code==='Enter'||code===' '||code==='Spacebar'){ ev.preventDefault(); tryPlayFromRow(p); }
        });
      }
      on(p.paste,'click',function(){
        if(navigator.clipboard&&navigator.clipboard.readText){
          navigator.clipboard.readText()
            .then(function(txt){ if(p.input) p.input.value=txt; updateShareLink(currentVideoId||''); })
            .catch(function(){ var txt=window.prompt('ë§í¬ë¥¼ ë¶™ì—¬ ë„£ì–´ ì£¼ì„¸ìš”:',''); if(txt){ p.input.value=txt; updateShareLink(currentVideoId||''); }});
        } else {
          var t=window.prompt('ë§í¬ë¥¼ ë¶™ì—¬ ë„£ì–´ ì£¼ì„¸ìš”:',''); if(t){ p.input.value=t; updateShareLink(currentVideoId||''); }
        }
      });
      on(p.remove,'click',function(){ if(p.input) p.input.value=''; updateShareLink(currentVideoId||''); });
      on(p.input,'change',function(){ updateShareLink(currentVideoId||''); });
    })(partEls[k]); }

    /* ìƒë‹¨ í€µ íŒŒíŠ¸ ë²„íŠ¼: ë™ì˜ìƒ ì•ˆì—ì„œ ë°”ë¡œ ì¬ìƒ */
    document.querySelectorAll('.qpart').forEach(function(btn){
      on(btn,'click',function(){
        var key=btn.getAttribute('data-key');
        var p=partEls[key];
        tryPlayFromRow(p);
      });
    });

    /* í•˜ë‹¨ í€µ AB ë²„íŠ¼ */
    on(els.qSetA,'click',setAHere);
    on(els.qSetB,'click',setBHere);
    on(els.qToggleAB,'click',toggleABLoop);

    /* ì¤‘ì•™ ì˜¤ë²„ë ˆì´ í° ì¬ìƒ */
    on(els.overlayPlay,'click',function(){ setCenterOverlay(false); player&&player.playVideo&&player.playVideo(); });

    /* ì¢Œì¸¡ ì»¨íŠ¸ë¡¤ */
    on(els.playToggle,'click',function(){
      try{
        var YTS=(window.YT&&YT.PlayerState)||{};
        var st=player&&player.getPlayerState?player.getPlayerState():null;
        if(st===YTS.PLAYING||st===YTS.BUFFERING){ player&&player.pauseVideo&&player.pauseVideo(); setCenterOverlay(true); setControlsOverlay(true); }
        else { setCenterOverlay(false); showControlsTemporarily(); player&&player.playVideo&&player.playVideo(); }
      }catch(e){}
      updatePlayToggleUI();
    });
    on(els.toStart,'click',function(){ player&&player.seekTo&&player.seekTo(0,true); });
    on(els.back5,'click',function(){ var t=Math.max(0,(player&&player.getCurrentTime?player.getCurrentTime():0)-5); player&&player.seekTo&&player.seekTo(t,true); });
    on(els.fwd5,'click',function(){ var dur=(player&&player.getDuration?player.getDuration():0); var t=Math.min(dur,(player&&player.getCurrentTime?player.getCurrentTime():0)+5); player&&player.seekTo&&player.seekTo(t,true); });

    /* ë³¼ë¥¨/ì‹œí¬ */
    on(els.muteToggle,'click',function(){ try{ if(player&&player.isMuted&&player.isMuted()){ player.unMute&&player.unMute(); } else { player&&player.mute&&player.mute(); } }catch(e){} updateMuteUI(); });
    on(els.vol,'input',function(e){ setVolume(e&&e.target?e.target.value:100); });
    on(els.volWrap,'click',function(e){ if(e&&e.target===els.muteToggle) return; els.volWrap.classList.toggle('show'); });

    on(els.seek,'input',function(){
      userDragging=true;
      var dur=(player&&player.getDuration)?player.getDuration():0;
      var pos=Number(els.seek.value)/1000; var t=dur*pos;
      var tl=gid('timeLabel'), dt=gid('dockTime');
      if(tl) tl.textContent=formatTime(t)+' / '+formatTime(dur);
      if(dt) dt.textContent=formatTime(t)+' / '+formatTime(dur);
    });
    on(els.seek,'change',function(){
      var dur=(player&&player.getDuration)?player.getDuration():0;
      var pos=Number(els.seek.value)/1000; var t=dur*pos;
      player&&player.seekTo&&player.seekTo(t,true); userDragging=false;
    });

    /* ì „ì²´í™”ë©´ */
    on(els.fsToggle,'click',function(){ var wrap=gid('playerWrap'); if(!document.fullscreenElement){ wrap&&wrap.requestFullscreen&&wrap.requestFullscreen(); } else { document.exitFullscreen&&document.exitFullscreen(); } });
    document.addEventListener('fullscreenchange', updateFsUI);

    /* í’ˆì§ˆ ë©”ë‰´ */
    on(els.qualityBtn,'click',function(e){ e&&e.stopPropagation&&e.stopPropagation(); if(!els.qualityMenu) return; if(els.qualityMenu.classList.contains('open')) els.qualityMenu.classList.remove('open'); else openQualityMenu(); });
    document.addEventListener('click', function(){ els.qualityMenu&&els.qualityMenu.classList.remove('open'); });

    /* CC í† ê¸€ */
    function updateCCToggleUI(){ els.ccToggle&& (els.ccToggle.textContent=captionsOn?'CC ì¼œì§':'CC êº¼ì§'); }
    on(els.ccToggle,'click',function(){ captionsOn=!captionsOn; updateCCToggleUI(); rebuildPlayerKeepTime(); });
    updateCCToggleUI();

    /* ê³µìœ  ë³µì‚¬ */
    on(els.copy,'click',function(){
      if(!els.share) return; var txt=els.share.value||'';
      if(navigator.clipboard&&navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).then(function(){ els.copy.textContent='ë³µì‚¬ë¨!'; setTimeout(function(){ els.copy.textContent='ì£¼ì†Œ ë³µì‚¬'; },1500); })
        .catch(function(){ try{ els.share.select(); document.execCommand('copy'); els.copy.textContent='ë³µì‚¬ë¨!'; setTimeout(function(){ els.copy.textContent='ì£¼ì†Œ ë³µì‚¬'; },1500);}catch(e){} });
      } else { try{ els.share.select(); document.execCommand('copy'); }catch(e){} }
    });

    /* ì œëª© ë¶™ì—¬ë„£ê¸°/ì‚­ì œ */
    on(els.titlePaste,'click',function(){
      if(navigator.clipboard&&navigator.clipboard.readText){
        navigator.clipboard.readText().then(function(txt){ els.titleInput&&(els.titleInput.value=txt); updateShareLink(currentVideoId||''); })
        .catch(function(){ var t=window.prompt('ì œëª©ì„ ë¶™ì—¬ ë„£ì–´ ì£¼ì„¸ìš”:',''); if(typeof t==='string'){ els.titleInput.value=t; updateShareLink(currentVideoId||''); } });
      } else {
        var t=window.prompt('ì œëª©ì„ ë¶™ì—¬ ë„£ì–´ ì£¼ì„¸ìš”:',''); if(typeof t==='string'){ els.titleInput.value=t; updateShareLink(currentVideoId||''); }
      }
    });
    on(els.titleClear,'click',function(){ els.titleInput&&(els.titleInput.value=''); updateShareLink(currentVideoId||''); });
    on(els.titleInput,'change',function(){ updateShareLink(currentVideoId||''); });

    /* í”Œë ˆì´ì–´ ì˜ì—­ íƒ­/í˜¸ë²„ */
    on(els.playerWrap,'mouseenter',function(){ setControlsOverlay(true); });
    on(els.playerWrap,'mousemove',function(){ setControlsOverlay(true); });
    on(els.playerWrap,'mouseleave',function(){
      try{
        var YTS=(window.YT&&YT.PlayerState)||{};
        var st=player&&player.getPlayerState?player.getPlayerState():null;
        if(st===YTS.PLAYING||st===YTS.BUFFERING) setControlsOverlay(false);
      }catch(e){}
    });

    function handleSurfaceTap(){
      try{
        var YTS=(window.YT&&YT.PlayerState)||{};
        var st=player&&player.getPlayerState?player.getPlayerState():null;
        if(st===YTS.PLAYING||st===YTS.BUFFERING){
          player&&player.pauseVideo&&player.pauseVideo();
          setCenterOverlay(true); setControlsOverlay(true);
        } else {
          setCenterOverlay(false);
          player&&player.playVideo&&player.playVideo();
        }
      }catch(e){ setControlsOverlay(true); }
    }
    on(els.playerWrap,'click',function(e){
      if(els.overlayCtrl && els.overlayCtrl.contains(e.target)) return; // ì˜¤ë²„ë ˆì´ ë‚´ë¶€ ë²„íŠ¼ í´ë¦­ì€ í†µê³¼
      if(els.overlay && els.overlay.contains(e.target)) return;
      handleSurfaceTap();
    });
    on(els.tapCatcher,'touchstart',function(ev){ try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){} handleSurfaceTap(); }, {passive:false});
    on(els.tapCatcher,'click',function(ev){ try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){} handleSurfaceTap(); });

    // ì´ˆê¸° AB í† ê¸€ í…ìŠ¤íŠ¸ ë™ê¸°í™”
    updateABUI();
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',initUI); else initUI();

  window.onYouTubeIframeAPIReady=function(){
    var params=new URLSearchParams(location.search);
    var vParam=params.get('v');
    var tParam=params.get('t');
    els.titleInput&&tParam&&(els.titleInput.value=tParam);

    // Aâ€“B ë³µì›
    var aParam=Number(params.get('a')); var bParam=Number(params.get('b'));
    if(!isNaN(aParam)&&!isNaN(bParam)&&bParam>aParam){ aPoint=aParam; bPoint=bParam; abEnabled=true; updateABUI(); }

    // íŒŒíŠ¸ ë§í¬ ë³µì›
    for(var i=0;i<partKeys.length;i++){
      var k=partKeys[i]; var id=params.get(k);
      if(id&&/^[A-Za-z0-9_-]{11}$/.test(id)){
        var pe=document.querySelector('.part-row[data-key="'+k+'"] .link');
        if(pe){ pe.value='https://www.youtube.com/watch?v='+id; }
      }
    }

    var initialId=extractYouTubeId(vParam||'')||pendingVideoId;
    if(initialId){ pendingVideoId=null; loadVideo(initialId); }
    else { setCenterOverlay(false); setControlsOverlay(false); updateShareLink(''); }
  };

  function mapQualityLabel(q){ var m={ small:'240p', medium:'360p', large:'480p', hd720:'720p', hd1080:'1080p', hd1440:'1440p', hd2160:'2160p', highres:'ê³ í•´ìƒë„' }; return m[q]||q; }
  function openQualityMenu(){
    try{
      var levels=(player&&player.getAvailableQualityLevels)?player.getAvailableQualityLevels():[];
      els.qualityMenu.innerHTML='';
      var opts=['default'].concat(levels);
      for(var i=0;i<opts.length;i++){
        (function(q){
          var btn=document.createElement('button');
          btn.textContent=(q==='default')? 'ìë™': mapQualityLabel(q);
          btn.addEventListener('click',function(){
            try{ player&&player.setPlaybackQuality&&player.setPlaybackQuality(q);}catch(e){}
            els.qualityMenu.classList.remove('open');
          });
          els.qualityMenu.appendChild(btn);
        })(opts[i]);
      }
      els.qualityMenu.classList.add('open');
    }catch(e){}
  }
  </script>
</body>
</html>
