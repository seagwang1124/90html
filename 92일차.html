<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì„±ê°€ëŒ€ ìœ íŠœë¸Œ ë°˜ë³µ í”Œë ˆì´ì–´</title>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827;     /* gray-900 */
      --panel-2: #1f2937;   /* gray-800 */
      --text: #e5e7eb;      /* gray-200 */
      --muted: #9ca3af;     /* gray-400 */
      --accent: #60a5fa;    /* blue-400 */
      --accent-2: #93c5fd;  /* blue-300 */
      --danger: #ef4444;
      --warn: #f59e0b;
      --ok: #22c55e;
      --chip-bg: #0b1220;
      --chip-brd: #334155;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 16px; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple SD Gothic Neo, "Apple Color Emoji", "Noto Color Emoji", sans-serif; }
    h1 { font-size: 22px; margin: 0 0 12px; letter-spacing: .2px; }
    .card { max-width: 1080px; margin: 0 auto; background: var(--panel); border: 1px solid #1f2937; border-radius: 14px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .section { padding: 14px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row.wrap { flex-wrap: wrap; }
    .grid { display: grid; gap: 8px; }

    input[type="text"], input[type="url"], input[type="search"] {
      flex: 1; min-width: 220px; background: var(--panel-2); color: var(--text); border: 1px solid #374151; border-radius: 10px; padding: 12px 14px; outline: none; transition: border .15s ease; }
    input[type="text"]:focus, input[type="url"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(96,165,250,.2); }
    button { background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: #0b1220; border: none; border-radius: 10px; padding: 10px 14px; font-weight: 700; cursor: pointer; white-space: nowrap; }
    button.secondary { background: #374151; color: var(--text); font-weight: 600; }
    button.ghost { background: transparent; border: 1px solid #374151; color: var(--text); }
    button.link { background: transparent; color: var(--accent-2); text-decoration: underline; }
    button:disabled { opacity: .6; cursor: not-allowed; }

    /* list rows */
    .parts { display: grid; gap: 8px; }
    .part-row { display: grid; grid-template-columns: auto 84px 1fr auto auto; gap: 8px; align-items: center; }
    .part-label { width: 84px; text-align: center; background: #0b1220; border: 1px solid #374151; border-radius: 10px; padding: 10px 6px; }

    /* Player area */
    .player-wrap { position: relative; background: #000; }
    .ratio-16x9 { width: 100%; aspect-ratio: 16 / 9; }
    #player { width: 100%; height: 100%; }

    /* Center Play Overlay + Fade */
    .center-play { position: absolute; inset: 0; display: grid; place-items: center; pointer-events: none; z-index: 5; opacity: 1; transition: opacity 180ms ease; }
    .center-play.is-hidden { opacity: 0; pointer-events: none; }
    .center-play .btn { pointer-events: auto; width: 88px; height: 88px; border-radius: 9999px; background: rgba(255,255,255,.92); border: none; display: grid; place-items: center; box-shadow: 0 10px 25px rgba(0,0,0,.45); cursor: pointer; transition: transform .1s ease; }
    .center-play .btn:hover { transform: scale(1.03); }
    .triangle { width: 0; height: 0; border-left: 26px solid #0b1220; border-top: 16px solid transparent; border-bottom: 16px solid transparent; margin-left: 6px; }

    /* Bottom Overlay Controls */
    .overlay-ctrl { position: absolute; left: 0; right: 0; bottom: 0; z-index: 6; color: #fff; opacity: 1; transition: opacity 180ms ease; }
    .overlay-ctrl.is-hidden { opacity: 0; pointer-events: none; }
    .overlay-ctrl .bar {
      background: linear-gradient(to top, rgba(0,0,0,0.75), rgba(0,0,0,0.35) 60%, transparent);
      padding: 10px 12px 12px;
      display: grid; gap: 8px;
    }
    .overlay-ctrl .seek { width: 100%; height: 8px; border-radius: 999px; background: #374151; appearance: none; }
    .overlay-ctrl .seek::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #fff; border: 2px solid #1f2937; }
    .overlay-ctrl .row { display: flex; align-items: center; gap: 8px; }
    .overlay-ctrl .left { display: flex; align-items: center; gap: 8px; flex: 1; }
    .overlay-ctrl .right { display: flex; align-items: center; gap: 8px; }

    .vol { display: inline-flex; align-items: center; gap: 6px; position: relative; }
    .volslider { width: 0; opacity: 0; overflow: hidden; transition: width 180ms ease, opacity 180ms ease; }
    .vol:hover .volslider, .vol.show .volslider { width: 140px; opacity: 1; }
    .volslider input { width: 140px; }

    .time-label { font-variant-numeric: tabular-nums; color: #e5e7eb; font-size: 12px; min-width: 96px; text-align: right; }

    /* Aâ€“B UI */
    .controls { background: var(--panel-2); border-top: 1px solid #374151; padding: 12px; display: grid; gap: 10px; }
    .ab-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .tags { display: flex; gap: 6px; align-items: center; margin-left: auto; }
    .tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: var(--chip-bg); border: 1px solid var(--chip-brd); color: var(--text); font-size: 12px; }
    .tag .dot { width: 8px; height: 8px; border-radius: 999px; background: #2563eb; }
    .tag.b .dot { background: #22c55e; }
    .tag.off { opacity: .55; }

    /* Quality menu */
    .menu { position: absolute; bottom: 48px; right: 12px; background: rgba(17,24,39,.96); border: 1px solid #374151; border-radius: 10px; padding: 6px; display: none; min-width: 160px; box-shadow: 0 10px 30px rgba(0,0,0,.45); }
    .menu.open { display: block; }
    .menu button { width: 100%; text-align: left; background: transparent; color: #e5e7eb; border: none; padding: 8px 10px; border-radius: 8px; }
    .menu button:hover { background: #1f2937; }

    /* Share */
    .share { display: flex; gap: 8px; align-items: center; }
    .help { color: var(--muted); font-size: 13px; }

    .err { color: var(--danger); font-size: 13px; margin-top: 6px; }
    .warn { color: var(--warn); font-size: 13px; margin-top: 6px; }
    .ok { color: var(--ok); font-size: 13px; margin-top: 6px; }

    @media (max-width: 720px) {
      .part-row { grid-template-columns: auto 80px 1fr auto auto; }
      .part-label { width: 80px; }
      .center-play .btn { width: 76px; height: 76px; }
      .triangle { border-left-width: 22px; border-top-width: 14px; border-bottom-width: 14px; }
      .vol:hover .volslider, .vol.show .volslider { width: 110px; }
      .volslider input { width: 110px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- 1. í° ì œëª© -->
    <div class="section">
      <h1>ì„±ê°€ëŒ€ ìœ íŠœë¸Œ ë°˜ë³µ í”Œë ˆì´ì–´</h1>
    </div>

    <!-- 2. ì°¬ì–‘ ì œëª© ì…ë ¥ -->
    <div class="section">
      <div class="row wrap" aria-label="ì°¬ì–‘ ì œëª© ì…ë ¥">
        <span class="part-label" style="width:auto;">ì°¬ì–‘ ì œëª©</span>
        <input id="titleInput" type="text" placeholder="ì˜ˆ: í• ë ë£¨ì•¼ ì°¬ì–‘" />
        <button id="titlePaste" class="ghost">ë¶™ì—¬ ë„£ê¸°</button>
        <button id="titleClear" class="ghost">ì‚­ì œ</button>
      </div>
    </div>

    <!-- 3. ê° íŒŒíŠ¸ ë§í¬ ëª©ë¡ -->
    <div class="section">
      <div class="help" style="margin-bottom:10px">ê° íŒŒíŠ¸ì— ìœ íŠœë¸Œ ì£¼ì†Œë¥¼ ë„£ê³ , <b>ì„ íƒ</b>ì„ ëˆ„ë¥´ë©´ í”Œë ˆì´ì–´ì— ì—°ê²°ë©ë‹ˆë‹¤.</div>
      <div class="parts" id="parts">
        <!-- í•©ì°½ -->
        <div class="part-row" data-key="ch">
          <button class="secondary pick">ì„ íƒ</button>
          <span class="part-label">í•© ì°½</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste">ë§í¬ ë„£ê¸°</button>
          <button class="ghost remove">ì‚­ì œ</button>
        </div>
        <!-- ì†Œí”„ë¼ë…¸ -->
        <div class="part-row" data-key="sop">
          <button class="secondary pick">ì„ íƒ</button>
          <span class="part-label">ì†Œí”„ë¼ë…¸</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste">ë§í¬ ë„£ê¸°</button>
          <button class="ghost remove">ì‚­ì œ</button>
        </div>
        <!-- ì•Œí†  -->
        <div class="part-row" data-key="alt">
          <button class="secondary pick">ì„ íƒ</button>
          <span class="part-label">ì•Œ í† </span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste">ë§í¬ ë„£ê¸°</button>
          <button class="ghost remove">ì‚­ì œ</button>
        </div>
        <!-- í…Œë„ˆ -->
        <div class="part-row" data-key="ten">
          <button class="secondary pick">ì„ íƒ</button>
          <span class="part-label">í…Œ ë„ˆ</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste">ë§í¬ ë„£ê¸°</button>
          <button class="ghost remove">ì‚­ì œ</button>
        </div>
        <!-- ë² ì´ìŠ¤ -->
        <div class="part-row" data-key="bas">
          <button class="secondary pick">ì„ íƒ</button>
          <span class="part-label">ë² ì´ìŠ¤</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste">ë§í¬ ë„£ê¸°</button>
          <button class="ghost remove">ì‚­ì œ</button>
        </div>
        <!-- ì†”ë¡œ -->
        <div class="part-row" data-key="sol">
          <button class="secondary pick">ì„ íƒ</button>
          <span class="part-label">ì†” ë¡œ</span>
          <input class="link" type="url" placeholder="https://youtu.be/VIDEO_ID" />
          <button class="ghost paste">ë§í¬ ë„£ê¸°</button>
          <button class="ghost remove">ì‚­ì œ</button>
        </div>
      </div>
      <div id="err" class="err" aria-live="polite"></div>
      <div id="cookieHelp" class="warn" hidden>ì„ë² ë“œê°€ ë³´ì´ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì €ì˜ <b>ì„œë“œíŒŒí‹° ì¿ í‚¤ ì°¨ë‹¨</b> ë˜ëŠ” <b>ê´‘ê³  ì°¨ë‹¨</b> ë•Œë¬¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ "ìœ íŠœë¸Œì—ì„œ ì—´ê¸°"ë¡œ í•œ ë²ˆ ë™ì˜í•œ ë’¤ ëŒì•„ì˜¤ì„¸ìš”.</div>
      <div class="row wrap" style="margin-top:6px; gap:6px;">
        <button id="openYT" class="link" hidden>ìœ íŠœë¸Œì—ì„œ ì—´ê¸° (ìƒˆ ì°½)</button>
      </div>
    </div>

    <!-- 4. ë™ì˜ìƒ í”Œë ˆì´ì–´ -->
    <div class="player-wrap ratio-16x9" id="playerWrap">
      <div id="player"></div>

      <!-- ì¤‘ì•™ í° ì¬ìƒ ë²„íŠ¼ (í˜ì´ë“œ) -->
      <div class="center-play is-hidden" id="overlay" aria-hidden="true">
        <button class="btn" id="overlayPlay" aria-label="ì¬ìƒ">
          <div class="triangle" aria-hidden="true"></div>
        </button>
      </div>

      <!-- í•˜ë‹¨ ì˜¤ë²„ë ˆì´ ì»¨íŠ¸ë¡¤ (í˜ì´ë“œ) -->
      <div class="overlay-ctrl is-hidden" id="overlayCtrl" aria-hidden="true">
        <div class="bar">
          <!-- ê¸´ íƒ€ì„ë°” -->
          <input id="seek" class="seek" type="range" min="0" max="1000" value="0" aria-label="ì¬ìƒ ìœ„ì¹˜" />
          
          <!-- ë²„íŠ¼ í–‰ -->
          <div class="row">
            <div class="left">
              <button class="secondary" id="toStart" title="ì˜ìƒ ì‹œì‘ ìœ„ì¹˜ë¡œ ê°€ê¸°">â®ï¸ ì‹œì‘</button>
              <button class="secondary" id="playToggle" title="ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶ ì¬ìƒ</button>
              <button class="secondary" id="back5" title="5ì´ˆ ì „">âª 5ì´ˆì „</button>
              <button class="secondary" id="fwd5" title="5ì´ˆ í›„">5ì´ˆí›„ â©</button>

              <div class="vol" id="volWrap" title="ë³¼ë¥¨">
                <button class="secondary" id="muteToggle">ğŸ”Š</button>
                <div class="volslider"><input id="vol" type="range" min="0" max="100" value="100" /></div>
              </div>
              <div class="time-label" id="timeLabel">0:00 / 0:00</div>
            </div>
            <div class="right">
              <button class="secondary" id="fsToggle" title="ì „ì²´í™”ë©´/ì¢…ë£Œ">â›¶ ì „ì²´í™”ë©´</button>
              <div style="position:relative">
                <button class="secondary" id="qualityBtn" title="í™”ì§ˆ ì„¤ì •">âš™ï¸ í™”ì§ˆ</button>
                <div class="menu" id="qualityMenu"></div>
              </div>
              <button class="secondary" id="ccToggle" title="ìë§‰">CC</button>
              <button class="secondary" id="autoToggle" title="ìë™ ì¬ìƒ">ìë™ì¬ìƒ: ë”</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 4-2. ì•„ë˜ì—ëŠ” Aâ€“B ë°˜ë³µë§Œ ë‚¨ê¹€ -->
    <div class="controls" aria-label="ì¬ìƒ ì»¨íŠ¸ë¡¤">
      <div class="ab-row" aria-label="Aâ€“B êµ¬ê°„ ë°˜ë³µ">
        <button class="secondary" id="setA" title="í˜„ì¬ ìœ„ì¹˜ë¥¼ Aë¡œ ì„¤ì • (ë‹¨ì¶•í‚¤ A)">Aì§€ì  ì„¤ì •</button>
        <button class="secondary" id="setB" title="í˜„ì¬ ìœ„ì¹˜ë¥¼ Bë¡œ ì„¤ì • (ë‹¨ì¶•í‚¤ B)">Bì§€ì  ì„¤ì •</button>
        <button class="secondary" id="toggleAB" title="Aâ€“B ë°˜ë³µ ì¼œê¸°/ë„ê¸° (ë‹¨ì¶•í‚¤ L)">Aâ€“B ë°˜ë³µ: OFF</button>
        <button class="ghost" id="clearAB" title="Aâ€“B ì§€ìš°ê¸° (ë‹¨ì¶•í‚¤ C)">Aâ€“B ì§€ìš°ê¸°</button>
        <div class="tags">
          <span id="tagA" class="tag a off"><span class="dot"></span><b>A</b> <span class="val">â€”</span></span>
          <span id="tagB" class="tag b off"><span class="dot"></span><b>B</b> <span class="val">â€”</span></span>
        </div>
      </div>
    </div>

    <!-- 5. ê³µìœ  ì£¼ì†Œ -->
    <div class="section">
      <div class="help" style="margin-bottom:8px">ì•„ë˜ ì£¼ì†Œë¥¼ ë³µì‚¬í•´ ëŒ€ì›ë“¤ì—ê²Œ ë³´ë‚´ë©´, í˜ì´ì§€ê°€ í•´ë‹¹ ê³¡ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤. ì…ë ¥ëœ ë§í¬ ëª©ë¡ê³¼ ì œëª©ì€ <b>ê·¸ëŒ€ë¡œ ìœ ì§€</b>ë©ë‹ˆë‹¤.</div>
      <div class="share">
        <input id="share" type="text" readonly value="" aria-label="ê³µìœ  ì£¼ì†Œ" />
        <button id="copy" class="ghost">ì£¼ì†Œ ë³µì‚¬</button>
      </div>
    </div>
  </div>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // ====== ìœ í‹¸: YouTube ì˜ìƒ ID ì¶”ì¶œ ======
    function extractYouTubeId(input) {
      if (!input) return null;
      const str = String(input).trim();
      if (/^[a-zA-Z0-9_-]{11}$/.test(str)) return str; // 11ì IDë§Œ ì…ë ¥í•œ ê²½ìš°
      try {
        const u = new URL(str);
        const host = u.hostname.replace(/^www\./, "");
        if (host === 'youtu.be') {
          const seg = u.pathname.split('/').filter(Boolean);
          if (seg[0] && /^[a-zA-Z0-9_-]{11}$/.test(seg[0])) return seg[0];
        }
        if (host.endsWith('youtube.com')) {
          const v = u.searchParams.get('v'); if (v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return v; // watch
          const m1 = u.pathname.match(/\/embed\/([a-zA-Z0-9_-]{11})/); if (m1) return m1[1];
          const m2 = u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{11})/); if (m2) return m2[1];
        }
      } catch (e) {
        const m = str.match(/[?&]v=([a-zA-Z0-9_-]{11})/); if (m) return m[1];
        const m2 = str.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/); if (m2) return m2[1];
      }
      return null;
    }

    function formatTime(sec) { sec = Math.max(0, Math.floor(sec || 0)); const m = Math.floor(sec / 60); const s = sec % 60; return m + ':' + (s < 10 ? '0' + s : s); }

    // ====== ì „ì—­ ======
    let player = null;
    let currentVideoId = null;
    let seekTimer = null;
    let userDragging = false;
    let pendingVideoId = null; // YT ì¤€ë¹„ ì „ ì„ íƒ í

    // Aâ€“B ìƒíƒœ
    let aPoint = null; // seconds
    let bPoint = null; // seconds
    let abEnabled = false;

    // ì‚¬ìš©ì í™˜ê²½ ì„¤ì •
    let captionsOn = false;
    let autoPlayOn = false;

    const partKeys = ['ch','sop','alt','ten','bas','sol'];
    const partEls = {}; // {key: {row, input, pick, paste, remove}}

    const els = {
      titleInput: document.getElementById('titleInput'),
      titlePaste: document.getElementById('titlePaste'),
      titleClear: document.getElementById('titleClear'),
      parts: document.getElementById('parts'),
      err: document.getElementById('err'),
      overlay: document.getElementById('overlay'),
      overlayCtrl: document.getElementById('overlayCtrl'),
      overlayPlay: document.getElementById('overlayPlay'),
      seek: document.getElementById('seek'),
      back5: document.getElementById('back5'),
      fwd5: document.getElementById('fwd5'),
      playToggle: document.getElementById('playToggle'),
      timeLabel: document.getElementById('timeLabel'),
      toStart: document.getElementById('toStart'),
      muteToggle: document.getElementById('muteToggle'),
      vol: document.getElementById('vol'),
      volWrap: document.getElementById('volWrap'),
      fsToggle: document.getElementById('fsToggle'),
      qualityBtn: document.getElementById('qualityBtn'),
      qualityMenu: document.getElementById('qualityMenu'),
      ccToggle: document.getElementById('ccToggle'),
      autoToggle: document.getElementById('autoToggle'),
      share: document.getElementById('share'),
      copy: document.getElementById('copy'),
      openYT: document.getElementById('openYT'),
      cookieHelp: document.getElementById('cookieHelp'),
      // AB
      setA: document.getElementById('setA'),
      setB: document.getElementById('setB'),
      toggleAB: document.getElementById('toggleAB'),
      clearAB: document.getElementById('clearAB'),
      tagA: document.getElementById('tagA'),
      tagB: document.getElementById('tagB')
    };

    // ì•ˆì „ ì´ë²¤íŠ¸ ë°”ì¸ë”© í—¬í¼
    function on(el, evt, fn, opts){ if (el && el.addEventListener) el.addEventListener(evt, fn, opts); }

    // === DOMContentLoaded ì— ì´ˆê¸°í™” ì´ë™ (ë²„íŠ¼ ë¯¸ë°˜ì‘ ë°©ì§€) ===
    document.addEventListener('DOMContentLoaded', initUI);

    function initUI(){
      // íŒŒíŠ¸ í–‰ ìˆ˜ì§‘
      var rows = document.querySelectorAll('.part-row');
      for (var i=0; i<rows.length; i++){
        var row = rows[i];
        var key = row.getAttribute('data-key');
        partEls[key] = {
          row: row,
          input: row.querySelector('.link'),
          pick: row.querySelector('.pick'),
          paste: row.querySelector('.paste'),
          remove: row.querySelector('.remove')
        };
      }

      // ê° íŒŒíŠ¸: ì„ íƒ/ë§í¬ë„£ê¸°/ì‚­ì œ/ìˆ˜ì •
      Object.keys(partEls).forEach(function(k){
        var p = partEls[k];
        on(p.pick, 'click', function(){
          var id = extractYouTubeId((p.input && p.input.value) || '');
          if (!id) { showError('ìœ íš¨í•œ ìœ íŠœë¸Œ ë§í¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
          loadVideo(id);
        });
        on(p.paste, 'click', function(){
          try {
            navigator.clipboard.readText().then(function(txt){ if (p.input) p.input.value = txt; updateShareLink(currentVideoId || ''); }).catch(function(){ showError('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•´ ì£¼ì„¸ìš”.'); });
          } catch(e){ showError('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•´ ì£¼ì„¸ìš”.'); }
        });
        on(p.remove, 'click', function(){ if (p.input) p.input.value = ''; updateShareLink(currentVideoId || ''); });
        on(p.input, 'change', function(){ updateShareLink(currentVideoId || ''); });
      });

      // ì˜¤ë²„ë ˆì´ ì»¨íŠ¸ë¡¤
      on(els.overlayPlay, 'click', function(){ try { setOverlay(false); if (player && player.playVideo) player.playVideo(); } catch(e){} });
      on(els.playToggle, 'click', function(){
        try {
          var st = player && player.getPlayerState ? player.getPlayerState() : null;
          var YTS = (window.YT && YT.PlayerState) || {};
          if (st === YTS.PLAYING || st === YTS.BUFFERING) { player.pauseVideo(); }
          else { setOverlay(false); player.playVideo(); }
        } catch(e){}
        updatePlayToggleUI();
      });
      on(els.toStart, 'click', function(){ try { player && player.seekTo && player.seekTo(0, true); } catch(e){} });
      on(els.back5, 'click', function(){ try { var t = Math.max(0, ((player && player.getCurrentTime && player.getCurrentTime()) || 0) - 5); player.seekTo(t, true); } catch(e){} });
      on(els.fwd5, 'click', function(){ try { var d = (player && player.getDuration && player.getDuration()) || 0; var t = Math.min(d, ((player && player.getCurrentTime && player.getCurrentTime()) || 0) + 5); player.seekTo(t, true); } catch(e){} });
      on(els.muteToggle, 'click', function(){ try { if (player && player.isMuted && player.isMuted()) player.unMute(); else if (player && player.mute) player.mute(); } catch(e){} updateMuteUI(); });
      on(els.vol, 'input', function(e){ setVolume(e.target.value); });
      on(els.volWrap, 'click', function(e){ if (e.target === els.muteToggle) return; if (els.volWrap && els.volWrap.classList) els.volWrap.classList.toggle('show'); });

      on(els.seek, 'input', function(){ userDragging = true; var dur = (player && player.getDuration && player.getDuration()) || 0; var pos = Number(els.seek.value) / 1000; var t = dur * pos; if (els.timeLabel) els.timeLabel.textContent = formatTime(t) + ' / ' + formatTime(dur); });
      on(els.seek, 'change', function(){ var dur = (player && player.getDuration && player.getDuration()) || 0; var pos = Number(els.seek.value) / 1000; var t = dur * pos; try { player && player.seekTo && player.seekTo(t, true); } catch(e){} userDragging = false; });

      on(els.fsToggle, 'click', function(){ var wrap = document.getElementById('playerWrap'); if (!document.fullscreenElement) { if (wrap && wrap.requestFullscreen) wrap.requestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen(); } });
      document.addEventListener('fullscreenchange', updateFsUI);

      on(els.qualityBtn, 'click', function(e){ e.stopPropagation(); if (!els.qualityMenu) return; if (els.qualityMenu.classList.contains('open')) els.qualityMenu.classList.remove('open'); else openQualityMenu(); });
      document.addEventListener('click', function(){ if (els.qualityMenu && els.qualityMenu.classList) els.qualityMenu.classList.remove('open'); });

      on(els.ccToggle, 'click', function(){ captionsOn = !captionsOn; updateCCToggleUI(); rebuildPlayerKeepTime(); });
      updateCCToggleUI();

      on(els.autoToggle, 'click', function(){ autoPlayOn = !autoPlayOn; updateAutoUI(); });
      updateAutoUI();

      on(els.copy, 'click', function(){
        try { navigator.clipboard.writeText((els.share && els.share.value) || '').then(function(){ if (els.copy) { els.copy.textContent = 'ë³µì‚¬ë¨!'; setTimeout(function(){ els.copy.textContent = 'ì£¼ì†Œ ë³µì‚¬'; }, 1500); } }); }
        catch(e) { try { els.share && els.share.select && els.share.select(); document.execCommand('copy'); if (els.copy) { els.copy.textContent = 'ë³µì‚¬ë¨!'; setTimeout(function(){ els.copy.textContent = 'ì£¼ì†Œ ë³µì‚¬'; }, 1500); } } catch(e2){} }
      });

      on(els.titlePaste, 'click', function(){
        try { navigator.clipboard.readText().then(function(txt){ if (els.titleInput) els.titleInput.value = txt; updateShareLink(currentVideoId || ''); }).catch(function(){ showError('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•´ ì£¼ì„¸ìš”.'); }); }
        catch(e){ showError('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•´ ì£¼ì„¸ìš”.'); }
      });
      on(els.titleClear, 'click', function(){ if (els.titleInput) els.titleInput.value = ''; updateShareLink(currentVideoId || ''); });
      on(els.titleInput, 'change', function(){ updateShareLink(currentVideoId || '')); });

      // Aâ€“B ë²„íŠ¼ & ë‹¨ì¶•í‚¤
      on(els.setA, 'click', setAHere);
      on(els.setB, 'click', setBHere);
      on(els.toggleAB, 'click', toggleABLoop);
      on(els.clearAB, 'click', clearAB);

      document.addEventListener('keydown', function(e){
        var tag = (document.activeElement && document.activeElement.tagName);
        if (tag === 'INPUT' || tag === 'TEXTAREA') return;
        var k = (e.key || '').toLowerCase();
        if (k === 'a') setAHere(); else if (k === 'b') setBHere(); else if (k === 'l') toggleABLoop(); else if (k === 'c') clearAB();
      });
    }

    // ====== YouTube API Ready ======
    window.onYouTubeIframeAPIReady = function() {
      // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬
      var params = new URLSearchParams(location.search);
      var vParam = params.get('v');
      var tParam = params.get('t');
      if (tParam && els.titleInput) els.titleInput.value = tParam;

      // Aâ€“B íŒŒë¼ë¯¸í„°
      var aParam = Number(params.get('a'));
      var bParam = Number(params.get('b'));
      if (!Number.isNaN(aParam) && !Number.isNaN(bParam) && bParam > aParam) {
        aPoint = aParam; bPoint = bParam; abEnabled = true; updateABUI();
      }

      // ê° íŒŒíŠ¸ í”„ë¦¬í•„
      partKeys.forEach(function(k){
        var id = params.get(k);
        if (id && /^[a-zA-Z0-9_-]{11}$/.test(id) && partEls[k] && partEls[k].input) {
          partEls[k].input.value = 'https://www.youtube.com/watch?v=' + id;
        }
      });

      // ì´ˆê¸° ë¡œë“œ: v ìˆìœ¼ë©´ ê·¸ê±°ë¶€í„°, ì—†ê³  pending ì´ ìˆìœ¼ë©´ ê·¸ê²ƒë¶€í„°
      var initialId = extractYouTubeId(vParam || '') || pendingVideoId;
      if (initialId) {
        pendingVideoId = null;
        loadVideo(initialId);
      } else {
        setOverlay(false); // ì•„ì§ ì¬ìƒ ì „
        updateShareLink(''); // ì…ë ¥ëœ ëª©ë¡ ê¸°ì¤€ ê³µìœ  ë§í¬ ê°±ì‹ 
      }
    };

    function createOrLoadPlayer(videoId, startAt) {
      startAt = startAt || 0;
      var isHttpOrigin = location.protocol === 'http:' || location.protocol === 'https:';
      var originParam = isHttpOrigin ? location.origin : undefined; // file:// í™˜ê²½ì´ë©´ ì„¤ì • ì•ˆ í•¨

      if (!window.YT || !YT.Player) {
        // API ì•„ì§ ì¤€ë¹„ ì•ˆ ë¨: íì— ì €ì¥
        pendingVideoId = videoId;
        showError('ìœ íŠœë¸Œ API ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ì¬ìƒë©ë‹ˆë‹¤.');
        return;
      }

      if (player) {
        try { player.loadVideoById({ videoId: videoId, startSeconds: startAt }); } catch(e){}
        applyLoopHack(videoId);
        if (autoPlayOn) try { player.playVideo(); } catch(e){}
        return;
      }

      player = new YT.Player('player', {
        host: 'https://www.youtube-nocookie.com',
        videoId: videoId,
        playerVars: {
          origin: originParam,
          autoplay: 0,
          controls: 0,
          modestbranding: 1,
          rel: 0,
          fs: 1,
          playsinline: 1,
          loop: 1,
          playlist: videoId,
          enablejsapi: 1,
          cc_load_policy: captionsOn ? 1 : 0
        },
        events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange, onError: onPlayerError }
      });

      setTimeout(function(){
        if (!player || typeof player.getPlayerState !== 'function') return;
        try {
          var iframe = player.getIframe && player.getIframe();
          var empty = iframe && iframe.src && iframe.src.indexOf('about:blank') !== -1;
          if (empty) showCookieHelp();
        } catch(e){}
      }, 2000);
    }

    function rebuildPlayerKeepTime() {
      if (!player || !currentVideoId) return;
      var t = Number((player.getCurrentTime && player.getCurrentTime()) || 0);
      try { player.destroy && player.destroy(); } catch(e){}
      player = null;
      createOrLoadPlayer(currentVideoId, t);
    }

    function onPlayerReady() {
      setupSeekTimer();
      setVolume((els.vol && els.vol.value) || 100);
      try {
        var iframe = player && player.getIframe && player.getIframe();
        if (iframe && iframe.setAttribute) {
          iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
          iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
        }
      } catch(e){}
      setOverlay(true); // ì¬ìƒ ì „ì—ëŠ” í‘œì‹œ (ì‚¬ìš©ìê°€ ì¬ìƒ)
      if (autoPlayOn) { try { player.playVideo(); } catch(e){} }
      updatePlayToggleUI();
      updateMuteUI();
      updateFsUI();
    }

    function onPlayerStateChange(e) {
      var YTS = (window.YT && YT.PlayerState) || {};
      if (e && e.data === YTS.ENDED) {
        try { player.seekTo(aPoint != null ? aPoint : 0, true); player.playVideo(); } catch(ex){}
      }
      if (e && (e.data === YTS.PLAYING || e.data === YTS.BUFFERING)) {
        setOverlay(false); hideCookieHelp();
      } else if (e && (e.data === YTS.PAUSED || e.data === YTS.CUED)) {
        setOverlay(true); hideCookieHelp();
      }
      updatePlayToggleUI();
    }

    function onPlayerError(e) {
      var code = e && e.data;
      if (code === 101 || code === 150) showError('ì´ ì˜ìƒì€ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì¬ìƒì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤. "ìœ íŠœë¸Œì—ì„œ ì—´ê¸°"ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
      else showError('ë™ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      showCookieHelp();
    }

    function setupSeekTimer() {
      clearInterval(seekTimer);
      seekTimer = setInterval(function(){
        if (!player || userDragging) return;
        var dur = (player.getDuration && player.getDuration()) || 0;
        var cur = (player.getCurrentTime && player.getCurrentTime()) || 0;

        // ì¬ìƒ ìƒíƒœ ê°ì‹œ
        try {
          var st = player.getPlayerState && player.getPlayerState();
          var YTS = (window.YT && YT.PlayerState) || {};
          if (st === YTS.PLAYING || st === YTS.BUFFERING) setOverlay(false);
          else if (st === YTS.PAUSED || st === YTS.CUED) setOverlay(true);
        } catch(ex){}

        // Aâ€“B ë£¨í”„
        if (abEnabled && aPoint != null && bPoint != null && bPoint > aPoint && dur > 0) {
          if (cur < aPoint - 0.08 || cur >= bPoint - 0.08) {
            try { player.seekTo(aPoint, true); player.playVideo(); } catch(e){}
          }
        }

        // UI ê°±ì‹ 
        if (els.timeLabel) els.timeLabel.textContent = formatTime(cur) + ' / ' + formatTime(dur);
        if (els.seek && dur > 0) { els.seek.value = Math.min(1000, Math.floor((cur / dur) * 1000)); }
        updateSeekABBG();
      }, 200);
    }

    function setVolume(v) { try { v = Math.max(0, Math.min(100, Number(v))); if (player && player.setVolume) player.setVolume(v); } catch(e){} }

    function applyLoopHack(videoId) { try { player && player.setLoop && player.setLoop(true); } catch(e){} try { player && player.cuePlaylist && player.cuePlaylist({ listType: 'playlist', playlist: [videoId] }); } catch(e){} }

    function setOverlay(show) {
      var items = [els.overlay, els.overlayCtrl];
      for (var i=0;i<items.length;i++){
        var el = items[i]; if (!el) continue;
        if (show) { el.hidden = false; (function(el){ requestAnimationFrame(function(){ if (el.classList) el.classList.remove('is-hidden'); }); })(el); }
        else { if (el.classList) el.classList.add('is-hidden'); }
      }
      if (els.overlay && els.overlay.setAttribute) els.overlay.setAttribute('aria-hidden', String(!show));
      if (els.overlayCtrl && els.overlayCtrl.setAttribute) els.overlayCtrl.setAttribute('aria-hidden', String(!show));
    }

    function showError(msg) { if (!els.err) return; els.err.textContent = msg || ''; if (msg) setTimeout(function(){ els.err.textContent = ''; }, 5000); }

    // ì…ë ¥ëœ ëª¨ë“  íŒŒíŠ¸ â†’ {key: id}
    function collectPartIds() {
      var map = {};
      partKeys.forEach(function(k){
        var val = (partEls[k] && partEls[k].input && partEls[k].input.value && partEls[k].input.value.trim()) || '';
        var id = extractYouTubeId(val);
        if (id) map[k] = id;
      });
      return map;
    }

    function updateShareLink(currentId) {
      var url; try { url = new URL(location.href); } catch(e){ return; }
      url.search = '';
      var map = collectPartIds();
      if (currentId) url.searchParams.set('v', currentId);
      var title = els.titleInput && els.titleInput.value && els.titleInput.value.trim();
      if (title) url.searchParams.set('t', title);
      Object.keys(map).forEach(function(k){ url.searchParams.set(k, map[k]); });
      if (abEnabled && aPoint != null && bPoint != null && bPoint > aPoint) {
        url.searchParams.set('a', Math.floor(aPoint));
        url.searchParams.set('b', Math.floor(bPoint));
      }
      if (els.share) els.share.value = url.toString();
      try { history.replaceState({}, '', url.toString()); } catch(e){}
      if (currentId && els.openYT) els.openYT.onclick = function(){ window.open('https://www.youtube.com/watch?v=' + currentId, '_blank', 'noopener'); };
    }

    function showCookieHelp() { if (els.cookieHelp) els.cookieHelp.hidden = false; if (els.openYT) els.openYT.hidden = false; }
    function hideCookieHelp() { if (els.cookieHelp) els.cookieHelp.hidden = true; if (els.openYT) els.openYT.hidden = true; }

    function loadVideo(videoId) {
      currentVideoId = videoId;
      // YT ì¤€ë¹„ ì „ì´ë©´ íì— ì ì¬í•˜ê³  UI/ê³µìœ ë§í¬ë§Œ ê°±ì‹ 
      if (!window.YT || !YT.Player) { pendingVideoId = videoId; updateShareLink(videoId); setOverlay(true); showError('ìœ íŠœë¸Œ API ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì¤€ë¹„ë˜ë©´ ìë™ìœ¼ë¡œ ì¬ìƒí•©ë‹ˆë‹¤.'); return; }
      createOrLoadPlayer(videoId, aPoint || 0);
      updateShareLink(videoId);
      setOverlay(true);
      showError('');
    }

    // ====== Aâ€“B ê´€ë ¨ ======
    function updateABUI() {
      var aTxt = (aPoint == null) ? 'â€”' : formatTime(aPoint);
      var bTxt = (bPoint == null) ? 'â€”' : formatTime(bPoint);
      var aVal = els.tagA && els.tagA.querySelector && els.tagA.querySelector('.val'); if (aVal) aVal.textContent = aTxt;
      var bVal = els.tagB && els.tagB.querySelector && els.tagB.querySelector('.val'); if (bVal) bVal.textContent = bTxt;
      if (els.tagA && els.tagA.classList) els.tagA.classList.toggle('off', aPoint == null);
      if (els.tagB && els.tagB.classList) els.tagB.classList.toggle('off', bPoint == null);
      if (els.toggleAB) els.toggleAB.textContent = 'Aâ€“B ë°˜ë³µ: ' + (abEnabled ? 'ON' : 'OFF');
      updateSeekABBG();
      updateShareLink(currentVideoId || '');
    }

    function updateSeekABBG() {
      var dur = (player && player.getDuration && player.getDuration()) || 0;
      if (els.seek && dur > 0 && aPoint != null && bPoint != null && bPoint > aPoint) {
        var aPct = Math.max(0, Math.min(100, (aPoint / dur) * 100));
        var bPct = Math.max(0, Math.min(100, (bPoint / dur) * 100));
        var bg = 'linear-gradient(to right, #374151 0%, #374151 ' + aPct + '%, #2563eb ' + aPct + '%, #2563eb ' + bPct + '%, #374151 ' + bPct + '%, #374151 100%)';
        els.seek.style.backgroundImage = bg;
      } else if (els.seek) {
        els.seek.style.backgroundImage = '';
      }
    }

    function setAHere() {
      try { aPoint = Math.max(0, (player && player.getCurrentTime && player.getCurrentTime()) || 0); } catch(e){ aPoint = 0; }
      if (bPoint != null && bPoint <= aPoint) { bPoint = null; }
      updateABUI();
      if (abEnabled) { try { player && player.seekTo && player.seekTo(aPoint, true); } catch(e){} }
    }

    function setBHere() {
      var dur = (player && player.getDuration && player.getDuration()) || 0;
      try { bPoint = Math.min(dur || Infinity, (player && player.getCurrentTime && player.getCurrentTime()) || 0); } catch(e){ bPoint = null; }
      if (aPoint == null) { showError('ë¨¼ì € A ì§€ì ì„ ì„¤ì •í•´ ì£¼ì„¸ìš”.'); return; }
      if (bPoint != null && bPoint <= aPoint) { showError('BëŠ” Aë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.'); bPoint = null; }
      updateABUI();
    }

    function toggleABLoop() {
      if (!abEnabled) {
        if (aPoint == null || bPoint == null || bPoint <= aPoint) { showError('Aì™€ Bë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •í•´ ì£¼ì„¸ìš”.'); return; }
        abEnabled = true;
        try { player && player.seekTo && player.seekTo(aPoint, true); player && player.playVideo && player.playVideo(); } catch(e){}
      } else {
        abEnabled = false;
      }
      updateABUI();
    }

    function clearAB() { aPoint = null; bPoint = null; abEnabled = false; updateABUI(); }

    function updatePlayToggleUI() {
      try {
        var st = player && player.getPlayerState && player.getPlayerState();
        var YTS = (window.YT && YT.PlayerState) || {};
        var playing = (st === YTS.PLAYING || st === YTS.BUFFERING);
        if (els.playToggle) els.playToggle.textContent = playing ? 'â¸ ì¼ì‹œì •ì§€' : 'â–¶ ì¬ìƒ';
      } catch(e) { if (els.playToggle) els.playToggle.textContent = 'â–¶ ì¬ìƒ'; }
    }

    function updateMuteUI() { try { if (els.muteToggle) els.muteToggle.textContent = (player && player.isMuted && player.isMuted()) ? 'ğŸ”‡' : 'ğŸ”Š'; } catch(e){} }

    function updateFsUI() {
      var fs = !!document.fullscreenElement;
      if (els.fsToggle) els.fsToggle.textContent = fs ? 'â›¶ ì¢…ë£Œ' : 'â›¶ ì „ì²´í™”ë©´';
    }

    // í™”ì§ˆ ë©”ë‰´
    function mapQualityLabel(q) {
      var m = { small: '240p', medium:'360p', large:'480p', hd720:'720p', hd1080:'1080p', hd1440:'1440p', hd2160:'2160p', highres:'ê³ í•´ìƒë„' };
      return m[q] || q;
    }
    function openQualityMenu() {
      try {
        var levels = (player && player.getAvailableQualityLevels && player.getAvailableQualityLevels()) || [];
        if (!els.qualityMenu) return;
        els.qualityMenu.innerHTML = '';
        var opts = ['default'].concat(levels);
        opts.forEach(function(q){
          var btn = document.createElement('button');
          btn.textContent = (q === 'default') ? 'ìë™' : mapQualityLabel(q);
          btn.addEventListener('click', function(){ try { player && player.setPlaybackQuality && player.setPlaybackQuality(q); } catch(e){} els.qualityMenu.classList.remove('open'); });
          els.qualityMenu.appendChild(btn);
        });
        els.qualityMenu.classList.add('open');
      } catch(e) { /* ë¬´ì‹œ */ }
    }

    // ====== ìì²´ í…ŒìŠ¤íŠ¸ ======
    (function runSelfTests(){
      var tests = [];
      function ok(name, cond){ try { if(!cond){ tests.push(name); console.error('âŒ', name); } else { console.log('âœ…', name); } } catch (err) { tests.push(name + ' (threw)'); console.error('âŒ', name, err); } }
      // ê¸°ì¡´ í…ŒìŠ¤íŠ¸ (ë³€ê²½ ê¸ˆì§€)
      ok('extract watch', extractYouTubeId('https://www.youtube.com/watch?v=dQw4w9WgXcQ') === 'dQw4w9WgXcQ');
      ok('extract youtu.be', extractYouTubeId('https://youtu.be/dQw4w9WgXcQ') === 'dQw4w9WgXcQ');
      ok('extract embed', extractYouTubeId('https://www.youtube.com/embed/dQw4w9WgXcQ') === 'dQw4w9WgXcQ');
      ok('overlay fade show/hide', (function(){ setOverlay(false); var h1 = (!!els.overlay && els.overlay.classList && els.overlay.classList.contains('is-hidden')) && (!!els.overlayCtrl && els.overlayCtrl.classList && els.overlayCtrl.classList.contains('is-hidden')); setOverlay(true); var h2 = (!els.overlay || !els.overlay.classList || !els.overlay.classList.contains('is-hidden')) && (!els.overlayCtrl || !els.overlayCtrl.classList || !els.overlayCtrl.classList.contains('is-hidden')); return h1 && h2; })());
      
      // ì¶”ê°€ í…ŒìŠ¤íŠ¸: URL ë³€í˜•/ì‹œê°„ í¬ë§·
      ok('extract shorts', extractYouTubeId('https://www.youtube.com/shorts/dQw4w9WgXcQ') === 'dQw4w9WgXcQ');
      ok('extract raw id', extractYouTubeId('dQw4w9WgXcQ') === 'dQw4w9WgXcQ');
      ok('extract invalid', extractYouTubeId('https://example.com') === null);
      ok('format 0', formatTime(0) === '0:00');
      ok('format 65', formatTime(65) === '1:05');

      // ì¶”ê°€ í…ŒìŠ¤íŠ¸: YT ë¯¸ì¤€ë¹„ ì‹œ loadVideoê°€ íì‰ë˜ëŠ”ì§€
      (function(){ var bak = window.YT; try { window.YT = undefined; pendingVideoId = null; loadVideo('dQw4w9WgXcQ'); ok('loadVideo queues when YT not ready', pendingVideoId === 'dQw4w9WgXcQ'); } finally { window.YT = bak; pendingVideoId = null; } })();

      // ì¶”ê°€ í…ŒìŠ¤íŠ¸: setOverlay ìš”ì†Œ ë¯¸ì¡´ì¬ í—ˆìš©
      (function(){ var bk1 = els.overlay, bk2 = els.overlayCtrl; try { els.overlay = null; els.overlayCtrl = null; ok('setOverlay tolerates missing elements', (function(){ try { setOverlay(true); setOverlay(false); return true; } catch(e){ return false; } })()); } finally { els.overlay = bk1; els.overlayCtrl = bk2; } })();

      if(tests.length){ console.warn('FAILED TESTS:', tests); }
    })();
  </script>
</body>
</html>
